<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片合成编辑器 - 交互升级版</title>
    <style>
        :root {
            --primary: #4b6cb7;
            --bg: #f5f7fa;
            --sidebar-w: 260px; /* 加宽侧边栏 */
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        
        body {
            background: var(--bg);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* === 左侧控制面板 === */
        .sidebar {
            width: var(--sidebar-w);
            background: white;
            border-right: 1px solid #ddd;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 20; /* 提高层级，保证在预览图之上 */
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }

        .control-group {
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        .label { font-size: 14px; font-weight: bold; color: #333; margin-bottom: 8px; display: block; }
        
        .btn {
            width: 100%; padding: 10px; border: none; border-radius: 6px;
            cursor: pointer; font-weight: bold; transition: 0.2s; margin-bottom: 5px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        
        /* 滑块样式 */
        .slider-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .slider-label { width: 40px; color: #666; }
        .slider-val { width: 40px; text-align: right; color: var(--primary); font-weight: bold; }
        input[type="range"] { flex: 1; cursor: pointer; margin: 0 5px; }

        /* 模式切换 */
        .mode-switch { display: flex; background: #eee; border-radius: 4px; padding: 2px; }
        .mode-switch button {
            flex: 1; border: none; background: none; padding: 6px;
            font-size: 12px; cursor: pointer; border-radius: 4px;
        }
        .mode-switch button.active { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); color: var(--primary); font-weight: bold;}

        /* === 右侧主区域 === */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative; /* 关键：作为预览层的定位父级 */
            background: #f0f2f5;
        }

        .preview-header {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 5;
        }

        .workspace {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 图片列表网格 */
        .img-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 1000px;
        }

        .img-card {
            background: white;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.2s;
        }
        .img-card.selected { border-color: var(--primary); background: #eef4ff; box-shadow: 0 0 0 2px rgba(75, 108, 183, 0.3); }
        .img-thumb-box {
            height: 120px; background: #eee; border-radius: 4px;
            overflow: hidden; display: flex; align-items: center; justify-content: center;
        }
        .img-thumb-box img { max-width: 100%; max-height: 100%; object-fit: contain; pointer-events: none;}
        .img-info { margin-top: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 12px; }
        .del-btn { color: #999; cursor: pointer; font-size: 16px; }
        .del-btn:hover { color: red; }

        /* === 预览覆盖层 (修改为绝对定位覆盖MainArea) === */
        .preview-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #2c3e50; /* 深色背景以便看清边界 */
            z-index: 10; /* 高于列表，但低于 Sidebar(20) */
            display: none;
            overflow: hidden; /* 内部 canvas 自己动 */
            cursor: grab;
        }
        .preview-overlay.active { display: flex; align-items: center; justify-content: center; }
        
        .canvas-wrapper {
            transform-origin: center center;
            transition: transform 0.1s ease-out; /* 平滑缩放 */
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        canvas { display: block; }

        /* 提示条 */
        .overlay-tips {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.6); color: white;
            padding: 5px 15px; border-radius: 20px; font-size: 12px;
            pointer-events: none;
            z-index: 15;
        }
        .close-preview-btn {
            position: absolute; top: 10px; right: 20px;
            background: rgba(0,0,0,0.5); color: white; border: none;
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
            font-size: 20px; z-index: 15;
        }
        .close-preview-btn:hover { background: red; }

    </style>
</head>
<body>

    <!-- 左侧控制栏 (z-index: 20) -->
    <div class="sidebar">
        <h2 style="font-size: 18px; color: #333; margin-bottom: 10px;">图片合成</h2>
        
        <input type="file" id="fileInput" multiple accept="image/*" style="display:none">
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">+ 添加图片</button>
        
        <div class="control-group">
            <span class="label">裁剪模式</span>
            <div class="mode-switch">
                <button class="active" data-mode="single" onclick="setMode('single')">选中微调</button>
                <button data-mode="global" onclick="setMode('global')">全局统一</button>
            </div>
            <div style="margin-top: 8px; font-size: 12px; color: #666; min-height: 16px;" id="selectedInfo">请添加并选中图片</div>
        </div>

        <div class="control-group">
            <span class="label">裁剪 (0-300px)</span>
            
            <div class="slider-row">
                <span class="slider-label">上</span>
                <input type="range" min="0" max="300" value="0" id="cropTop" oninput="handleCropInput('top', this.value)">
                <span class="slider-val" id="valTop">0</span>
            </div>
            <div class="slider-row">
                <span class="slider-label">下</span>
                <input type="range" min="0" max="300" value="0" id="cropBottom" oninput="handleCropInput('bottom', this.value)">
                <span class="slider-val" id="valBottom">0</span>
            </div>
            <div class="slider-row">
                <span class="slider-label">左</span>
                <input type="range" min="0" max="300" value="0" id="cropLeft" oninput="handleCropInput('left', this.value)">
                <span class="slider-val" id="valLeft">0</span>
            </div>
            <div class="slider-row">
                <span class="slider-label">右</span>
                <input type="range" min="0" max="300" value="0" id="cropRight" oninput="handleCropInput('right', this.value)">
                <span class="slider-val" id="valRight">0</span>
            </div>
        </div>

        <div class="control-group">
            <span class="label">间距设置</span>
            <input type="range" style="width:100%" min="0" max="100" value="0" id="spacingSlider" oninput="updateSpacing(this.value)">
            <div style="display:flex; justify-content:space-between; margin-top:5px;">
                <span style="font-size:12px" id="spacingVal">0px</span>
                <input type="color" value="#ffffff" style="height:20px; width:40px; border:none;" id="spacingColor" oninput="if(isPreviewMode) renderPreview()">
            </div>
        </div>

        <button class="btn btn-success" onclick="togglePreview()">预览合成效果</button>
        <button class="btn btn-danger" onclick="clearAll()">清空所有</button>
        
        <div style="margin-top: auto; padding-top:10px; border-top:1px solid #eee;">
             <button class="btn btn-primary" onclick="downloadImage()">下载长图</button>
        </div>
    </div>

    <!-- 右侧主区域 -->
    <div class="main-area">
        <div class="preview-header">
            <h4>工作区</h4>
            <span style="font-size: 12px; color: #666;">共 <span id="imgCount">0</span> 张</span>
        </div>
        
        <!-- 图片列表 -->
        <div class="workspace" id="imgList">
            <div style="color:#999; margin-top: 50px;">请从左侧添加图片</div>
        </div>

        <!-- 预览覆盖层 (z-index: 10) -->
        <div class="preview-overlay" id="previewOverlay">
            <div class="overlay-tips">滚轮缩放 • 拖拽移动 • 点击背景退出</div>
            <button class="close-preview-btn" onclick="closePreview()">&times;</button>
            <div class="canvas-wrapper" id="canvasWrapper">
                <canvas id="previewCanvas"></canvas>
            </div>
        </div>
    </div>

    <script>
        // --- 全局状态 ---
        let images = []; 
        let globalCrop = { top: 0, bottom: 0, left: 0, right: 0 };
        let currentMode = 'single'; 
        let selectedIndex = -1;
        let spacing = 0;
        let isPreviewMode = false;

        // 预览视图状态
        let viewState = { scale: 0.8, x: 0, y: 0, isDragging: false, startX: 0, startY: 0 };

        const fileInput = document.getElementById('fileInput');
        const imgListDom = document.getElementById('imgList');
        const previewOverlay = document.getElementById('previewOverlay');
        const canvasWrapper = document.getElementById('canvasWrapper');
        const previewCanvas = document.getElementById('previewCanvas');

        // --- 事件监听 ---
        fileInput.addEventListener('change', async (e) => {
            if (e.target.files.length === 0) return;
            const newFiles = Array.from(e.target.files);
            const loadPromises = newFiles.map(file => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = URL.createObjectURL(file);
                    img.onload = () => {
                        resolve({
                            imgObj: img,
                            name: file.name,
                            id: Date.now() + Math.random(),
                            crop: { top: 0, bottom: 0, left: 0, right: 0 }
                        });
                    };
                });
            });
            const newImages = await Promise.all(loadPromises);
            images = [...images, ...newImages];
            renderList();
            // 默认选中第一张
            if (images.length > 0 && selectedIndex === -1) selectImage(0);
            // 如果正在预览，刷新预览
            if (isPreviewMode) renderPreview();
            fileInput.value = '';
        });

        // --- 渲染列表 ---
        function renderList() {
            document.getElementById('imgCount').textContent = images.length;
            if (images.length === 0) {
                imgListDom.innerHTML = '<div style="color:#999; margin-top: 50px;">请添加图片</div>';
                return;
            }

            imgListDom.innerHTML = '';
            const grid = document.createElement('div');
            grid.className = 'img-grid';

            images.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = `img-card ${index === selectedIndex ? 'selected' : ''}`;
                card.draggable = true;
                
                // 拖拽排序逻辑
                card.ondragstart = (e) => { e.dataTransfer.setData('idx', index); card.style.opacity = '0.5'; };
                card.ondragend = () => { card.style.opacity = '1'; };
                card.ondragover = (e) => e.preventDefault();
                card.ondrop = (e) => {
                    e.preventDefault();
                    const fromIdx = parseInt(e.dataTransfer.getData('idx'));
                    moveImage(fromIdx, index);
                };

                // 点击选中
                card.onclick = (e) => {
                    if (e.target.className.includes('del-btn')) return;
                    selectImage(index);
                };

                card.innerHTML = `
                    <div class="img-thumb-box">
                        <img src="${item.imgObj.src}">
                    </div>
                    <div class="img-info">
                        <span>${index + 1}. ${item.name.slice(0, 6)}...</span>
                        <span class="del-btn" onclick="removeImage(${index})">&times;</span>
                    </div>
                `;
                grid.appendChild(card);
            });
            imgListDom.appendChild(grid);
        }

        // --- 逻辑控制 ---
        function selectImage(index) {
            selectedIndex = index;
            renderList(); 
            if (currentMode === 'single') {
                updateInputs(images[index].crop);
                document.getElementById('selectedInfo').textContent = `当前调整: ${images[index].name}`;
            }
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-switch button').forEach(b => {
                b.classList.toggle('active', b.dataset.mode === mode);
            });

            if (mode === 'global') {
                updateInputs(globalCrop);
                document.getElementById('selectedInfo').textContent = "模式: 全局统一调整 (所有图片生效)";
                selectedIndex = -1;
                renderList();
            } else {
                if (images.length > 0) selectImage(0);
                else document.getElementById('selectedInfo').textContent = "请添加并选中图片";
            }
        }

        function updateInputs(cropObj) {
            ['Top','Bottom','Left','Right'].forEach(side => {
                const key = side.toLowerCase();
                const val = cropObj[key];
                document.getElementById('crop'+side).value = val;
                document.getElementById('val'+side).textContent = val;
            });
        }

        function handleCropInput(side, value) {
            const val = parseInt(value) || 0;
            document.getElementById('val'+side.charAt(0).toUpperCase() + side.slice(1)).textContent = val;

            if (currentMode === 'global') {
                globalCrop[side] = val;
            } else {
                if (selectedIndex === -1) return;
                images[selectedIndex].crop[side] = val;
            }
            
            // 关键：如果预览层打开，实时重绘
            if (isPreviewMode) {
                requestAnimationFrame(renderPreview);
            }
        }

        function updateSpacing(val) {
            spacing = parseInt(val);
            document.getElementById('spacingVal').textContent = val + 'px';
            if (isPreviewMode) requestAnimationFrame(renderPreview);
        }

        function moveImage(from, to) {
            const item = images.splice(from, 1)[0];
            images.splice(to, 0, item);
            if (selectedIndex === from) selectedIndex = to;
            renderList();
            if (isPreviewMode) renderPreview();
        }

        function removeImage(index) {
            images.splice(index, 1);
            if (selectedIndex === index) selectedIndex = -1;
            renderList();
            if (isPreviewMode) renderPreview();
        }

        function clearAll() {
            images = [];
            globalCrop = { top: 0, bottom: 0, left: 0, right: 0 };
            updateInputs(globalCrop);
            renderList();
            closePreview();
        }

        // --- 预览功能 (核心升级) ---
        
        function togglePreview() {
            if (!isPreviewMode) {
                if(images.length === 0) return alert('请先添加图片');
                isPreviewMode = true;
                previewOverlay.classList.add('active');
                // 重置视图位置
                viewState.scale = 0.6; // 默认稍微缩小一点能看全貌
                viewState.x = 0;
                viewState.y = 0;
                applyTransform();
                renderPreview();
            } else {
                closePreview();
            }
        }

        function closePreview() {
            isPreviewMode = false;
            previewOverlay.classList.remove('active');
        }

        // 点击背景关闭 (利用冒泡，如果点到 canvasWrapper 不关，点 overlay 关)
        previewOverlay.addEventListener('mousedown', (e) => {
            if (e.target === previewOverlay) {
                closePreview();
            }
        });

        // --- 画布绘制 (生成结果) ---
        function renderPreview() {
            if(images.length === 0) return;
            
            // 1. 计算统一宽度和总高度
            let maxWidth = 0;
            const renderData = images.map(img => {
                const c = img.crop;
                // 实际裁剪 = 单图裁剪 + 全局裁剪
                const t = c.top + globalCrop.top;
                const b = c.bottom + globalCrop.bottom;
                const l = c.left + globalCrop.left;
                const r = c.right + globalCrop.right;

                // 确保不会裁成负数
                const sw = Math.max(1, img.imgObj.width - l - r);
                const sh = Math.max(1, img.imgObj.height - t - b);
                
                if (sw > maxWidth) maxWidth = sw;

                return { ...img, sw, sh, sx: l, sy: t };
            });

            let totalHeight = 0;
            renderData.forEach(d => {
                d.renderScale = maxWidth / d.sw; // 统一宽度后的缩放比
                d.renderHeight = d.sh * d.renderScale;
                totalHeight += d.renderHeight;
            });
            
            totalHeight += (renderData.length - 1) * spacing;

            // 2. 设置 Canvas
            previewCanvas.width = maxWidth;
            previewCanvas.height = totalHeight;
            const ctx = previewCanvas.getContext('2d');

            // 填充背景
            if (spacing > 0) {
                ctx.fillStyle = document.getElementById('spacingColor').value;
                ctx.fillRect(0, 0, maxWidth, totalHeight);
            }

            // 3. 绘制
            let currentY = 0;
            renderData.forEach((d, i) => {
                ctx.drawImage(
                    d.imgObj,
                    d.sx, d.sy, d.sw, d.sh, // 源裁剪
                    0, currentY, maxWidth, d.renderHeight // 目标绘制
                );
                currentY += d.renderHeight + spacing;
            });
        }

        // --- 预览交互 (缩放/移动) ---
        
        // 应用变换
        function applyTransform() {
            canvasWrapper.style.transform = `translate(${viewState.x}px, ${viewState.y}px) scale(${viewState.scale})`;
        }

        // 滚轮缩放
        previewOverlay.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            viewState.scale *= delta;
            // 限制缩放范围
            viewState.scale = Math.max(0.1, Math.min(viewState.scale, 5));
            applyTransform();
        });

        // 鼠标拖拽
        previewOverlay.addEventListener('mousedown', (e) => {
            // 允许在 overlay 或 canvas 上拖拽
            viewState.isDragging = true;
            viewState.startX = e.clientX - viewState.x;
            viewState.startY = e.clientY - viewState.y;
            previewOverlay.style.cursor = 'grabbing';
        });

        window.addEventListener('mousemove', (e) => {
            if (!viewState.isDragging) return;
            e.preventDefault();
            viewState.x = e.clientX - viewState.startX;
            viewState.y = e.clientY - viewState.startY;
            applyTransform();
        });

        window.addEventListener('mouseup', () => {
            viewState.isDragging = false;
            previewOverlay.style.cursor = 'grab';
        });

        // --- 下载 ---
        function downloadImage() {
            if(images.length === 0) return alert("无图片");
            // 如果不在预览模式，先渲染一次确保数据最新
            if (!isPreviewMode) renderPreview();
            
            const link = document.createElement('a');
            link.download = `result_${Date.now()}.jpg`;
            link.href = previewCanvas.toDataURL('image/jpeg', 0.9);
            link.click();
        }

    </script>
</body>
</html>
