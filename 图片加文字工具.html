<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡æ–‡å­—æ·»åŠ å·¥å…·</title>
    <style>
        /* ä¿æŒåŸæœ‰æ ·å¼ä¸å˜ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin: 0 auto;
            margin-left: 200px;
        }
        
        .main-content {
            display: flex;
            padding: 20px;
            gap: 20px;
            min-height: 800px;
            height: calc(100vh - 160px);
        }
        
        .controls {
            flex: 1;
            min-width: 300px;
            max-width: 600px;
            padding: 15px;
            overflow-y: auto;
            height: 100%;
        }
        
        .preview {
            flex: 0 0 400px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            height: 100%;
        }
        
        .preview-content {
            position: sticky;
            top: 0;
        }
        
        .control-group {
            margin-bottom: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        h2 {
            color: #182848;
            margin-bottom: 8px;
            font-size: 1.1rem;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 6px;
        }
        
        label {
            display: block;
            margin-bottom: 4px;
            color: #333;
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-bottom: 6px;
            transition: all 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4b6cb7;
            box-shadow: 0 0 0 2px rgba(75, 108, 183, 0.2);
        }
        
        textarea {
            height: 80px;
            resize: vertical;
        }
        
        .color-picker {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .color-picker input {
            width: 40px;
            height: 30px;
            padding: 0;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
        }
        
        .slider-container input[type="range"] {
            flex: 1;
            height: 20px;
            padding: 0;
            margin: 0;
            -webkit-appearance: none;
            background: transparent;
            cursor: pointer;
        }
        
        .slider-container input[type="range"]::-webkit-slider-track {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            border: none;
        }
        
        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #4b6cb7;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .slider-container input[type="range"]::-moz-range-track {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            border: none;
        }
        
        .slider-container input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #4b6cb7;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .slider-value {
            width: 45px;
            text-align: center;
            font-weight: bold;
            font-size: 0.8rem;
            color: #495057;
            background: #f8f9fa;
            padding: 4px 6px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        
        button {
            padding: 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        /* å·¦ä¾§å›ºå®šä¾§è¾¹æ  */
        .sidebar {
            position: fixed;
            left: 20px;
            top: 20px;
            width: 180px;
            background: linear-gradient(to bottom, #4b6cb7, #182848);
            display: flex;
            flex-direction: column;
            align-items: stretch;
            padding: 20px 0;
            z-index: 2000;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            border-radius: 10px;
        }
        
        .sidebar-btn {
            padding: 12px 15px;
            margin: 0 10px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .sidebar-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .sidebar-btn.active {
            background: rgba(255, 255, 255, 0.25);
        }
        
        .sidebar-btn i {
            margin-right: 10px;
            font-size: 18px;
            width: 20px;
            text-align: center;
        }
        
        /* ä¾§è¾¹æ é¢æ¿ */
        .sidebar-panel {
            width: 100%;
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            padding: 15px;
            border-radius: 0 0 8px 8px;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.3s ease;
            margin-top: -10px;
            margin-bottom: 10px;
        }
        
        .sidebar-panel.active {
            max-height: 500px;
            opacity: 1;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .panel-title {
            font-size: 1.2rem;
            color: #182848;
            font-weight: 600;
        }
        
        .close-panel {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }
        
        .download-btn {
            background: linear-gradient(to right, #00b09b, #96c93d);
            color: white;
            padding: 12px 15px;
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            margin: 10px;
            margin-top: auto;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
        }
        
        .preview-container {
            width: 100%;
            max-width: 400px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
            cursor: move;
            background: white;
        }
        
        canvas {
            display: block;
            max-width: 100%;
            background-color: #f9f9f9;
        }
        
        .preview-placeholder {
            width: 100%;
            height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: #6c757d;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .preview-placeholder i {
            font-size: 36px;
            margin-bottom: 10px;
            color: #adb5bd;
        }
        
        .color-settings {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .color-setting {
            flex: 1;
        }
        
        .tips {
            margin-top: 15px;
            font-size: 0.8rem;
            color: #6c757d;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            width: 100%;
            max-width: 400px;
            border-left: 4px solid #4b6cb7;
        }
        
        .tips ul {
            margin-left: 16px;
            margin-top: 6px;
        }
        
        .tips li {
            margin-bottom: 4px;
            line-height: 1.3;
        }
        
        .drag-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            display: none;
            z-index: 10;
        }
        
        /* ä¿®æ”¹ï¼šå­—ä½“å¤§å°æ§åˆ¶æ”¹ä¸ºå‚ç›´æ’åˆ— */
        .font-size-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .font-size-control {
            width: 100%;
        }
        
        .extension-settings {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        
        .extension-setting {
            flex: 1;
        }
        
        .text-align-group {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .align-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .align-btn.active {
            background: #4b6cb7;
            color: white;
            border-color: #4b6cb7;
        }
        
        .align-btn:hover {
            background: #e9ecef;
        }
        
        .align-btn.active:hover {
            background: #3a5a9e;
        }
        
        .bg-gradient-preview {
            width: 100%;
            height: 30px;
            border-radius: 4px;
            margin-top: 6px;
            border: 1px solid #ddd;
        }
        
        .apply-extension-btn {
            background: #4b6cb7;
            color: white;
            width: 100%;
            margin-top: 10px;
        }
        
        .apply-extension-btn:hover {
            background: #3a5a9e;
        }
        
        /* æ–°å¢ï¼šåº”ç”¨æ–‡å­—æŒ‰é’®æ ·å¼ */
        .apply-text-btn {
            background: #4b6cb7;
            color: white;
            width: 100%;
            margin-top: 10px;
        }
        
        .apply-text-btn:hover {
            background: #3a5a9e;
        }
        
        .applied-texts-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
        }
        
        .applied-text-item {
            padding: 8px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #4b6cb7;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .delete-text-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        
        .delete-text-btn:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <!-- å·¦ä¾§å›ºå®šä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-btn" id="uploadBtn">
            <i>ğŸ“</i>
            <span>ä¸Šä¼ å›¾ç‰‡</span>
        </div>
        
        <!-- æ‰©å±•ç”»å¸ƒæŒ‰é’®å’Œé¢æ¿ -->
        <div class="sidebar-btn" id="extensionBtn">
            <i>ğŸ“</i>
            <span>æ‰©å±•ç”»å¸ƒ</span>
        </div>
        <div class="sidebar-panel" id="extensionPanel">
            <div class="panel-header">
                <div class="panel-title">æ‰©å±•ç”»å¸ƒ</div>
                <button class="close-panel">&times;</button>
            </div>
            <div class="control-group">
                <label for="canvasExtension">æ‰©å±•ç”»å¸ƒé«˜åº¦</label>
                <div class="slider-container">
                    <input type="range" id="canvasExtension" min="0" max="500" value="0">
                    <span class="slider-value" id="canvasExtensionValue">0px</span>
                </div>
                
                <div class="extension-settings">
                    <div class="extension-setting">
                        <label for="extensionPosition">æ‰©å±•ä½ç½®</label>
                        <select id="extensionPosition">
                            <option value="top">ä¸Š</option>
                            <option value="bottom">ä¸‹</option>
                        </select>
                    </div>
                    <div class="extension-setting">
                        <label for="bgType">èƒŒæ™¯ç±»å‹</label>
                        <select id="bgType">
                            <option value="color">çº¯è‰²</option>
                            <option value="gradient">æ¸å˜</option>
                        </select>
                    </div>
                </div>
                
                <div id="bgColorSection">
                    <label for="canvasBgColor">èƒŒæ™¯é¢œè‰²</label>
                    <div class="color-picker">
                        <input type="color" id="canvasBgColor" value="#ffffff">
                        <span id="canvasBgColorValue">#FFFFFF</span>
                    </div>
                </div>
                
                <div id="bgGradientSection" style="display: none;">
                    <label for="gradientColor1">æ¸å˜é¢œè‰² 1</label>
                    <div class="color-picker">
                        <input type="color" id="gradientColor1" value="#4b6cb7">
                        <span id="gradientColor1Value">#4B6CB7</span>
                    </div>
                    
                    <label for="gradientColor2">æ¸å˜é¢œè‰² 2</label>
                    <div class="color-picker">
                        <input type="color" id="gradientColor2" value="#182848">
                        <span id="gradientColor2Value">#182848</span>
                    </div>
                    
                    <div class="bg-gradient-preview" id="gradientPreview"></div>
                </div>
                
                <button class="apply-extension-btn" id="applyExtension">åº”ç”¨æ‰©å±•</button>
            </div>
        </div>

        <!-- æ–‡å­—æ ·å¼æŒ‰é’®å’Œé¢æ¿ -->
        <div class="sidebar-btn" id="textStyleBtn">
            <i>âœï¸</i>
            <span>æ–‡å­—æ ·å¼</span>
        </div>
        <div class="sidebar-panel" id="textStylePanel">
            <div class="panel-header">
                <div class="panel-title">æ–‡å­—æ ·å¼</div>
                <button class="close-panel">&times;</button>
            </div>
            <div class="control-group">
                <label for="fontFamily">å­—ä½“</label>
                <select id="fontFamily">
                    <option value="Arial, sans-serif">Arial</option>
                    <option value="'Microsoft YaHei', sans-serif" selected>å¾®è½¯é›…é»‘</option>
                    <option value="'SimHei', sans-serif">é»‘ä½“</option>
                    <option value="'SimSun', serif">å®‹ä½“</option>
                    <option value="'KaiTi', serif">æ¥·ä½“</option>
                    <option value="'Times New Roman', serif">Times New Roman</option>
                </select>
                
                <label style="margin-top: 8px;">æ–‡å­—å¯¹é½</label>
                <div class="text-align-group">
                    <button class="align-btn active" data-align="left">å·¦</button>
                    <button class="align-btn" data-align="center">å±…</button>
                    <button class="align-btn" data-align="right">å³</button>
                </div>
                
                <!-- ä¿®æ”¹ï¼šå­—ä½“å¤§å°æ§åˆ¶æ”¹ä¸ºå‚ç›´æ’åˆ— -->
                <div class="font-size-controls">
                    <div class="font-size-control">
                        <label for="fontSize">åŸºç¡€å­—ä½“å¤§å°</label>
                        <div class="slider-container">
                            <input type="range" id="fontSize" min="12" max="72" value="24">
                            <span class="slider-value" id="fontSizeValue">24px</span>
                        </div>
                    </div>
                    <div class="font-size-control">
                        <label for="selectedFontSize">é€‰ä¸­æ–‡å­—å¤§å°</label>
                        <div class="slider-container">
                            <input type="range" id="selectedFontSize" min="12" max="72" value="24">
                            <span class="slider-value" id="selectedFontSizeValue">24px</span>
                        </div>
                    </div>
                </div>
                
                <label for="lineHeight">è¡Œè·</label>
                <div class="slider-container">
                    <input type="range" id="lineHeight" min="0.8" max="3" step="0.1" value="1.4">
                    <span class="slider-value" id="lineHeightValue">1.4</span>
                </div>
                
                <div class="color-settings">
                    <div class="color-setting">
                        <label for="textColor">æ–‡å­—é¢œè‰²</label>
                        <div class="color-picker">
                            <input type="color" id="textColor" value="#ffffff">
                            <span id="textColorValue">#FFFFFF</span>
                        </div>
                    </div>
                    <div class="color-setting">
                        <label for="bgColor">æ–‡å­—èƒŒæ™¯é¢œè‰²</label>
                        <div class="color-picker">
                            <input type="color" id="bgColor" value="#000000">
                            <span id="bgColorValue">#000000</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–‡å­—èƒŒæ™¯æŒ‰é’®å’Œé¢æ¿ -->
        <div class="sidebar-btn" id="textBgBtn">
            <i>ğŸ–‹ï¸</i>
            <span>æ–‡å­—èƒŒæ™¯</span>
        </div>
        <div class="sidebar-panel" id="textBgPanel">
            <div class="panel-header">
                <div class="panel-title">æ–‡å­—èƒŒæ™¯</div>
                <button class="close-panel">&times;</button>
            </div>
            <div class="control-group">
                <label for="bgOpacity">èƒŒæ™¯é€æ˜åº¦</label>
                <div class="slider-container">
                    <input type="range" id="bgOpacity" min="0" max="100" value="50">
                    <span class="slider-value" id="bgOpacityValue">50%</span>
                </div>
                
                <label for="bgHeight">èƒŒæ™¯é«˜åº¦ï¼ˆç›¸å¯¹äºæ–‡å­—ï¼‰</label>
                <div class="slider-container">
                    <input type="range" id="bgHeight" min="50" max="200" value="100">
                    <span class="slider-value" id="bgHeightValue">100%</span>
                </div>
                
                <label for="maxWidth">æœ€å¤§å®½åº¦ï¼ˆå å›¾ç‰‡ç™¾åˆ†æ¯”ï¼‰</label>
                <div class="slider-container">
                    <input type="range" id="maxWidth" min="20" max="100" value="80">
                    <span class="slider-value" id="maxWidthValue">80%</span>
                </div>
            </div>
        </div>

        <div class="sidebar-btn download-btn" id="downloadBtn">
            <i>â¬‡ï¸</i>
            <span>ä¸‹è½½å›¾ç‰‡</span>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <div class="controls">
                <div class="control-group">
                    <h2>æ–‡å­—å†…å®¹</h2>
                    <label for="textInput">è¾“å…¥æ–‡å­—ï¼ˆæ”¯æŒæ‰‹åŠ¨æ¢è¡Œå’Œç©ºè¡Œï¼‰</label>
                    <textarea id="textInput" placeholder="åœ¨è¿™é‡Œè¾“å…¥è¦æ·»åŠ åˆ°å›¾ç‰‡ä¸Šçš„æ–‡å­—..."></textarea>
                    <button class="apply-text-btn" id="applyTextBtn">åº”ç”¨æ–‡å­—</button>
                </div>
                
                <div class="control-group">
                    <h2>å·²åº”ç”¨çš„æ–‡å­—</h2>
                    <div class="applied-texts-list" id="appliedTextsList">
                        <!-- å·²åº”ç”¨çš„æ–‡å­—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>
            
            <div class="preview">
                <div class="preview-content">
                    <h2>é¢„è§ˆ</h2>
                    <div class="preview-container" id="previewContainer">
                        <canvas id="previewCanvas"></canvas>
                        <div id="previewPlaceholder" class="preview-placeholder">
                            <i>ğŸ“·</i>
                            <p>ä¸Šä¼ å›¾ç‰‡åï¼Œé¢„è§ˆå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                        </div>
                        <div class="drag-indicator" id="dragIndicator">æ‹–åŠ¨è°ƒæ•´ä½ç½®</div>
                    </div>
                    <div class="tips">
                        <p><strong>ä½¿ç”¨æç¤ºï¼š</strong></p>
                        <ul>
                            <li>åœ¨æ–‡å­—æ¡†ä¸­æŒ‰Enteré”®å¯ä»¥æ‰‹åŠ¨æ¢è¡Œï¼Œç©ºè¡Œä¹Ÿä¼šåœ¨é¢„è§ˆä¸­æ˜¾ç¤º</li>
                            <li>é€‰æ‹©æ–‡å­—åä½¿ç”¨"é€‰ä¸­æ–‡å­—å¤§å°"æ»‘å—è°ƒæ•´é€‰ä¸­æ–‡å­—çš„å¤§å°</li>
                            <li>ä½¿ç”¨"åŸºç¡€å­—ä½“å¤§å°"æ»‘å—è°ƒæ•´æœªé€‰ä¸­æ–‡å­—çš„å¤§å°</li>
                            <li>ç›´æ¥åœ¨é¢„è§ˆåŒºåŸŸæ‹–åŠ¨æ–‡å­—è°ƒæ•´ä½ç½®</li>
                            <li>èƒŒæ™¯é€æ˜åº¦è®¾ä¸º0å¯ä»¥éšè—æ–‡å­—èƒŒæ™¯</li>
                            <li>ä¸Šä¼ å›¾ç‰‡åå¯ä»¥ä½¿ç”¨æ‰©å±•ç”»å¸ƒåŠŸèƒ½æ·»åŠ æ–‡å­—åŒºåŸŸ</li>
                            <li>ä½¿ç”¨æ–‡å­—å¯¹é½æŒ‰é’®è°ƒæ•´æ–‡å­—åœ¨èƒŒæ™¯æ¡†å†…çš„å¯¹é½æ–¹å¼</li>
                            <li>è°ƒæ•´è¡Œè·æ»‘å—å¯ä»¥æ”¹å˜æ–‡å­—è¡Œä¸è¡Œä¹‹é—´çš„è·ç¦»</li>
                            <li>è°ƒæ•´èƒŒæ™¯é«˜åº¦å¯ä»¥æ§åˆ¶æ–‡å­—èƒŒæ™¯çš„å‚ç›´å°ºå¯¸</li>
                            <li>æ‹–åŠ¨æ‰©å±•ç”»å¸ƒæ»‘å—å¯ä»¥å®æ—¶é¢„è§ˆæ‰©å±•æ•ˆæœ</li>
                            <li>ç‚¹å‡»"åº”ç”¨æ–‡å­—"æŒ‰é’®å°†å½“å‰æ–‡å­—æ·»åŠ åˆ°å›¾ç‰‡ä¸Š</li>
                            <li>å¯ä»¥æ·»åŠ å¤šä¸ªæ–‡å­—ï¼Œæ¯ä¸ªæ–‡å­—å¯ä»¥å•ç‹¬è°ƒæ•´ä½ç½®å’Œæ ·å¼</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ è¾“å…¥ -->
    <input type="file" id="imageUpload" accept="image/*" style="display: none;">

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–DOMå…ƒç´ 
            const imageUpload = document.getElementById('imageUpload');
            const textInput = document.getElementById('textInput');
            const fontFamily = document.getElementById('fontFamily');
            const fontSize = document.getElementById('fontSize');
            const fontSizeValue = document.getElementById('fontSizeValue');
            const selectedFontSize = document.getElementById('selectedFontSize');
            const selectedFontSizeValue = document.getElementById('selectedFontSizeValue');
            const textColor = document.getElementById('textColor');
            const textColorValue = document.getElementById('textColorValue');
            const bgColor = document.getElementById('bgColor');
            const bgColorValue = document.getElementById('bgColorValue');
            const bgOpacity = document.getElementById('bgOpacity');
            const bgOpacityValue = document.getElementById('bgOpacityValue');
            const bgHeight = document.getElementById('bgHeight');
            const bgHeightValue = document.getElementById('bgHeightValue');
            const maxWidth = document.getElementById('maxWidth');
            const maxWidthValue = document.getElementById('maxWidthValue');
            const downloadBtn = document.getElementById('downloadBtn');
            const previewCanvas = document.getElementById('previewCanvas');
            const previewPlaceholder = document.getElementById('previewPlaceholder');
            const previewContainer = document.getElementById('previewContainer');
            const dragIndicator = document.getElementById('dragIndicator');
            
            // ä¾§è¾¹æ æŒ‰é’®å’Œé¢æ¿
            const sidebar = document.getElementById('sidebar');
            const sidebarUploadBtn = document.getElementById('uploadBtn');
            const sidebarExtensionBtn = document.getElementById('extensionBtn');
            const sidebarTextStyleBtn = document.getElementById('textStyleBtn');
            const sidebarTextBgBtn = document.getElementById('textBgBtn');
            const sidebarDownloadBtn = document.getElementById('downloadBtn');
            
            const extensionPanel = document.getElementById('extensionPanel');
            const textStylePanel = document.getElementById('textStylePanel');
            const textBgPanel = document.getElementById('textBgPanel');
            
            const closePanelButtons = document.querySelectorAll('.close-panel');
            
            // å…¶ä»–å…ƒç´ 
            const canvasExtension = document.getElementById('canvasExtension');
            const canvasExtensionValue = document.getElementById('canvasExtensionValue');
            const extensionPosition = document.getElementById('extensionPosition');
            const bgType = document.getElementById('bgType');
            const canvasBgColor = document.getElementById('canvasBgColor');
            const canvasBgColorValue = document.getElementById('canvasBgColorValue');
            const bgColorSection = document.getElementById('bgColorSection');
            const bgGradientSection = document.getElementById('bgGradientSection');
            const gradientColor1 = document.getElementById('gradientColor1');
            const gradientColor1Value = document.getElementById('gradientColor1Value');
            const gradientColor2 = document.getElementById('gradientColor2');
            const gradientColor2Value = document.getElementById('gradientColor2Value');
            const gradientPreview = document.getElementById('gradientPreview');
            const lineHeight = document.getElementById('lineHeight');
            const lineHeightValue = document.getElementById('lineHeightValue');
            const alignButtons = document.querySelectorAll('.align-btn');
            const applyExtension = document.getElementById('applyExtension');
            
            // æ–°å¢å…ƒç´ 
            const applyTextBtn = document.getElementById('applyTextBtn');
            const appliedTextsList = document.getElementById('appliedTextsList');
            
            const ctx = previewCanvas.getContext('2d');
            
            let originalImage = null;
            let isDragging = false;
            let textX = 0.5;
            let textY = 0.85;
            let dragStartX, dragStartY;
            let startTextX, startTextY;
            let scaleRatio = 1;
            let selectedText = {
                start: -1,
                end: -1,
                text: ''
            };
            let textAlign = 'left';
            let lineHeightMultiplier = 1.4;
            let bgHeightMultiplier = 1.0;
            let activePanel = null;
            let activeButton = null;
            
            // æ‰©å±•å†å²è®°å½•
            let extensionHistory = [];
            // å½“å‰é¢„è§ˆçš„æ‰©å±•é«˜åº¦ï¼ˆä¸´æ—¶é¢„è§ˆç”¨ï¼‰
            let previewExtensionHeight = 0;
            
            // æ–°å¢ï¼šå·²åº”ç”¨çš„æ–‡å­—æ•°ç»„
            let appliedTexts = [];
            // å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ–‡å­—ç´¢å¼•ï¼ˆ-1è¡¨ç¤ºæ–°æ–‡å­—ï¼‰
            let currentTextIndex = -1;

            // åˆå§‹åŒ–
            initApp();

            function initApp() {
                // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
                bindEventListeners();
                
                // è®¾ç½®åˆå§‹å€¼
                updateSliderValues();
                
                // åˆå§‹åŒ–æ¸å˜é¢„è§ˆ
                updateGradientPreview();
                
                // æ›´æ–°å·²åº”ç”¨æ–‡å­—åˆ—è¡¨
                updateAppliedTextsList();
            }

            function bindEventListeners() {
                // ä¾§è¾¹æ æŒ‰é’®åŠŸèƒ½
                sidebarUploadBtn.addEventListener('click', function() {
                    imageUpload.click();
                });
                
                sidebarExtensionBtn.addEventListener('click', function() {
                    togglePanel(extensionPanel, this);
                });
                
                sidebarTextStyleBtn.addEventListener('click', function() {
                    togglePanel(textStylePanel, this);
                });
                
                sidebarTextBgBtn.addEventListener('click', function() {
                    togglePanel(textBgPanel, this);
                });
                
                sidebarDownloadBtn.addEventListener('click', downloadImage);
                
                // å…³é—­é¢æ¿æŒ‰é’®
                closePanelButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.stopPropagation();
                        hideAllPanels();
                    });
                });
                
                // æ»‘å—äº‹ä»¶
                fontSize.addEventListener('input', function() {
                    fontSizeValue.textContent = `${this.value}px`;
                    updatePreview();
                });
                
                selectedFontSize.addEventListener('input', function() {
                    selectedFontSizeValue.textContent = `${this.value}px`;
                    updatePreview();
                });
                
                lineHeight.addEventListener('input', function() {
                    lineHeightMultiplier = parseFloat(this.value);
                    lineHeightValue.textContent = lineHeightMultiplier.toFixed(1);
                    updatePreview();
                });
                
                bgOpacity.addEventListener('input', function() {
                    bgOpacityValue.textContent = `${this.value}%`;
                    updatePreview();
                });
                
                bgHeight.addEventListener('input', function() {
                    bgHeightMultiplier = parseInt(this.value) / 100;
                    bgHeightValue.textContent = `${this.value}%`;
                    updatePreview();
                });
                
                maxWidth.addEventListener('input', function() {
                    maxWidthValue.textContent = `${this.value}%`;
                    updatePreview();
                });
                
                // æ‰©å±•ç”»å¸ƒæ»‘å— - å®æ—¶é¢„è§ˆ
                canvasExtension.addEventListener('input', function() {
                    canvasExtensionValue.textContent = `${this.value}px`;
                    previewExtensionHeight = parseInt(this.value);
                    updatePreview();
                });
                
                // åº”ç”¨æ‰©å±•æŒ‰é’®
                applyExtension.addEventListener('click', applyCanvasExtension);
                
                // åº”ç”¨æ–‡å­—æŒ‰é’®
                applyTextBtn.addEventListener('click', applyTextToImage);
                
                // å…¶ä»–äº‹ä»¶
                fontFamily.addEventListener('change', updatePreview);
                textColor.addEventListener('input', function() {
                    textColorValue.textContent = this.value.toUpperCase();
                    updatePreview();
                });
                bgColor.addEventListener('input', function() {
                    bgColorValue.textContent = this.value.toUpperCase();
                    updatePreview();
                });
                canvasBgColor.addEventListener('input', function() {
                    canvasBgColorValue.textContent = this.value.toUpperCase();
                    updatePreview();
                });
                
                // æ‰©å±•ç›¸å…³è®¾ç½®å˜åŒ–æ—¶æ›´æ–°é¢„è§ˆ
                extensionPosition.addEventListener('change', updatePreview);
                bgType.addEventListener('change', function() {
                    if (this.value === 'color') {
                        bgColorSection.style.display = 'block';
                        bgGradientSection.style.display = 'none';
                    } else {
                        bgColorSection.style.display = 'none';
                        bgGradientSection.style.display = 'block';
                        updateGradientPreview();
                    }
                    updatePreview();
                });
                
                // æ–‡å­—å¯¹é½æŒ‰é’®
                alignButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        alignButtons.forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');
                        textAlign = this.getAttribute('data-align');
                        updatePreview();
                    });
                });
                
                gradientColor1.addEventListener('input', function() {
                    gradientColor1Value.textContent = this.value.toUpperCase();
                    updateGradientPreview();
                    updatePreview();
                });
                
                gradientColor2.addEventListener('input', function() {
                    gradientColor2Value.textContent = this.value.toUpperCase();
                    updateGradientPreview();
                    updatePreview();
                });
                
                // å›¾ç‰‡ä¸Šä¼ 
                imageUpload.addEventListener('change', handleImageUpload);
                
                // æ–‡å­—è¾“å…¥
                textInput.addEventListener('input', updatePreview);
                textInput.addEventListener('select', updateSelectionInfo);
                
                // æ‹–åŠ¨åŠŸèƒ½
                setupDragFunctionality();
                
                // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­é¢æ¿
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.sidebar')) {
                        hideAllPanels();
                    }
                });
            }

            function updateSliderValues() {
                fontSizeValue.textContent = `${fontSize.value}px`;
                selectedFontSizeValue.textContent = `${selectedFontSize.value}px`;
                lineHeightValue.textContent = lineHeight.value;
                bgOpacityValue.textContent = `${bgOpacity.value}%`;
                bgHeightValue.textContent = `${bgHeight.value}%`;
                maxWidthValue.textContent = `${maxWidth.value}%`;
                canvasExtensionValue.textContent = `${canvasExtension.value}px`;
            }

            function updateGradientPreview() {
                gradientPreview.style.background = `linear-gradient(to right, ${gradientColor1.value}, ${gradientColor2.value})`;
            }

            function handleImageUpload(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        const img = new Image();
                        img.onload = function() {
                            originalImage = img;
                            previewPlaceholder.style.display = 'none';
                            previewCanvas.style.display = 'block';
                            
                            previewCanvas.width = img.width;
                            previewCanvas.height = img.height;
                            
                            const containerWidth = previewContainer.clientWidth;
                            scaleRatio = containerWidth / img.width;
                            
                            // é‡ç½®æ‰©å±•å†å²
                            extensionHistory = [];
                            previewExtensionHeight = 0;
                            
                            // æ¸…ç©ºå·²åº”ç”¨çš„æ–‡å­—
                            appliedTexts = [];
                            updateAppliedTextsList();
                            
                            updatePreview();
                        };
                        img.src = event.target.result;
                    };
                    
                    reader.readAsDataURL(file);
                }
            }

            function togglePanel(panel, button) {
                if (activePanel === panel) {
                    panel.classList.remove('active');
                    button.classList.remove('active');
                    activePanel = null;
                    activeButton = null;
                } else {
                    hideAllPanels();
                    panel.classList.add('active');
                    button.classList.add('active');
                    activePanel = panel;
                    activeButton = button;
                    button.parentNode.insertBefore(panel, button.nextSibling);
                }
            }

            function hideAllPanels() {
                document.querySelectorAll('.sidebar-panel').forEach(panel => {
                    panel.classList.remove('active');
                });
                document.querySelectorAll('.sidebar-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                activePanel = null;
                activeButton = null;
            }

            function setupDragFunctionality() {
                previewContainer.addEventListener('mousedown', function(e) {
                    if (!originalImage) return;
                    
                    const rect = previewCanvas.getBoundingClientRect();
                    const mouseX = (e.clientX - rect.left) / scaleRatio;
                    const mouseY = (e.clientY - rect.top) / scaleRatio;
                    
                    const text = textInput.value;
                    if (!text) return;
                    
                    const fontSizeVal = parseInt(fontSize.value);
                    ctx.font = `${fontSizeVal}px ${fontFamily.value}`;
                    
                    const maxWidthPercent = parseInt(maxWidth.value);
                    const maxTextWidth = previewCanvas.width * maxWidthPercent / 100;
                    
                    const lines = wrapText(ctx, text, maxTextWidth);
                    const lineHeightVal = fontSizeVal * lineHeightMultiplier;
                    const totalTextHeight = lines.length * lineHeightVal;
                    
                    const paddingValue = 10;
                    const bgWidth = maxTextWidth + paddingValue * 2;
                    const bgHeight = totalTextHeight * bgHeightMultiplier + paddingValue * 2;
                    
                    const canvasX = textX * previewCanvas.width;
                    const canvasY = textY * previewCanvas.height;
                    
                    const bgLeft = canvasX - bgWidth / 2;
                    const bgTop = canvasY - bgHeight / 2;
                    const bgRight = bgLeft + bgWidth;
                    const bgBottom = bgTop + bgHeight;
                    
                    if (mouseX >= bgLeft && mouseX <= bgRight && 
                        mouseY >= bgTop && mouseY <= bgBottom) {
                        isDragging = true;
                        dragStartX = e.clientX;
                        dragStartY = e.clientY;
                        startTextX = textX;
                        startTextY = textY;
                        previewContainer.style.cursor = 'grabbing';
                        dragIndicator.style.display = 'block';
                        e.preventDefault();
                    }
                });
                
                document.addEventListener('mousemove', function(e) {
                    if (!isDragging || !originalImage) return;
                    
                    const deltaX = e.clientX - dragStartX;
                    const deltaY = e.clientY - dragStartY;
                    
                    const displayWidth = previewCanvas.width * scaleRatio;
                    const displayHeight = previewCanvas.height * scaleRatio;
                    
                    textX = Math.max(0, Math.min(1, startTextX + deltaX / displayWidth));
                    textY = Math.max(0, Math.min(1, startTextY + deltaY / displayHeight));
                    
                    updatePreview();
                });
                
                document.addEventListener('mouseup', function() {
                    if (isDragging) {
                        isDragging = false;
                        previewContainer.style.cursor = 'move';
                        dragIndicator.style.display = 'none';
                    }
                });
            }

            function updateSelectionInfo() {
                const start = textInput.selectionStart;
                const end = textInput.selectionEnd;
                
                if (start !== end) {
                    selectedText.start = start;
                    selectedText.end = end;
                    selectedText.text = textInput.value.substring(start, end);
                } else {
                    selectedText.start = -1;
                    selectedText.end = -1;
                    selectedText.text = '';
                }
                updatePreview();
            }

            function wrapText(context, text, maxWidth) {
                const paragraphs = text.split('\n');
                const lines = [];
                
                for (let p = 0; p < paragraphs.length; p++) {
                    const paragraph = paragraphs[p];
                    
                    if (paragraph === '') {
                        lines.push('');
                        continue;
                    }
                    
                    let currentLine = '';
                    
                    for (let i = 0; i < paragraph.length; i++) {
                        const char = paragraph[i];
                        const testLine = currentLine + char;
                        const metrics = context.measureText(testLine);
                        const testWidth = metrics.width;
                        
                        if (testWidth > maxWidth && currentLine !== '') {
                            lines.push(currentLine);
                            currentLine = char;
                        } else {
                            currentLine = testLine;
                        }
                    }
                    
                    if (currentLine !== '') {
                        lines.push(currentLine);
                    }
                }
                
                return lines;
            }

            function drawText() {
                const text = textInput.value;
                if (!text) return;
                
                const baseFontSizeVal = parseInt(fontSize.value);
                const selectedFontSizeVal = parseInt(selectedFontSize.value);
                
                const maxWidthPercent = parseInt(maxWidth.value);
                const maxTextWidth = previewCanvas.width * maxWidthPercent / 100;
                
                const x = textX * previewCanvas.width;
                const y = textY * previewCanvas.height;
                
                ctx.font = `${baseFontSizeVal}px ${fontFamily.value}`;
                ctx.fillStyle = textColor.value;
                ctx.textBaseline = 'middle';
                
                const lines = wrapText(ctx, text, maxTextWidth);
                const lineHeightVal = baseFontSizeVal * lineHeightMultiplier;
                
                let totalTextHeight = 0;
                for (let i = 0; i < lines.length; i++) {
                    totalTextHeight += lineHeightVal;
                }
                
                const paddingValue = 10;
                const bgWidth = maxTextWidth + paddingValue * 2;
                const bgHeight = totalTextHeight * bgHeightMultiplier + paddingValue * 2;
                
                // ç»˜åˆ¶èƒŒæ™¯
                ctx.globalAlpha = bgOpacity.value / 100;
                ctx.fillStyle = bgColor.value;
                ctx.fillRect(
                    x - bgWidth / 2,
                    y - bgHeight / 2,
                    bgWidth, 
                    bgHeight
                );
                
                ctx.globalAlpha = 1;
                ctx.fillStyle = textColor.value;
                
                const bgLeft = x - bgWidth / 2;
                const bgRight = x + bgWidth / 2;
                
                const textStartY = y - bgHeight / 2 + paddingValue;
                
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i] === '') continue;
                    
                    let textXPos;
                    if (textAlign === 'left') {
                        textXPos = bgLeft + paddingValue;
                    } else if (textAlign === 'right') {
                        textXPos = bgRight - paddingValue;
                    } else {
                        textXPos = x;
                    }
                    
                    ctx.textAlign = textAlign;
                    ctx.fillText(
                        lines[i], 
                        textXPos, 
                        textStartY + lineHeightVal * (i + 0.5)
                    );
                }
            }

            function applyCanvasExtension() {
                if (!originalImage) {
                    alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
                    return;
                }
                
                const extensionHeight = parseInt(canvasExtension.value);
                if (extensionHeight <= 0) {
                    alert('è¯·è®¾ç½®æ‰©å±•é«˜åº¦ï¼');
                    return;
                }
                
                const position = extensionPosition.value;
                const bgTypeValue = bgType.value;
                
                // ä¿å­˜æ‰©å±•å†å²
                extensionHistory.push({
                    height: extensionHeight,
                    position: position,
                    bgType: bgTypeValue,
                    bgColor: canvasBgColor.value,
                    gradientColor1: gradientColor1.value,
                    gradientColor2: gradientColor2.value
                });
                
                // é‡ç½®æ‰©å±•æ»‘å—å’Œé¢„è§ˆé«˜åº¦
                canvasExtension.value = 0;
                canvasExtensionValue.textContent = '0px';
                previewExtensionHeight = 0;
                
                // æ›´æ–°é¢„è§ˆ
                updatePreview();
            }

            // æ–°å¢ï¼šåº”ç”¨æ–‡å­—åˆ°å›¾ç‰‡
            function applyTextToImage() {
                const text = textInput.value.trim();
                if (!text) {
                    alert('è¯·è¾“å…¥æ–‡å­—å†…å®¹ï¼');
                    return;
                }
                
                if (!originalImage) {
                    alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
                    return;
                }
                
                // åˆ›å»ºæ–‡å­—å¯¹è±¡
                const textObj = {
                    text: text,
                    x: textX,
                    y: textY,
                    fontFamily: fontFamily.value,
                    fontSize: parseInt(fontSize.value),
                    selectedFontSize: parseInt(selectedFontSize.value),
                    textColor: textColor.value,
                    bgColor: bgColor.value,
                    bgOpacity: parseInt(bgOpacity.value),
                    bgHeightMultiplier: bgHeightMultiplier,
                    maxWidthPercent: parseInt(maxWidth.value),
                    textAlign: textAlign,
                    lineHeightMultiplier: lineHeightMultiplier
                };
                
                // æ·»åŠ æˆ–æ›´æ–°æ–‡å­—
                if (currentTextIndex === -1) {
                    // æ·»åŠ æ–°æ–‡å­—
                    appliedTexts.push(textObj);
                } else {
                    // æ›´æ–°ç°æœ‰æ–‡å­—
                    appliedTexts[currentTextIndex] = textObj;
                    currentTextIndex = -1;
                }
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                textInput.value = '';
                
                // æ›´æ–°å·²åº”ç”¨æ–‡å­—åˆ—è¡¨
                updateAppliedTextsList();
                
                // æ›´æ–°é¢„è§ˆ
                updatePreview();
            }

            // æ–°å¢ï¼šæ›´æ–°å·²åº”ç”¨æ–‡å­—åˆ—è¡¨
            function updateAppliedTextsList() {
                appliedTextsList.innerHTML = '';
                
                if (appliedTexts.length === 0) {
                    appliedTextsList.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 10px;">æš‚æ— å·²åº”ç”¨çš„æ–‡å­—</p>';
                    return;
                }
                
                appliedTexts.forEach((textObj, index) => {
                    const textItem = document.createElement('div');
                    textItem.className = 'applied-text-item';
                    
                    const textContent = document.createElement('span');
                    textContent.textContent = textObj.text.length > 30 ? 
                        textObj.text.substring(0, 30) + '...' : textObj.text;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-text-btn';
                    deleteBtn.textContent = 'åˆ é™¤';
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        deleteAppliedText(index);
                    });
                    
                    textItem.appendChild(textContent);
                    textItem.appendChild(deleteBtn);
                    
                    // ç‚¹å‡»æ–‡å­—é¡¹å¯ä»¥ç¼–è¾‘
                    textItem.addEventListener('click', function() {
                        editAppliedText(index);
                    });
                    
                    appliedTextsList.appendChild(textItem);
                });
            }

            // æ–°å¢ï¼šåˆ é™¤å·²åº”ç”¨çš„æ–‡å­—
            function deleteAppliedText(index) {
                appliedTexts.splice(index, 1);
                updateAppliedTextsList();
                updatePreview();
            }

            // æ–°å¢ï¼šç¼–è¾‘å·²åº”ç”¨çš„æ–‡å­—
            function editAppliedText(index) {
                const textObj = appliedTexts[index];
                
                // å¡«å……è¡¨å•
                textInput.value = textObj.text;
                textX = textObj.x;
                textY = textObj.y;
                fontFamily.value = textObj.fontFamily;
                fontSize.value = textObj.fontSize;
                selectedFontSize.value = textObj.selectedFontSize;
                textColor.value = textObj.textColor;
                bgColor.value = textObj.bgColor;
                bgOpacity.value = textObj.bgOpacity;
                bgHeight.value = textObj.bgHeightMultiplier * 100;
                maxWidth.value = textObj.maxWidthPercent;
                lineHeight.value = textObj.lineHeightMultiplier;
                
                // è®¾ç½®å¯¹é½æŒ‰é’®
                alignButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-align') === textObj.textAlign) {
                        btn.classList.add('active');
                    }
                });
                textAlign = textObj.textAlign;
                
                // æ›´æ–°æ»‘å—å€¼æ˜¾ç¤º
                updateSliderValues();
                
                // è®¾ç½®å½“å‰ç¼–è¾‘çš„æ–‡å­—ç´¢å¼•
                currentTextIndex = index;
                
                // æ›´æ–°é¢„è§ˆ
                updatePreview();
            }

            // æ–°å¢ï¼šç»˜åˆ¶å·²åº”ç”¨çš„æ–‡å­—
            function drawAppliedTexts() {
                appliedTexts.forEach(textObj => {
                    const baseFontSizeVal = textObj.fontSize;
                    const maxTextWidth = previewCanvas.width * textObj.maxWidthPercent / 100;
                    
                    const x = textObj.x * previewCanvas.width;
                    const y = textObj.y * previewCanvas.height;
                    
                    ctx.font = `${baseFontSizeVal}px ${textObj.fontFamily}`;
                    ctx.fillStyle = textObj.textColor;
                    ctx.textBaseline = 'middle';
                    
                    const lines = wrapText(ctx, textObj.text, maxTextWidth);
                    const lineHeightVal = baseFontSizeVal * textObj.lineHeightMultiplier;
                    
                    let totalTextHeight = 0;
                    for (let i = 0; i < lines.length; i++) {
                        totalTextHeight += lineHeightVal;
                    }
                    
                    const paddingValue = 10;
                    const bgWidth = maxTextWidth + paddingValue * 2;
                    const bgHeight = totalTextHeight * textObj.bgHeightMultiplier + paddingValue * 2;
                    
                    // ç»˜åˆ¶èƒŒæ™¯
                    ctx.globalAlpha = textObj.bgOpacity / 100;
                    ctx.fillStyle = textObj.bgColor;
                    ctx.fillRect(
                        x - bgWidth / 2,
                        y - bgHeight / 2,
                        bgWidth, 
                        bgHeight
                    );
                    
                    ctx.globalAlpha = 1;
                    ctx.fillStyle = textObj.textColor;
                    
                    const bgLeft = x - bgWidth / 2;
                    const bgRight = x + bgWidth / 2;
                    
                    const textStartY = y - bgHeight / 2 + paddingValue;
                    
                    for (let i = 0; i < lines.length; i++) {
                        if (lines[i] === '') continue;
                        
                        let textXPos;
                        if (textObj.textAlign === 'left') {
                            textXPos = bgLeft + paddingValue;
                        } else if (textObj.textAlign === 'right') {
                            textXPos = bgRight - paddingValue;
                        } else {
                            textXPos = x;
                        }
                        
                        ctx.textAlign = textObj.textAlign;
                        ctx.fillText(
                            lines[i], 
                            textXPos, 
                            textStartY + lineHeightVal * (i + 0.5)
                        );
                    }
                });
            }

            function updatePreview() {
                if (!originalImage) return;
                
                // è®¡ç®—æ€»æ‰©å±•é«˜åº¦ï¼ˆå†å²æ‰©å±• + å½“å‰é¢„è§ˆæ‰©å±•ï¼‰
                const totalExtensionHeight = extensionHistory.reduce((total, item) => total + item.height, 0) + previewExtensionHeight;
                
                // è®¾ç½®ç”»å¸ƒå°ºå¯¸ï¼ˆåŸå›¾å°ºå¯¸ + æ€»æ‰©å±•é«˜åº¦ï¼‰
                const newWidth = originalImage.width;
                const newHeight = originalImage.height + totalExtensionHeight;
                
                // åªæœ‰åœ¨å°ºå¯¸å˜åŒ–æ—¶æ‰é‡æ–°è®¾ç½®ç”»å¸ƒå°ºå¯¸
                if (previewCanvas.width !== newWidth || previewCanvas.height !== newHeight) {
                    previewCanvas.width = newWidth;
                    previewCanvas.height = newHeight;
                    
                    // æ›´æ–°ç¼©æ”¾æ¯”ä¾‹
                    const containerWidth = previewContainer.clientWidth;
                    scaleRatio = containerWidth / previewCanvas.width;
                }
                
                ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
                
                if (totalExtensionHeight > 0) {
                    // åˆ›å»ºä¸´æ—¶ç”»å¸ƒæ¥æ„å»ºå®Œæ•´å›¾åƒ
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    // è®¾ç½®ä¸´æ—¶ç”»å¸ƒå°ºå¯¸
                    tempCanvas.width = originalImage.width;
                    tempCanvas.height = originalImage.height + totalExtensionHeight;
                    
                    let currentY = 0;
                    
                    // ç»˜åˆ¶ä¸Šæ–¹æ‰©å±•ï¼ˆå†å² + é¢„è§ˆï¼‰
                    const topExtensions = extensionHistory.filter(item => item.position === 'top');
                    const bottomExtensions = extensionHistory.filter(item => item.position === 'bottom');
                    
                    // ç»˜åˆ¶ä¸Šæ–¹å†å²æ‰©å±•
                    topExtensions.forEach(item => {
                        if (item.bgType === 'color') {
                            tempCtx.fillStyle = item.bgColor;
                        } else {
                            const gradient = tempCtx.createLinearGradient(0, currentY, tempCanvas.width, currentY + item.height);
                            gradient.addColorStop(0, item.gradientColor1);
                            gradient.addColorStop(1, item.gradientColor2);
                            tempCtx.fillStyle = gradient;
                        }
                        tempCtx.fillRect(0, currentY, tempCanvas.width, item.height);
                        currentY += item.height;
                    });
                    
                    // ç»˜åˆ¶ä¸Šæ–¹é¢„è§ˆæ‰©å±•
                    if (previewExtensionHeight > 0 && extensionPosition.value === 'top') {
                        if (bgType.value === 'color') {
                            tempCtx.fillStyle = canvasBgColor.value;
                        } else {
                            const gradient = tempCtx.createLinearGradient(0, currentY, tempCanvas.width, currentY + previewExtensionHeight);
                            gradient.addColorStop(0, gradientColor1.value);
                            gradient.addColorStop(1, gradientColor2.value);
                            tempCtx.fillStyle = gradient;
                        }
                        tempCtx.fillRect(0, currentY, tempCanvas.width, previewExtensionHeight);
                        currentY += previewExtensionHeight;
                    }
                    
                    // ç»˜åˆ¶åŸå›¾ï¼ˆä¿æŒåŸå°ºå¯¸ï¼‰
                    tempCtx.drawImage(originalImage, 0, currentY, originalImage.width, originalImage.height);
                    currentY += originalImage.height;
                    
                    // ç»˜åˆ¶ä¸‹æ–¹é¢„è§ˆæ‰©å±•
                    if (previewExtensionHeight > 0 && extensionPosition.value === 'bottom') {
                        if (bgType.value === 'color') {
                            tempCtx.fillStyle = canvasBgColor.value;
                        } else {
                            const gradient = tempCtx.createLinearGradient(0, currentY, tempCanvas.width, currentY + previewExtensionHeight);
                            gradient.addColorStop(0, gradientColor1.value);
                            gradient.addColorStop(1, gradientColor2.value);
                            tempCtx.fillStyle = gradient;
                        }
                        tempCtx.fillRect(0, currentY, tempCanvas.width, previewExtensionHeight);
                        currentY += previewExtensionHeight;
                    }
                    
                    // ç»˜åˆ¶ä¸‹æ–¹å†å²æ‰©å±•
                    bottomExtensions.forEach(item => {
                        if (item.bgType === 'color') {
                            tempCtx.fillStyle = item.bgColor;
                        } else {
                            const gradient = tempCtx.createLinearGradient(0, currentY, tempCanvas.width, currentY + item.height);
                            gradient.addColorStop(0, item.gradientColor1);
                            gradient.addColorStop(1, item.gradientColor2);
                            tempCtx.fillStyle = gradient;
                        }
                        tempCtx.fillRect(0, currentY, tempCanvas.width, item.height);
                        currentY += item.height;
                    });
                    
                    // ç»˜åˆ¶åˆ°ä¸»ç”»å¸ƒ
                    ctx.drawImage(tempCanvas, 0, 0);
                } else {
                    // æ²¡æœ‰æ‰©å±•ï¼Œç›´æ¥ç»˜åˆ¶åŸå›¾
                    ctx.drawImage(originalImage, 0, 0);
                }
                
                // ç»˜åˆ¶å·²åº”ç”¨çš„æ–‡å­—
                drawAppliedTexts();
                
                // ç»˜åˆ¶å½“å‰ç¼–è¾‘çš„æ–‡å­—ï¼ˆé¢„è§ˆï¼‰
                if (textInput.value.trim() !== '') {
                    drawText();
                }
            }

            function downloadImage() {
                if (!originalImage) {
                    alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
                    return;
                }
                
                const link = document.createElement('a');
                link.download = 'image-with-text.jpeg';
                link.href = previewCanvas.toDataURL('image/jpeg');
                link.click();
            }
        });
    </script>
</body>
</html>