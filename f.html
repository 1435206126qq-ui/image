<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简笔笑画制作器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #07c160; --gray: #f2f2f2; }
        * { box-sizing: border-box; outline: none; user-select: none; }
        body { margin: 0; display: flex; height: 100vh; background: var(--gray); font-family: "Microsoft YaHei", sans-serif; overflow: hidden; }

        /* 左侧边栏 */
        .sidebar { width: 340px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; z-index: 20; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        .sidebar-scroll { flex: 1; overflow-y: auto; padding: 15px; }
        .panel { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        h4 { margin: 0 0 10px 0; font-size: 14px; border-left: 3px solid var(--primary); padding-left: 8px; color: #333; }

        /* 图片库 */
        .lib-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; min-height: 50px;}
        .lib-item { aspect-ratio: 1; background: #eee; cursor: pointer; border: 2px solid transparent; position: relative; }
        .lib-item:hover { border-color: var(--primary); }
        .lib-item img { width: 100%; height: 100%; object-fit: cover; }
        .lib-del { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.5); color: white; width: 15px; height: 15px; font-size: 10px; display: none; text-align: center; line-height: 15px;}
        .lib-item:hover .lib-del { display: block; }

        /* 控件 */
        .control-row { display: flex; align-items: center; margin-bottom: 12px; gap: 10px; }
        .control-row label { width: 60px; font-size: 12px; color: #666; text-align: right; }
        select, input[type=color], input[type=range] { flex: 1; height: 32px; border: 1px solid #ddd; border-radius: 4px; }
        
        .val-display { font-size: 12px; color: #666; width: 30px; text-align: right; }

        .btn { width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; background: #f0f0f0; margin-top: 5px; display: inline-block; text-align: center;}
        .btn:hover { background: #e0e0e0; }
        .btn-green { background: var(--primary); color: white; }
        .btn-green:hover { background: #06ad56; }
        .btn-save { height: 44px; font-size: 16px; font-weight: bold; background: #fa5151; color: white; margin: 15px; width: calc(100% - 30px); }

        /* 右侧画布 */
        .main { flex: 1; background: var(--gray); display: flex; flex-direction: column; align-items: center; overflow-y: auto; padding: 40px; }
        #canvas { 
            background: white; width: 100%; max-width: 600px; 
            min-height: 400px; /* 平时保持最小高度 */
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            height: fit-content; 
            position: relative;
        }

        .row { position: relative; width: 100%; line-height: 0; }
        .img-layer { width: 100%; pointer-events: none; }
        
        .tools { position: absolute; top: 0; right: 0; display: flex; opacity: 0; z-index: 100; background: rgba(0,0,0,0.2); }
        .row:hover .tools { opacity: 1; }
        .tool-btn { width: 24px; height: 24px; border: none; background: transparent; color: white; cursor: pointer; font-weight: bold; }
        .tool-btn:hover { background: var(--primary); }
        .tool-btn.del:hover { background: red; }

        /* 核心样式 */
        .text-box-container {
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) scale(1);
            transform-origin: center center;
            z-index: 50;
            cursor: move; 
            padding: 4px;
            border: 1px dashed transparent;
            line-height: 1.2; 
            border-radius: 4px;
        }
        .text-box-container.active { outline: 1px solid #1890ff; }

        /* 右上角蓝色缩放圆点 */
        .blue-dot {
            position: absolute; top: -6px; right: -6px;
            width: 14px; height: 14px; border-radius: 50%;
            background: #1890ff; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: ne-resize; display: none; z-index: 60;
        }
        .text-box-container.active .blue-dot { display: block; }

        /* V17 新增：左上角红色删除按钮 */
        .text-del-btn {
            position: absolute; top: -8px; left: -8px;
            width: 16px; height: 16px; border-radius: 50%;
            background: #fa5151; color: white; border: 2px solid white;
            font-size: 12px; line-height: 12px; text-align: center;
            cursor: pointer; display: none; z-index: 65;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-weight: bold;
        }
        .text-del-btn:hover { background: red; transform: scale(1.1); }
        .text-box-container.active .text-del-btn { display: block; }

        .text-line {
            position: relative; 
            white-space: nowrap; 
            margin: 0; padding: 0 4px; min-height: 20px;
            border: 1px solid transparent; display: block; width: fit-content;
        }
        .text-line:hover { border-color: rgba(0,0,0,0.1); }
        .line-content { display: inline-block; outline: none; user-select: text; cursor: text; }
        
        .red-dot {
            position: absolute; top: 50%; right: -10px; transform: translateY(-50%);
            width: 10px; height: 10px; border-radius: 50%;
            background: #ff4d4f; border: 1px solid white;
            cursor: ew-resize; display: none; z-index: 70; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .text-line:hover .red-dot { display: block; }

        #dbStatus { font-size: 12px; color: #999; text-align: center; margin-top: 5px; }
        #uploadStatus { font-size: 12px; color: #1890ff; text-align: center; display: none; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-scroll">
        <!-- 1. 素材 -->
        <div class="panel">
            <h4>图片库</h4>
            <div class="lib-grid" id="libGrid"></div>
            <label class="btn btn-green">
                + 批量上传图片
                <input type="file" id="uploadImg" accept="image/*" multiple style="position:absolute; width:1px; height:1px; opacity:0;">
            </label>
            <div id="uploadStatus">正在处理...</div>
            <div id="dbStatus">正在连接数据库...</div>
        </div>

        <!-- 2. 字体与排版 -->
        <div class="panel">
            <h4>字体与排版</h4>
            
            <button class="btn" onclick="addFloatingText()" style="margin-bottom:12px; border:1px dashed #999;">
                + 添加独立文字框
            </button>

            <div class="control-row">
                <label>选择字体</label>
                <select id="fontSelect" onchange="updateGlobalFont()">
                    <option value="Microsoft YaHei">微软雅黑</option>
                    <option value="SimHei">黑体</option>
                    <option value="Arial">Arial</option>
                </select>
            </div>
            
            <label class="btn" style="text-align:center; display:block; margin-bottom:15px;">
                📂 上传字体 (自动设为默认)
                <input type="file" id="uploadFont" accept=".ttf,.otf,.woff" style="display:none">
            </label>

            <div class="control-row">
                <label>行间距</label>
                <input type="range" id="lineHeightRange" min="0.8" max="2.5" step="0.1" value="1.2" oninput="updateLineHeight(this.value)">
                <span class="val-display" id="lhValue">1.2</span>
            </div>

            <div class="control-row">
                <label>字色</label>
                <input type="color" id="fontColor" value="#000000" oninput="applyColor(this.value)">
            </div>

            <div class="control-row">
                <label>背景色</label>
                <input type="color" id="bgColor" value="#ffffff" oninput="applyBackground()">
            </div>
            <div class="control-row">
                <label>背景透明</label>
                <input type="range" id="bgOpacity" min="0" max="1" step="0.05" value="0" oninput="applyBackground()">
                <span class="val-display" id="bgOpValue">0</span>
            </div>

            <div class="control-row">
                <label>加粗</label>
                <button class="btn" onclick="applyBold()" style="margin-top:0">B 加粗</button>
            </div>
        </div>
    </div>
    <button class="btn btn-save" onclick="saveLongImage()">保存长图</button>
</div>

<div class="main">
    <div id="canvas"></div>
    <div style="height:50px;"></div>
</div>

<script>
    // === 全局状态 ===
    let GLOBAL_DEFAULT_FONT = 'Microsoft YaHei'; 
    let currentContainer = null; 
    
    const SAVED_FONT = localStorage.getItem('WECHAT_TOOL_FONT_PREF');
    if(SAVED_FONT) {
        GLOBAL_DEFAULT_FONT = SAVED_FONT;
        const sel = document.getElementById('fontSelect');
        if(Array.from(sel.options).some(opt => opt.value === SAVED_FONT)) {
            sel.value = SAVED_FONT;
        }
    }

    // === 数据库初始化 ===
    const DB_NAME = "WeChatToolDB_V14"; 
    let db = null;

    function initDB() {
        try {
            const req = indexedDB.open(DB_NAME, 1);
            req.onupgradeneeded = e => {
                db = e.target.result;
                if(!db.objectStoreNames.contains('images')) db.createObjectStore('images', { keyPath: 'id', autoIncrement:true });
                if(!db.objectStoreNames.contains('fonts')) db.createObjectStore('fonts', { keyPath: 'name' });
            };
            req.onsuccess = e => {
                db = e.target.result;
                document.getElementById('dbStatus').innerText = "✅ 数据库就绪";
                loadImages();
                loadFonts(); 
            };
            req.onerror = e => {
                document.getElementById('dbStatus').innerText = "❌ 数据库错误";
            };
        } catch(err) {
            alert("浏览器不支持数据库，部分功能可能受限");
        }
    }

    // === 图片逻辑 ===
    document.getElementById('uploadImg').onchange = function(e) {
        if(!db) { alert("数据库未就绪"); return; }
        const files = Array.from(e.target.files);
        if(files.length === 0) return;
        
        const statusDiv = document.getElementById('uploadStatus');
        statusDiv.style.display = 'block';
        statusDiv.innerText = `正在读取 ${files.length} 张图片...`;

        const promises = files.map(file => new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = ev => resolve(ev.target.result);
            reader.onerror = () => resolve(null);
            reader.readAsDataURL(file);
        }));

        Promise.all(promises).then(dataUrls => {
            const tx = db.transaction('images', 'readwrite');
            dataUrls.forEach(url => { if(url) tx.objectStore('images').add({ data: url }); });
            tx.oncomplete = () => {
                loadImages();
                statusDiv.style.display = 'none';
                document.getElementById('uploadImg').value = ''; 
            };
        });
    };

    function loadImages() {
        if(!db) return;
        const grid = document.getElementById('libGrid');
        grid.innerHTML = "";
        db.transaction('images', 'readonly').objectStore('images').getAll().onsuccess = e => {
            e.target.result.forEach(item => {
                const div = document.createElement('div');
                div.className = 'lib-item';
                div.innerHTML = `<img src="${item.data}"><div class="lib-del" onclick="delImg(${item.id}, event)">×</div>`;
                div.onclick = (evt) => { if(evt.target.className !== 'lib-del') addRow(item.data); };
                grid.appendChild(div);
            });
        };
    }

    window.delImg = (id, e) => {
        e.stopPropagation();
        if(confirm('确定删除?')) {
            const tx = db.transaction('images', 'readwrite');
            tx.objectStore('images').delete(id);
            tx.oncomplete = loadImages;
        }
    };

    // === 字体上传与记忆 ===
    document.getElementById('uploadFont').onchange = async function(e) {
        const file = e.target.files[0];
        if(!file) return;
        const btn = this.parentElement;
        const oldText = btn.innerText;
        btn.firstChild.textContent = "正在处理字体...";

        try {
            const buffer = await file.arrayBuffer();
            const name = file.name.replace(/\.[^/.]+$/, "");
            const tx = db.transaction('fonts', 'readwrite');
            tx.objectStore('fonts').put({ name: name, buffer: buffer });
            tx.oncomplete = () => {
                registerFont(name, buffer, true); 
                btn.firstChild.textContent = oldText;
                this.value = '';
            };
        } catch(err) {
            alert("字体读取失败：" + err.message);
            btn.firstChild.textContent = oldText;
        }
    };

    function loadFonts() {
        if(!db) return;
        db.transaction('fonts', 'readonly').objectStore('fonts').getAll().onsuccess = e => {
            e.target.result.forEach(f => registerFont(f.name, f.buffer, false));
        };
    }

    function registerFont(name, buffer, isNew) {
        try {
            const face = new FontFace(name, buffer);
            face.load().then(f => {
                document.fonts.add(f);
                const sel = document.getElementById('fontSelect');
                let exists = false;
                for(let i=0; i<sel.options.length; i++) if(sel.options[i].value === name) exists = true;
                if(!exists) {
                    const opt = document.createElement('option');
                    opt.value = name; opt.text = "自定义: " + name;
                    sel.insertBefore(opt, sel.children[0]);
                }
                if(isNew || name === localStorage.getItem('WECHAT_TOOL_FONT_PREF')) {
                    sel.value = name;
                    updateGlobalFont(); 
                    if(isNew) alert(`字体 "${name}" 已保存并设为默认！`);
                }
            });
        } catch(err) { console.error("字体加载失败", err); }
    }

    // === 核心逻辑 ===
    function addRow(src) {
        const div = document.createElement('div');
        div.className = 'row';
        div.innerHTML = `
            <div class="tools">
                <button class="tool-btn" onclick="moveRow(this, -1)">↑</button>
                <button class="tool-btn" onclick="moveRow(this, 1)">↓</button>
                <button class="tool-btn del" onclick="this.closest('.row').remove()">×</button>
            </div>
            <img src="${src}" class="img-layer">
            <div class="text-box-container" style="font-family:'${GLOBAL_DEFAULT_FONT}'">
                <div class="text-del-btn" title="删除文字框">×</div>
                <div class="blue-dot" title="拖动整体缩放"></div>
                ${createLineHtml("双击输入文字", 28)}
            </div>
        `;
        document.getElementById('canvas').appendChild(div);
        
        const container = div.querySelector('.text-box-container');
        bindContainerEvents(container);
        bindLineEvents(container.querySelector('.text-line'));
        div.scrollIntoView({behavior:'smooth'});
    }

    window.addFloatingText = function() {
        const canvas = document.getElementById('canvas');
        const rows = canvas.querySelectorAll('.row');
        if(rows.length === 0) {
            alert("请先添加图片作为底板");
            return;
        }

        let targetRow = rows[rows.length - 1];
        if(currentContainer) {
            const parentRow = currentContainer.closest('.row');
            if(parentRow) targetRow = parentRow;
        }

        const div = document.createElement('div');
        div.className = 'text-box-container';
        div.style.fontFamily = GLOBAL_DEFAULT_FONT;
        div.style.top = "50%";
        div.style.left = "50%";
        div.innerHTML = `
            <div class="text-del-btn" title="删除文字框">×</div>
            <div class="blue-dot" title="拖动整体缩放"></div>
            ${createLineHtml("新增文字", 28)}
        `;
        
        targetRow.appendChild(div);
        bindContainerEvents(div);
        bindLineEvents(div.querySelector('.text-line'));
        activateContainer(div);
    }

    function createLineHtml(text, size) {
        return `<div class="text-line"><span class="line-content" contenteditable="false" style="font-size: ${size}px;">${text}</span><div class="red-dot"></div></div>`;
    }

    function bindContainerEvents(container) {
        const blueDot = container.querySelector('.blue-dot');
        const delBtn = container.querySelector('.text-del-btn'); // V17 获取删除按钮
        let currentScale = 1;

        // 删除按钮点击事件
        if(delBtn) {
            delBtn.onmousedown = function(e) { e.stopPropagation(); } // 防止触发拖动
            delBtn.onclick = function(e) {
                e.stopPropagation();
                container.remove(); // 直接删除
                if(currentContainer === container) currentContainer = null;
            }
        }

        container.onmousedown = function(e) {
            if(e.target.classList.contains('blue-dot') || 
               e.target.classList.contains('red-dot') || 
               e.target.classList.contains('text-del-btn') || // 防止点击删除按钮时触发拖动
               e.target.isContentEditable) return;
            
            e.stopPropagation(); e.preventDefault();
            activateContainer(container);
            const startX = e.clientX, startY = e.clientY;
            const startL = container.offsetLeft, startT = container.offsetTop;
            const onMove = ev => {
                container.style.left = (startL + ev.clientX - startX) + 'px';
                container.style.top = (startT + ev.clientY - startY) + 'px';
            };
            const onUp = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
            window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
        };

        blueDot.onmousedown = function(e) {
            e.stopPropagation(); e.preventDefault();
            const startY = e.clientY;
            const startScale = currentScale;
            const onMove = ev => {
                const delta = (startY - ev.clientY) * 0.01;
                let newScale = Math.max(0.2, startScale + delta);
                currentScale = newScale;
                container.style.transform = `translate(-50%, -50%) scale(${newScale})`;
            };
            const onUp = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
            window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
        }
    }

    function bindLineEvents(lineDiv) {
        const content = lineDiv.querySelector('.line-content');
        const redDot = lineDiv.querySelector('.red-dot');

        content.ondblclick = function(e) {
            e.stopPropagation();
            if(this.innerText.includes("双击输入") || this.innerText === "新增文字") this.innerText = "";
            this.contentEditable = true;
            this.focus();
            activateContainer(lineDiv.closest('.text-box-container'));
        };

        content.onblur = function() { 
            this.contentEditable = false; 
            if(this.innerText.trim() === "") {
                this.innerText = "双击输入";
            }
        };

        content.onkeydown = function(e) {
            if(e.key === 'Enter') {
                e.preventDefault(); 
                const sel = window.getSelection();
                const range = sel.getRangeAt(0);
                const fullText = this.innerText;
                const cursorPos = range.startOffset;

                this.innerText = fullText.slice(0, cursorPos);
                const computedStyle = window.getComputedStyle(this);
                const currentSize = parseFloat(computedStyle.fontSize) || 28;
                
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = createLineHtml(fullText.slice(cursorPos), currentSize);
                const newLine = tempContainer.firstElementChild;
                
                lineDiv.after(newLine);
                bindLineEvents(newLine);

                const newContent = newLine.querySelector('.line-content');
                newContent.contentEditable = true;
                newContent.focus();
            }
            if(e.key === 'Backspace' && this.innerText === '' && lineDiv.parentNode.children.length > 2) {
                 e.preventDefault();
                 const prev = lineDiv.previousElementSibling;
                 if(prev && prev.classList.contains('text-line')) {
                     lineDiv.remove();
                     prev.querySelector('.line-content').focus();
                 }
            }
        };

        redDot.onmousedown = function(e) {
            e.stopPropagation(); e.preventDefault();
            const startX = e.clientX;
            const computedStyle = window.getComputedStyle(content);
            const startSize = parseFloat(computedStyle.fontSize) || 28;
            const onMove = ev => {
                const delta = (ev.clientX - startX);
                content.style.fontSize = Math.max(12, startSize + delta) + 'px';
            };
            const onUp = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
            window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
        };
    }

    function activateContainer(container) {
        if(currentContainer && currentContainer !== container) currentContainer.classList.remove('active');
        currentContainer = container;
        container.classList.add('active');
        
        const currentLH = container.style.lineHeight || 1.2;
        document.getElementById('lineHeightRange').value = currentLH;
        document.getElementById('lhValue').innerText = currentLH;
        
        const fontName = container.style.fontFamily.replace(/['"]/g, '');
        const sel = document.getElementById('fontSelect');
        for(let i=0; i<sel.options.length; i++) {
             if(sel.options[i].value === fontName) {
                 sel.value = fontName;
                 break;
             }
        }

        const bg = container.style.backgroundColor;
        if(bg && bg.includes('rgba')) {
            const parts = bg.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);
            if(parts) {
                const hex = "#" + ((1 << 24) + (parseInt(parts[1]) << 16) + (parseInt(parts[2]) << 8) + parseInt(parts[3])).toString(16).slice(1);
                document.getElementById('bgColor').value = hex;
                document.getElementById('bgOpacity').value = parts[4];
                document.getElementById('bgOpValue').innerText = parts[4];
            }
        } else if(bg === '' || bg === 'transparent') {
            document.getElementById('bgOpacity').value = 0;
            document.getElementById('bgOpValue').innerText = 0;
        }
    }

    function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    window.applyBackground = function() {
        if(!currentContainer) return;
        const color = document.getElementById('bgColor').value;
        const opacity = document.getElementById('bgOpacity').value;
        document.getElementById('bgOpValue').innerText = opacity;
        currentContainer.style.backgroundColor = hexToRgba(color, opacity);
    }

    window.updateGlobalFont = function() {
        const val = document.getElementById('fontSelect').value;
        GLOBAL_DEFAULT_FONT = val;
        localStorage.setItem('WECHAT_TOOL_FONT_PREF', val);
        if(currentContainer) currentContainer.style.fontFamily = GLOBAL_DEFAULT_FONT;
    }

    window.updateLineHeight = function(val) {
        document.getElementById('lhValue').innerText = val;
        if(currentContainer) currentContainer.style.lineHeight = val;
    }

    window.applyColor = function(val) { if(currentContainer) currentContainer.style.color = val; }
    window.applyBold = function() {
        if(currentContainer) currentContainer.style.fontWeight = currentContainer.style.fontWeight === 'bold' ? 'normal' : 'bold';
    }
    window.moveRow = function(btn, dir) {
        const row = btn.closest('.row');
        if(dir===-1 && row.previousElementSibling) row.parentNode.insertBefore(row, row.previousElementSibling);
        if(dir===1 && row.nextElementSibling) row.parentNode.insertBefore(row.nextElementSibling, row);
    }

    window.saveLongImage = function() {
        const btn = document.querySelector('.btn-save');
        btn.innerText = "生成中...";
        const canvasDiv = document.getElementById('canvas');
        if(currentContainer) currentContainer.classList.remove('active');
        
        // V17: 增加隐藏 text-del-btn，虽然 inactive 时本来就不显示，但为了保险起见
        const tools = document.createElement('style');
        tools.innerHTML = '.tools, .blue-dot, .red-dot, .text-del-btn { display: none !important; }';
        document.head.appendChild(tools);

        const originalMinHeight = canvasDiv.style.minHeight; 
        canvasDiv.style.minHeight = "0px";

        html2canvas(canvasDiv, {
            scale: 2, useCORS: true, 
            height: canvasDiv.scrollHeight, 
            windowHeight: canvasDiv.scrollHeight,
            scrollY: 0, backgroundColor: '#ffffff'
        }).then(cvs => {
            const a = document.createElement('a');
            a.download = '排版长图_' + Date.now() + '.jpg';
            a.href = cvs.toDataURL('image/jpeg', 0.9);
            a.click();
            btn.innerText = "保存长图";
            tools.remove();
            canvasDiv.style.minHeight = originalMinHeight;
        }).catch(() => {
            alert("保存失败，请检查图片跨域问题");
            btn.innerText = "保存长图";
            tools.remove();
            canvasDiv.style.minHeight = originalMinHeight;
        });
    };

    initDB();

</script>
</body>
</html>
