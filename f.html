<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€ç¬”ç¬‘ç”»åˆ¶ä½œå™¨ - V20 ä¸“ä¸šæ’ç‰ˆç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #07c160; --warning: #ff9c00; --gray: #f2f2f2; --blue: #1890ff; --dark: #333; }
        * { box-sizing: border-box; outline: none; user-select: none; }
        body { margin: 0; display: flex; height: 100vh; background: var(--gray); font-family: "Microsoft YaHei", sans-serif; overflow: hidden; }

        /* å·¦ä¾§è¾¹æ  */
        .sidebar { width: 340px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; z-index: 20; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        .sidebar-scroll { flex: 1; overflow-y: auto; padding: 15px; }
        .panel { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        h4 { margin: 0 0 10px 0; font-size: 14px; border-left: 3px solid var(--primary); padding-left: 8px; color: #333; display: flex; justify-content: space-between; align-items: center;}
        
        .undo-hint { font-size: 10px; color: #999; font-weight: normal; background: #eee; padding: 2px 6px; border-radius: 4px; }

        /* å›¾ç‰‡åº“ */
        .lib-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; min-height: 50px;}
        .lib-item { aspect-ratio: 1; background: #eee; cursor: pointer; border: 2px solid transparent; position: relative; }
        .lib-item:hover { border-color: var(--primary); }
        .lib-item.selecting { border-color: #fa5151; animation: blink 1s infinite; }
        .lib-item img { width: 100%; height: 100%; object-fit: cover; }
        .lib-del { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.5); color: white; width: 15px; height: 15px; font-size: 10px; display: none; text-align: center; line-height: 15px;}
        .lib-item:hover .lib-del { display: block; }

        /* å‰§æœ¬ç”ŸæˆåŒº */
        .role-setup { display: flex; gap: 10px; margin-bottom: 10px; }
        .role-box { flex: 1; border: 1px dashed #ccc; padding: 5px; text-align: center; cursor: pointer; border-radius: 4px; font-size: 12px; color: #666; position: relative;}
        .role-box:hover { background: #f9f9f9; }
        .role-box.waiting { border-color: #fa5151; background: #fff0f0; color: #fa5151; }
        .role-box img { width: 40px; height: 40px; object-fit: cover; display: block; margin: 0 auto 5px; background: #eee; }
        .role-box .clear-role { position: absolute; top: 0; right: 0; background: #ccc; color: white; width: 14px; height: 14px; line-height: 14px; display: none; }
        .role-box:hover .clear-role { display: block; }
        
        textarea#scriptInput { 
            width: 100%; height: 120px; border: 1px solid #ddd; border-radius: 4px; 
            padding: 8px; font-size: 12px; resize: vertical; user-select: text; outline: none;
        }

        /* æ§ä»¶ */
        .control-row { display: flex; align-items: center; margin-bottom: 12px; gap: 10px; }
        .control-row label { width: 60px; font-size: 12px; color: #666; text-align: right; }
        select, input[type=color], input[type=range] { flex: 1; height: 32px; border: 1px solid #ddd; border-radius: 4px; }
        .val-display { font-size: 12px; color: #666; width: 30px; text-align: right; }
        .btn { width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; background: #f0f0f0; margin-top: 5px; display: inline-block; text-align: center;}
        .btn:hover { background: #e0e0e0; }
        .btn-green { background: var(--primary); color: white; }
        .btn-green:hover { background: #06ad56; }
        .btn-blue { background: #1890ff; color: white; } 
        .btn-blue:hover { background: #096dd9; }
        .btn-save { height: 44px; font-size: 16px; font-weight: bold; background: #fa5151; color: white; margin: 15px; width: calc(100% - 30px); }

        /* å³ä¾§ç”»å¸ƒ */
        .main { flex: 1; background: var(--gray); display: flex; flex-direction: column; align-items: center; overflow-y: auto; padding: 40px; position: relative; }
        #canvas { 
            background: white; width: 100%; max-width: 600px; 
            min-height: 400px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            height: fit-content; 
            position: relative;
            padding-bottom: 40px;
        }

        /* è¡Œæ ·å¼ */
        .row { position: relative; width: 100%; line-height: 0; border: 2px solid transparent; transition: border-color 0.2s; }
        .row.waiting-insert { border-color: var(--warning); box-shadow: 0 0 10px rgba(255, 156, 0, 0.3); z-index: 10; }
        .row.waiting-insert::after {
            content: "ğŸ‘‡ è¯·ç‚¹å‡»å·¦ä¾§å›¾ç‰‡åº“æ’å…¥";
            position: absolute; bottom: -24px; left: 50%; transform: translateX(-50%);
            background: var(--warning); color: white; font-size: 12px; padding: 2px 8px;
            border-radius: 0 0 4px 4px; pointer-events: none; line-height: 20px; z-index: 20;
        }

        /* é¡¶éƒ¨å·¥å…·æ  (æ•´åˆç‰ˆ) */
        .tools { position: absolute; top: 0; right: 0; display: flex; opacity: 0; z-index: 100; background: rgba(0,0,0,0.6); border-bottom-left-radius: 4px; padding: 0 4px; height: 32px; align-items: center;}
        .row:hover .tools { opacity: 1; }
        
        .tool-btn { 
            width: 28px; height: 28px; border: none; background: transparent; color: white; 
            cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; font-size: 16px;
            margin: 0 1px; border-radius: 2px;
        }
        .tool-btn:hover { background: rgba(255,255,255,0.3); }
        .tool-btn.del:hover { background: #fa5151; }
        
        /* ç‰¹æ®ŠæŒ‰é’®é¢œè‰² */
        .tool-btn.btn-plus { color: #52c41a; font-size: 20px; }
        .tool-btn.btn-gear { color: #1890ff; font-size: 16px; }
        .tool-btn.btn-text { color: #faad14; font-size: 14px; font-weight: 800; font-family: serif; }
        
        /* æ¿€æ´»ç¼–è¾‘æ¨¡å¼æ—¶çš„æŒ‰é’®çŠ¶æ€ */
        .tool-btn.active { background: #1890ff; color: white; }


        /* === V20 å›¾ç‰‡å®¹å™¨æ ¸å¿ƒ === */
        .img-container {
            width: 100%;
            position: relative;
            display: flex;
            justify-content: center; /* é»˜è®¤å±…ä¸­ */
            align-items: center;
        }
        
        .img-wrapper-inner {
            position: relative;
            display: inline-block; /* éšå›¾ç‰‡å¤§å°å˜åŒ– */
            line-height: 0;
            width: 100%; /* é»˜è®¤æ’‘æ»¡ */
            /* å…³é”®ï¼šä½¿ç”¨ margin æ¥ç§»åŠ¨ï¼Œå®ç°â€œå ä½è·Ÿéšâ€ */
            margin: 0; 
            transition: box-shadow 0.2s;
        }
        
        .img-layer {
            width: 100%; 
            height: auto;
            pointer-events: none;
            display: block;
        }

        /* ç¼–è¾‘æ¨¡å¼æ ·å¼ */
        .img-wrapper-inner.editing {
            outline: 2px solid var(--blue);
            cursor: move;
            z-index: 90;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .img-wrapper-inner.editing .img-layer { pointer-events: none; } /* ç¼–è¾‘æ—¶å›¾ç‰‡ä¸å“åº”ï¼Œè®© wrapper å“åº” */
        
        /* å››è§’æ‰‹æŸ„ */
        .resize-handle {
            position: absolute; width: 14px; height: 14px;
            background: #07c160; border: 2px solid white; border-radius: 50%;
            z-index: 95; display: none;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        .img-wrapper-inner.editing .resize-handle { display: block; }
        
        .rh-tl { top: -7px; left: -7px; cursor: nwse-resize; }
        .rh-tr { top: -7px; right: -7px; cursor: nesw-resize; }
        .rh-bl { bottom: -7px; left: -7px; cursor: nesw-resize; }
        .rh-br { bottom: -7px; right: -7px; cursor: nwse-resize; }


        /* æ–‡å­—æ¡†æ ·å¼ */
        .text-box-container {
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) scale(1);
            transform-origin: center center;
            z-index: 50;
            cursor: move; 
            padding: 4px;
            border: 1px dashed transparent;
            line-height: 1.2; 
            border-radius: 4px;
        }
        .text-box-container.active { outline: 1px solid #1890ff; }
        .blue-dot {
            position: absolute; top: -6px; right: -6px;
            width: 14px; height: 14px; border-radius: 50%;
            background: #1890ff; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: ne-resize; display: none; z-index: 60;
        }
        .text-box-container.active .blue-dot { display: block; }
        .text-del-btn {
            position: absolute; top: -8px; left: -8px;
            width: 16px; height: 16px; border-radius: 50%;
            background: #fa5151; color: white; border: 2px solid white;
            font-size: 12px; line-height: 12px; text-align: center;
            cursor: pointer; display: none; z-index: 65;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-weight: bold;
        }
        .text-del-btn:hover { background: red; transform: scale(1.1); }
        .text-box-container.active .text-del-btn { display: block; }
        .text-line {
            position: relative; 
            white-space: nowrap; 
            margin: 0; padding: 0 4px; min-height: 20px;
            border: 1px solid transparent; display: block; width: fit-content;
        }
        .text-line:hover { border-color: rgba(0,0,0,0.1); }
        .line-content { display: inline-block; outline: none; user-select: text; cursor: text; }
        .red-dot {
            position: absolute; top: 50%; right: -10px; transform: translateY(-50%);
            width: 10px; height: 10px; border-radius: 50%;
            background: #ff4d4f; border: 1px solid white;
            cursor: ew-resize; display: none; z-index: 70; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .text-line:hover .red-dot { display: block; }

        #dbStatus { font-size: 12px; color: #999; text-align: center; margin-top: 5px; }
        #uploadStatus { font-size: 12px; color: #1890ff; text-align: center; display: none; }
        @keyframes blink { 50% { border-color: transparent; } }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-scroll">
        <!-- 0. å‰§æœ¬ä¸€é”®ç”Ÿæˆ -->
        <div class="panel">
            <h4>ğŸ­ å‰§æœ¬ä¸€é”®ç”Ÿæˆ <span class="undo-hint">æ”¯æŒ Ctrl+Z æ’¤é”€</span></h4>
            <div style="font-size:12px; color:#666; margin-bottom:5px;">ç¬¬ä¸€æ­¥ï¼šç‚¹å‡»ä¸‹æ–¹æ–¹æ¡†ï¼Œè®¾å®šç”·å¥³ä¸»è§’å›¾</div>
            
            <div class="role-setup">
                <div class="role-box" id="roleBoxA" onclick="startSelectRole('ç”·')">
                    <div class="clear-role" onclick="clearRole('ç”·', event)">Ã—</div>
                    <img src="" style="display:none" id="imgRoleA">
                    <span id="txtRoleA">ç‚¹å‡»è®¾ç½®<br><b>ç”·ä¸»å›¾</b></span>
                </div>
                <div class="role-box" id="roleBoxB" onclick="startSelectRole('å¥³')">
                    <div class="clear-role" onclick="clearRole('å¥³', event)">Ã—</div>
                    <img src="" style="display:none" id="imgRoleB">
                    <span id="txtRoleB">ç‚¹å‡»è®¾ç½®<br><b>å¥³ä¸»å›¾</b></span>
                </div>
            </div>

            <div style="font-size:12px; color:#666; margin-bottom:5px;">ç¬¬äºŒæ­¥ï¼šç²˜è´´å¯¹è¯ (æ ¼å¼: ç”·ï¼šå†…å®¹ / å¥³ï¼šå†…å®¹)</div>
            <textarea id="scriptInput" placeholder="ä¾‹å¦‚ï¼š
ç”·ï¼šä»Šå¤©åƒä»€ä¹ˆï¼Ÿ
å¥³ï¼šéšä¾¿ã€‚
ç”·ï¼šé‚£åƒç«é”…å§ã€‚
å¥³ï¼šä¸è¡Œï¼Œé•¿ç—˜ã€‚"></textarea>
            <button class="btn btn-blue" onclick="generateFromScript()">ğŸš€ ä¸€é”®ç”Ÿæˆé•¿å›¾</button>
        </div>

        <!-- 1. ç´ æ -->
        <div class="panel">
            <h4>å›¾ç‰‡åº“ (ç‚¹å‡»ä½¿ç”¨)</h4>
            <div class="lib-grid" id="libGrid"></div>
            <label class="btn btn-green">
                + æ‰¹é‡ä¸Šä¼ å›¾ç‰‡
                <input type="file" id="uploadImg" accept="image/*" multiple style="position:absolute; width:1px; height:1px; opacity:0;">
            </label>
            <div id="uploadStatus">æ­£åœ¨å¤„ç†...</div>
            <div id="dbStatus">æ­£åœ¨è¿æ¥æ•°æ®åº“...</div>
        </div>

        <!-- 2. å­—ä½“ä¸æ’ç‰ˆ -->
        <div class="panel">
            <h4>å­—ä½“ä¸æ’ç‰ˆ</h4>
            
            <button class="btn" onclick="addFloatingText()" style="margin-bottom:12px; border:1px dashed #999;">
                + æ·»åŠ ç‹¬ç«‹æ–‡å­—æ¡† (åˆ°åº•éƒ¨)
            </button>

            <div class="control-row">
                <label>é€‰æ‹©å­—ä½“</label>
                <select id="fontSelect" onchange="updateGlobalFont()">
                    <option value="Microsoft YaHei">å¾®è½¯é›…é»‘</option>
                    <option value="SimHei">é»‘ä½“</option>
                    <option value="Arial">Arial</option>
                </select>
            </div>
            
            <label class="btn" style="text-align:center; display:block; margin-bottom:15px;">
                ğŸ“‚ ä¸Šä¼ å­—ä½“ (è‡ªåŠ¨è®¾ä¸ºé»˜è®¤)
                <input type="file" id="uploadFont" accept=".ttf,.otf,.woff" style="display:none">
            </label>

            <div class="control-row">
                <label>è¡Œé—´è·</label>
                <input type="range" id="lineHeightRange" min="0.8" max="2.5" step="0.1" value="1.2" oninput="saveState(); updateLineHeight(this.value)">
                <span class="val-display" id="lhValue">1.2</span>
            </div>

            <div class="control-row">
                <label>å­—è‰²</label>
                <input type="color" id="fontColor" value="#000000" onchange="saveState()" oninput="applyColor(this.value)">
            </div>

            <div class="control-row">
                <label>èƒŒæ™¯è‰²</label>
                <input type="color" id="bgColor" value="#ffffff" onchange="saveState()" oninput="applyBackground()">
            </div>
            <div class="control-row">
                <label>èƒŒæ™¯é€æ˜</label>
                <input type="range" id="bgOpacity" min="0" max="1" step="0.05" value="0" onchange="saveState()" oninput="applyBackground()">
                <span class="val-display" id="bgOpValue">0</span>
            </div>

            <div class="control-row">
                <label>åŠ ç²—</label>
                <button class="btn" onclick="applyBold()" style="margin-top:0">B åŠ ç²—</button>
            </div>
        </div>
    </div>
    <button class="btn btn-save" onclick="saveLongImage()">ä¿å­˜é•¿å›¾</button>
</div>

<div class="main">
    <div id="canvas"></div>
    <div style="height:50px;"></div>
</div>

<script>
    // === å…¨å±€çŠ¶æ€ ===
    let GLOBAL_DEFAULT_FONT = 'Microsoft YaHei'; 
    let currentContainer = null; 
    let roleImages = { 'ç”·': null, 'å¥³': null };
    let isSelectingRole = null; 
    let insertAfterRowElement = null; 

    // æ’¤é”€å†å²
    let historyStack = [];
    const MAX_HISTORY = 20;

    const SAVED_FONT = localStorage.getItem('WECHAT_TOOL_FONT_PREF');
    if(SAVED_FONT) {
        GLOBAL_DEFAULT_FONT = SAVED_FONT;
        const sel = document.getElementById('fontSelect');
        if(Array.from(sel.options).some(opt => opt.value === SAVED_FONT)) {
            sel.value = SAVED_FONT;
        }
    }

    // === å…¨å±€ç‚¹å‡»ï¼šé€€å‡ºå›¾ç‰‡ç¼–è¾‘æ¨¡å¼ ===
    document.addEventListener('mousedown', function(e) {
        // ç‚¹å‡»ç©ºç™½å¤„é€€å‡ºç¼–è¾‘
        const editingWrapper = document.querySelector('.img-wrapper-inner.editing');
        const toolsBar = e.target.closest('.tools');
        
        // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯æ­£åœ¨ç¼–è¾‘çš„å›¾ç‰‡å†…éƒ¨ï¼Œä¹Ÿä¸æ˜¯å·¥å…·æ æŒ‰é’®
        if(editingWrapper && !editingWrapper.contains(e.target) && !toolsBar) {
            // å–æ¶ˆç¼–è¾‘çŠ¶æ€
            editingWrapper.classList.remove('editing');
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const activeBtn = document.querySelector('.tool-btn.active');
            if(activeBtn) activeBtn.classList.remove('active');
        }
    });

    // === æ’¤é”€åŠŸèƒ½ ===
    function saveState() {
        const canvas = document.getElementById('canvas');
        const snapshot = canvas.innerHTML;
        if(historyStack.length > 0 && historyStack[historyStack.length - 1] === snapshot) return;
        historyStack.push(snapshot);
        if(historyStack.length > MAX_HISTORY) historyStack.shift();
    }

    function undo() {
        if(historyStack.length === 0) return;
        const prevHtml = historyStack.pop();
        const canvas = document.getElementById('canvas');
        if(canvas.innerHTML === prevHtml && historyStack.length > 0) {
            canvas.innerHTML = historyStack.pop();
        } else {
            canvas.innerHTML = prevHtml;
        }
        rebindAllEvents();
        currentContainer = null; 
        insertAfterRowElement = null; 
    }

    function rebindAllEvents() {
        document.querySelectorAll('.row').forEach(row => {
            // é‡æ–°ç»‘å®šå›¾ç‰‡äº‹ä»¶
            const imgWrapper = row.querySelector('.img-wrapper-inner');
            const imgContainer = row.querySelector('.img-container');
            if(imgWrapper && imgContainer) bindImageEvents(imgContainer, imgWrapper, row);

            // é‡æ–°ç»‘å®šæ–‡å­—äº‹ä»¶
            const container = row.querySelector('.text-box-container');
            if(container) {
                bindContainerEvents(container);
                container.querySelectorAll('.text-line').forEach(line => bindLineEvents(line));
            }
        });
        
        // ç»‘å®šç‹¬ç«‹æ–‡å­—æ¡†
        document.querySelectorAll('#canvas > .text-box-container').forEach(container => {
             bindContainerEvents(container);
             container.querySelectorAll('.text-line').forEach(line => bindLineEvents(line));
        });
    }

    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
            e.preventDefault();
            undo();
        }
    });


    // === æ•°æ®åº“åˆå§‹åŒ– (ä¿æŒä¸å˜) ===
    const DB_NAME = "WeChatToolDB_V14"; 
    let db = null;
    function initDB() {
        try {
            const req = indexedDB.open(DB_NAME, 1);
            req.onupgradeneeded = e => {
                db = e.target.result;
                if(!db.objectStoreNames.contains('images')) db.createObjectStore('images', { keyPath: 'id', autoIncrement:true });
                if(!db.objectStoreNames.contains('fonts')) db.createObjectStore('fonts', { keyPath: 'name' });
            };
            req.onsuccess = e => {
                db = e.target.result;
                document.getElementById('dbStatus').innerText = "âœ… æ•°æ®åº“å°±ç»ª";
                loadImages();
                loadFonts(); 
            };
            req.onerror = e => { document.getElementById('dbStatus').innerText = "âŒ æ•°æ®åº“é”™è¯¯"; };
        } catch(err) { alert("æµè§ˆå™¨ä¸æ”¯æŒæ•°æ®åº“"); }
    }

    // === å›¾ç‰‡é€»è¾‘ ===
    document.getElementById('uploadImg').onchange = function(e) {
        if(!db) { alert("æ•°æ®åº“æœªå°±ç»ª"); return; }
        const files = Array.from(e.target.files);
        if(files.length === 0) return;
        
        const statusDiv = document.getElementById('uploadStatus');
        statusDiv.style.display = 'block';
        statusDiv.innerText = `æ­£åœ¨è¯»å– ${files.length} å¼ å›¾ç‰‡...`;

        const promises = files.map(file => new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = ev => resolve(ev.target.result);
            reader.onerror = () => resolve(null);
            reader.readAsDataURL(file);
        }));

        Promise.all(promises).then(dataUrls => {
            const tx = db.transaction('images', 'readwrite');
            dataUrls.forEach(url => { if(url) tx.objectStore('images').add({ data: url }); });
            tx.oncomplete = () => {
                loadImages();
                statusDiv.style.display = 'none';
                document.getElementById('uploadImg').value = ''; 
            };
        });
    };

    function loadImages() {
        if(!db) return;
        const grid = document.getElementById('libGrid');
        grid.innerHTML = "";
        db.transaction('images', 'readonly').objectStore('images').getAll().onsuccess = e => {
            e.target.result.forEach(item => {
                const div = document.createElement('div');
                div.className = 'lib-item';
                div.innerHTML = `<img src="${item.data}"><div class="lib-del" onclick="delImg(${item.id}, event)">Ã—</div>`;
                div.onclick = (evt) => { 
                    if(evt.target.className === 'lib-del') return;
                    if(isSelectingRole) {
                        setRoleImage(isSelectingRole, item.data);
                    } else if (insertAfterRowElement) {
                        saveState(); 
                        addRow(item.data, null, insertAfterRowElement);
                        insertAfterRowElement.classList.remove('waiting-insert');
                        insertAfterRowElement = null;
                        document.querySelectorAll('.lib-item').forEach(el => el.classList.remove('selecting'));
                    } else {
                        saveState(); 
                        addRow(item.data); // V20: é»˜è®¤åªåŠ å›¾ç‰‡ï¼Œä¸åŠ æ–‡å­—
                    }
                };
                grid.appendChild(div);
            });
        };
    }

    window.delImg = (id, e) => {
        e.stopPropagation();
        if(confirm('ç¡®å®šåˆ é™¤?')) {
            const tx = db.transaction('images', 'readwrite');
            tx.objectStore('images').delete(id);
            tx.oncomplete = loadImages;
        }
    };

    window.toggleInsertMode = function(btn) {
        const row = btn.closest('.row');
        if(insertAfterRowElement === row) {
            insertAfterRowElement = null;
            row.classList.remove('waiting-insert');
            document.querySelectorAll('.lib-item').forEach(el => el.classList.remove('selecting'));
            return;
        }
        if(insertAfterRowElement) insertAfterRowElement.classList.remove('waiting-insert');
        insertAfterRowElement = row;
        row.classList.add('waiting-insert');
        document.querySelectorAll('.lib-item').forEach(el => el.classList.add('selecting'));
    }

    // === è§’è‰²è®¾å®š ===
    window.startSelectRole = function(role) {
        if(roleImages[role] && !isSelectingRole) return; 
        if(insertAfterRowElement) {
            insertAfterRowElement.classList.remove('waiting-insert');
            insertAfterRowElement = null;
        }
        isSelectingRole = role;
        document.getElementById('roleBoxA').classList.remove('waiting');
        document.getElementById('roleBoxB').classList.remove('waiting');
        const box = role === 'ç”·' ? document.getElementById('roleBoxA') : document.getElementById('roleBoxB');
        box.classList.add('waiting');
        document.querySelectorAll('.lib-item').forEach(el => el.classList.add('selecting'));
    }

    function setRoleImage(role, src) {
        roleImages[role] = src;
        const box = role === 'ç”·' ? document.getElementById('roleBoxA') : document.getElementById('roleBoxB');
        const img = role === 'ç”·' ? document.getElementById('imgRoleA') : document.getElementById('imgRoleB');
        const txt = role === 'ç”·' ? document.getElementById('txtRoleA') : document.getElementById('txtRoleB');
        img.src = src; img.style.display = 'block'; txt.style.display = 'none';
        box.classList.remove('waiting');
        isSelectingRole = null;
        document.querySelectorAll('.lib-item').forEach(el => el.classList.remove('selecting'));
    }

    window.clearRole = function(role, e) {
        e.stopPropagation();
        roleImages[role] = null;
        const img = role === 'ç”·' ? document.getElementById('imgRoleA') : document.getElementById('imgRoleB');
        const txt = role === 'ç”·' ? document.getElementById('txtRoleA') : document.getElementById('txtRoleB');
        img.style.display = 'none'; img.src = ''; txt.style.display = 'inline';
        if(isSelectingRole === role) {
             isSelectingRole = null;
             document.getElementById(role==='ç”·'?'roleBoxA':'roleBoxB').classList.remove('waiting');
             document.querySelectorAll('.lib-item').forEach(el => el.classList.remove('selecting'));
        }
    }

    // === å‰§æœ¬ç”Ÿæˆ ===
    window.generateFromScript = function() {
        if(!roleImages['ç”·'] || !roleImages['å¥³']) {
            alert("è¯·å…ˆè®¾ç½®ç”·ä¸»å’Œå¥³ä¸»çš„å›¾ç‰‡ï¼");
            return;
        }
        const text = document.getElementById('scriptInput').value;
        if(!text.trim()) { alert("è¯·å…ˆç²˜è´´å‰§æœ¬ï¼"); return; }
        saveState(); 

        const lines = text.split('\n');
        let count = 0;
        lines.forEach(line => {
            line = line.trim();
            if(!line) return;
            let imgSrc = null;
            let content = "";
            if(line.startsWith("ç”·") || line.startsWith("A")) {
                imgSrc = roleImages['ç”·'];
                content = line.replace(/^(ç”·|A)[:ï¼š]\s*/i, '');
            } else if (line.startsWith("å¥³") || line.startsWith("B")) {
                imgSrc = roleImages['å¥³'];
                content = line.replace(/^(å¥³|B)[:ï¼š]\s*/i, '');
            }
            if(imgSrc) {
                if(!content) content = " "; 
                addRow(imgSrc, content); // ç”Ÿæˆå‰§æœ¬æ—¶å¸¦æœ‰æ–‡å­—
                count++;
            }
        });
        if(count > 0) document.querySelector('.main').scrollTop = 0;
        else alert("æœªè¯†åˆ«åˆ°æœ‰æ•ˆå¯¹è¯ã€‚");
    }

    // === å­—ä½“å¤„ç† ===
    document.getElementById('uploadFont').onchange = async function(e) { 
        const file = e.target.files[0]; if(!file) return;
        const btn = this.parentElement; const oldText = btn.innerText;
        btn.firstChild.textContent = "å¤„ç†ä¸­...";
        try {
            const buffer = await file.arrayBuffer();
            const name = file.name.replace(/\.[^/.]+$/, "");
            const tx = db.transaction('fonts', 'readwrite');
            tx.objectStore('fonts').put({ name: name, buffer: buffer });
            tx.oncomplete = () => { registerFont(name, buffer, true); btn.firstChild.textContent = oldText; this.value = ''; };
        } catch(err) { alert("å­—ä½“è¯»å–å¤±è´¥"); btn.firstChild.textContent = oldText; }
    };
    function loadFonts() { if(!db) return; db.transaction('fonts', 'readonly').objectStore('fonts').getAll().onsuccess = e => e.target.result.forEach(f => registerFont(f.name, f.buffer, false)); }
    function registerFont(name, buffer, isNew) {
        try { new FontFace(name, buffer).load().then(f => {
                document.fonts.add(f);
                const sel = document.getElementById('fontSelect');
                let exists = false; for(let i=0; i<sel.options.length; i++) if(sel.options[i].value === name) exists = true;
                if(!exists) { const opt = document.createElement('option'); opt.value = name; opt.text = "è‡ªå®šä¹‰: " + name; sel.insertBefore(opt, sel.children[0]); }
                if(isNew || name === localStorage.getItem('WECHAT_TOOL_FONT_PREF')) { sel.value = name; updateGlobalFont(); }
            }); } catch(err) { console.error(err); }
    }

    // === V20 æ ¸å¿ƒï¼šå›¾ç‰‡æ’ç‰ˆé€»è¾‘ ===
    window.toggleImgEdit = function(btn) {
        saveState();
        const row = btn.closest('.row');
        const wrapper = row.querySelector('.img-wrapper-inner');
        
        // å¦‚æœå·²ç»æ˜¯ç¼–è¾‘çŠ¶æ€ï¼Œå°±å…³é—­
        if(wrapper.classList.contains('editing')) {
            wrapper.classList.remove('editing');
            btn.classList.remove('active');
        } else {
            // æ¸…é™¤å…¶ä»–ç¼–è¾‘çŠ¶æ€
            document.querySelectorAll('.img-wrapper-inner.editing').forEach(el => el.classList.remove('editing'));
            document.querySelectorAll('.tool-btn.active').forEach(el => el.classList.remove('active'));
            
            wrapper.classList.add('editing');
            btn.classList.add('active');
        }
    }
    
    window.addTextToRow = function(btn) {
        saveState();
        const row = btn.closest('.row');
        // æ·»åŠ æ–‡å­—æ¡†åˆ°è¯¥è¡Œ
        const div = document.createElement('div');
        div.className = 'text-box-container';
        div.style.fontFamily = GLOBAL_DEFAULT_FONT;
        div.style.top = "50%"; div.style.left = "50%";
        div.innerHTML = `<div class="text-del-btn">Ã—</div><div class="blue-dot"></div>${createLineHtml("æ–°å¢æ–‡å­—", 28)}`;
        row.appendChild(div); // æŒ‚åœ¨ row ä¸‹
        bindContainerEvents(div);
        bindLineEvents(div.querySelector('.text-line'));
        activateContainer(div);
    }

    function bindImageEvents(container, wrapper, row) {
        // 1. æ‹–åŠ¨ä½ç½® (ä½¿ç”¨ margin)
        wrapper.onmousedown = function(e) {
            if(!wrapper.classList.contains('editing')) return;
            // å¦‚æœç‚¹çš„æ˜¯æ‰‹æŸ„ï¼Œä¸è§¦å‘æ‹–åŠ¨
            if(e.target.classList.contains('resize-handle')) return;
            
            e.stopPropagation(); e.preventDefault();
            saveState();

            const startX = e.clientX, startY = e.clientY;
            const style = window.getComputedStyle(wrapper);
            const startML = parseFloat(style.marginLeft) || 0;
            const startMT = parseFloat(style.marginTop) || 0;

            const onMove = ev => {
                const dx = ev.clientX - startX;
                const dy = ev.clientY - startY;
                wrapper.style.marginLeft = (startML + dx) + 'px';
                wrapper.style.marginTop = (startMT + dy) + 'px';
            };
            const onUp = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
            window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
        };

        // 2. ç¼©æ”¾é€»è¾‘ (æ”¹å˜ width %)
        const setupHandle = (className, type) => {
            const handle = wrapper.querySelector('.' + className);
            handle.onmousedown = function(e) {
                e.stopPropagation(); e.preventDefault();
                saveState();
                
                const startX = e.clientX;
                const startWidth = wrapper.getBoundingClientRect().width;
                const containerWidth = container.getBoundingClientRect().width;
                
                const onMove = ev => {
                    const deltaX = ev.clientX - startX;
                    let change = 0;
                    
                    // æ ¹æ®ä¸åŒè§’ï¼Œå†³å®šæ‹–åŠ¨æ–¹å‘å¯¹å®½åº¦çš„å½±å“
                    if(type === 'right') change = deltaX; // å¾€å³æ‹–å˜å¤§
                    else change = -deltaX; // å¾€å·¦æ‹–å˜å¤§
                    
                    let newWidthPx = startWidth + change;
                    let newPercent = (newWidthPx / containerWidth) * 100;
                    newPercent = Math.min(100, Math.max(5, newPercent)); // 5% - 100%
                    
                    wrapper.style.width = newPercent + '%';
                };
                const onUp = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
                window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
            }
        };

        setupHandle('rh-br', 'right');
        setupHandle('rh-tr', 'right');
        setupHandle('rh-bl', 'left');
        setupHandle('rh-tl', 'left');
    }


    // === æ ¸å¿ƒé€»è¾‘ ===
    function addRow(src, initialText = null, insertAfterNode = null) {
        const div = document.createElement('div');
        div.className = 'row';

        // V20 å·¥å…·æ ï¼šä¸Š | ä¸‹ | + | é½¿è½® | T | X
        div.innerHTML = `
            <div class="tools">
                <button class="tool-btn" onclick="moveRow(this, -1)" title="ä¸Šç§»">â†‘</button>
                <button class="tool-btn" onclick="moveRow(this, 1)" title="ä¸‹ç§»">â†“</button>
                <button class="tool-btn btn-plus" onclick="toggleInsertMode(this)" title="åœ¨æ­¤è¡Œä¸‹æ–¹æ’å…¥å›¾ç‰‡">+</button>
                <button class="tool-btn btn-gear" onclick="toggleImgEdit(this)" title="ç¼–è¾‘å›¾ç‰‡(ç¼©æ”¾/ç§»åŠ¨)">âš™ï¸</button>
                <button class="tool-btn btn-text" onclick="addTextToRow(this)" title="æ·»åŠ æ–‡å­—">T</button>
                <button class="tool-btn del" onclick="deleteRow(this)" title="åˆ é™¤æ­¤è¡Œ">Ã—</button>
            </div>
            
            <div class="img-container">
                <div class="img-wrapper-inner" style="width: 100%;">
                    <img src="${src}" class="img-layer">
                    <div class="resize-handle rh-tl"></div>
                    <div class="resize-handle rh-tr"></div>
                    <div class="resize-handle rh-bl"></div>
                    <div class="resize-handle rh-br"></div>
                </div>
            </div>
        `;

        const canvas = document.getElementById('canvas');
        if(insertAfterNode && insertAfterNode.nextSibling) canvas.insertBefore(div, insertAfterNode.nextSibling);
        else canvas.appendChild(div);
        
        // å¦‚æœæœ‰åˆå§‹æ–‡å­—ï¼ˆå‰§æœ¬æ¨¡å¼ï¼‰ï¼Œåˆ™æ·»åŠ æ–‡å­—æ¡†
        if(initialText !== null) {
             const txtDiv = document.createElement('div');
             txtDiv.className = 'text-box-container';
             txtDiv.style.fontFamily = GLOBAL_DEFAULT_FONT;
             txtDiv.style.top = "50%"; txtDiv.style.left = "50%";
             txtDiv.innerHTML = `<div class="text-del-btn">Ã—</div><div class="blue-dot"></div>${createLineHtml(initialText, 28)}`;
             div.appendChild(txtDiv);
             bindContainerEvents(txtDiv);
             bindLineEvents(txtDiv.querySelector('.text-line'));
        }

        // ç»‘å®šå›¾ç‰‡äº‹ä»¶
        bindImageEvents(div.querySelector('.img-container'), div.querySelector('.img-wrapper-inner'), div);
        
        if(initialText === null && !insertAfterNode) div.scrollIntoView({behavior:'smooth'});
    }
    
    window.deleteRow = function(btn) { saveState(); btn.closest('.row').remove(); }
    window.moveRow = function(btn, dir) { saveState(); const row = btn.closest('.row'); if(dir===-1 && row.previousElementSibling) row.parentNode.insertBefore(row, row.previousElementSibling); if(dir===1 && row.nextElementSibling) row.parentNode.insertBefore(row.nextElementSibling, row); }

    window.addFloatingText = function() {
        // è¿™æ˜¯ä¸€ä¸ªâ€œæ·»åŠ åˆ°æœ€åä¸€è¡Œâ€çš„å¿«æ·æ–¹å¼
        const canvas = document.getElementById('canvas');
        const rows = canvas.querySelectorAll('.row');
        if(rows.length === 0) { alert("è¯·å…ˆæ·»åŠ å›¾ç‰‡"); return; }
        let targetRow = rows[rows.length - 1];
        if(currentContainer) { const parentRow = currentContainer.closest('.row'); if(parentRow) targetRow = parentRow; }
        
        // å¤ç”¨ addTextToRow çš„é€»è¾‘ï¼Œè¿™é‡Œéœ€è¦æ„é€ ä¸€ä¸ªä¼ªå¯¹è±¡æˆ–è€…ç›´æ¥è°ƒé€»è¾‘
        const div = document.createElement('div');
        div.className = 'text-box-container';
        div.style.fontFamily = GLOBAL_DEFAULT_FONT; div.style.top = "50%"; div.style.left = "50%";
        div.innerHTML = `<div class="text-del-btn">Ã—</div><div class="blue-dot"></div>${createLineHtml("æ–°å¢æ–‡å­—", 28)}`;
        targetRow.appendChild(div);
        bindContainerEvents(div); bindLineEvents(div.querySelector('.text-line')); activateContainer(div);
    }
    function createLineHtml(text, size) { return `<div class="text-line"><span class="line-content" contenteditable="false" style="font-size: ${size}px;">${text}</span><div class="red-dot"></div></div>`; }

    // === æ–‡å­—æ¡†äº‹ä»¶ç»‘å®š (ä¿æŒåŸé€»è¾‘) ===
    function bindContainerEvents(container) {
        const blueDot = container.querySelector('.blue-dot');
        const delBtn = container.querySelector('.text-del-btn'); 
        let currentScale = 1;
        if(delBtn) { delBtn.onmousedown = e => e.stopPropagation(); delBtn.onclick = e => { e.stopPropagation(); saveState(); container.remove(); if(currentContainer === container) currentContainer = null; } }
        container.onmousedown = function(e) {
            if(e.target.classList.contains('blue-dot') || e.target.classList.contains('red-dot') || e.target.classList.contains('text-del-btn') || e.target.isContentEditable) return;
            e.stopPropagation(); e.preventDefault(); activateContainer(container);
            const startHtml = document.getElementById('canvas').innerHTML;
            const startX = e.clientX, startY = e.clientY;
            const startL = container.offsetLeft, startT = container.offsetTop;
            let hasMoved = false;
            const onMove = ev => { hasMoved = true; container.style.left = (startL + ev.clientX - startX) + 'px'; container.style.top = (startT + ev.clientY - startY) + 'px'; };
            const onUp = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); if(hasMoved && (historyStack.length===0 || historyStack[historyStack.length-1]!==startHtml)) { historyStack.push(startHtml); if(historyStack.length > MAX_HISTORY) historyStack.shift(); } };
            window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
        };
        blueDot.onmousedown = function(e) {
            e.stopPropagation(); e.preventDefault();
            const startHtml = document.getElementById('canvas').innerHTML; if(historyStack.length===0 || historyStack[historyStack.length-1]!==startHtml) { historyStack.push(startHtml); if(historyStack.length > MAX_HISTORY) historyStack.shift(); }
            const startY = e.clientY;
            const transform = container.style.transform; const match = transform.match(/scale\(([\d.]+)\)/); let baseScale = match ? parseFloat(match[1]) : 1;
            const onMove = ev => { const delta = (startY - ev.clientY) * 0.01; let newScale = Math.max(0.2, baseScale + delta); container.style.transform = `translate(-50%, -50%) scale(${newScale})`; };
            const onUp = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
            window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
        }
    }

    function bindLineEvents(lineDiv) {
        const content = lineDiv.querySelector('.line-content');
        const redDot = lineDiv.querySelector('.red-dot');
        content.ondblclick = function(e) { e.stopPropagation(); if(this.innerText.match(/åŒå‡»è¾“å…¥|æ–°å¢æ–‡å­—/)) this.innerText = ""; this.contentEditable = true; this.focus(); activateContainer(lineDiv.closest('.text-box-container')); };
        content.onblur = function() { this.contentEditable = false; if(this.innerText.trim() === "") this.innerText = "åŒå‡»è¾“å…¥æ–‡å­—"; };
        content.onfocus = () => saveState();
        content.onkeydown = function(e) {
            if(e.key === 'Enter') { e.preventDefault(); saveState(); const sel = window.getSelection(); const range = sel.getRangeAt(0); const fullText = this.innerText; const cursorPos = range.startOffset; this.innerText = fullText.slice(0, cursorPos); const size = parseFloat(window.getComputedStyle(this).fontSize)||28; const temp = document.createElement('div'); temp.innerHTML = createLineHtml(fullText.slice(cursorPos), size); const newLine = temp.firstElementChild; lineDiv.after(newLine); bindLineEvents(newLine); newLine.querySelector('.line-content').focus(); }
            if(e.key === 'Backspace' && this.innerText === '' && lineDiv.parentNode.children.length > 2) { e.preventDefault(); saveState(); const prev = lineDiv.previousElementSibling; if(prev && prev.classList.contains('text-line')) { lineDiv.remove(); prev.querySelector('.line-content').focus(); } }
        };
        redDot.onmousedown = function(e) {
            e.stopPropagation(); e.preventDefault();
            const startHtml = document.getElementById('canvas').innerHTML; if(historyStack.length===0 || historyStack[historyStack.length-1]!==startHtml) { historyStack.push(startHtml); if(historyStack.length > MAX_HISTORY) historyStack.shift(); }
            const startX = e.clientX; const startSize = parseFloat(window.getComputedStyle(content).fontSize)||28;
            const onMove = ev => { content.style.fontSize = Math.max(12, startSize + (ev.clientX - startX)) + 'px'; };
            const onUp = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
            window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
        };
    }

    function activateContainer(container) {
        if(currentContainer && currentContainer !== container) currentContainer.classList.remove('active');
        currentContainer = container; container.classList.add('active');
        const currentLH = container.style.lineHeight || 1.2; document.getElementById('lineHeightRange').value = currentLH; document.getElementById('lhValue').innerText = currentLH;
        const fontName = container.style.fontFamily.replace(/['"]/g, ''); const sel = document.getElementById('fontSelect'); for(let i=0; i<sel.options.length; i++) if(sel.options[i].value === fontName) { sel.value = fontName; break; }
        const bg = container.style.backgroundColor; if(bg && bg.includes('rgba')) { const parts = bg.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/); if(parts) { const hex = "#" + ((1 << 24) + (parseInt(parts[1]) << 16) + (parseInt(parts[2]) << 8) + parseInt(parts[3])).toString(16).slice(1); document.getElementById('bgColor').value = hex; document.getElementById('bgOpacity').value = parts[4]; document.getElementById('bgOpValue').innerText = parts[4]; } } else { document.getElementById('bgOpacity').value = 0; document.getElementById('bgOpValue').innerText = 0; }
    }
    function hexToRgba(hex, alpha) { const r = parseInt(hex.slice(1, 3), 16); const g = parseInt(hex.slice(3, 5), 16); const b = parseInt(hex.slice(5, 7), 16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; }
    window.applyBackground = function() { if(!currentContainer) return; currentContainer.style.backgroundColor = hexToRgba(document.getElementById('bgColor').value, document.getElementById('bgOpacity').value); }
    window.updateGlobalFont = function() { saveState(); const val = document.getElementById('fontSelect').value; GLOBAL_DEFAULT_FONT = val; localStorage.setItem('WECHAT_TOOL_FONT_PREF', val); if(currentContainer) currentContainer.style.fontFamily = GLOBAL_DEFAULT_FONT; }
    window.updateLineHeight = function(val) { document.getElementById('lhValue').innerText = val; if(currentContainer) currentContainer.style.lineHeight = val; }
    window.applyColor = function(val) { if(currentContainer) currentContainer.style.color = val; }
    window.applyBold = function() { if(currentContainer) { saveState(); currentContainer.style.fontWeight = currentContainer.style.fontWeight === 'bold' ? 'normal' : 'bold'; } }
    
    window.saveLongImage = function() {
        const btn = document.querySelector('.btn-save'); btn.innerText = "ç”Ÿæˆä¸­...";
        const canvasDiv = document.getElementById('canvas');
        if(currentContainer) currentContainer.classList.remove('active');
        document.querySelectorAll('.img-wrapper-inner.editing').forEach(el => el.classList.remove('editing')); 
        document.querySelectorAll('.tool-btn.active').forEach(el => el.classList.remove('active'));
        
        const tools = document.createElement('style');
        tools.innerHTML = '.tools, .blue-dot, .red-dot, .text-del-btn, .row.waiting-insert::after, .resize-handle { display: none !important; } .row, .img-wrapper-inner { border: none !important; outline: none !important; }';
        document.head.appendChild(tools);

        const originalMinHeight = canvasDiv.style.minHeight; canvasDiv.style.minHeight = "0px";
        html2canvas(canvasDiv, { scale: 2, useCORS: true, height: canvasDiv.scrollHeight, windowHeight: canvasDiv.scrollHeight, scrollY: 0, backgroundColor: '#ffffff' }).then(cvs => {
            const a = document.createElement('a'); a.download = 'æ’ç‰ˆé•¿å›¾_' + Date.now() + '.jpg'; a.href = cvs.toDataURL('image/jpeg', 0.9); a.click();
            btn.innerText = "ä¿å­˜é•¿å›¾"; tools.remove(); canvasDiv.style.minHeight = originalMinHeight;
        }).catch(() => { alert("ä¿å­˜å¤±è´¥"); btn.innerText = "ä¿å­˜é•¿å›¾"; tools.remove(); canvasDiv.style.minHeight = originalMinHeight; });
    };

    initDB();

</script>
</body>
</html>
