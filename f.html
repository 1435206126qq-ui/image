<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€ç¬”ç¬‘ç”»åˆ¶ä½œå™¨ - V44 ç‹¬ç«‹è¡Œç¼©æ”¾ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #07c160; --warning: #ff9c00; --gray: #f2f2f2; --blue: #1890ff; --dark: #333; --border: #ddd; }
        * { box-sizing: border-box; outline: none; user-select: none; }
        body { margin: 0; display: flex; height: 100vh; background: var(--gray); font-family: "Microsoft YaHei", sans-serif; overflow: hidden; }

        /* === å¸ƒå±€ === */
        .col-left { width: 20%; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 20; }
        .col-center { width: 20%; background: #f9f9f9; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 10px; }
        .col-right { width: 60%; background: #e6e6e6; position: relative; display: flex; flex-direction: column; }

        .sidebar-scroll { flex: 1; overflow-y: auto; padding: 15px; }
        .panel { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        h4 { margin: 0 0 10px 0; font-size: 14px; border-left: 3px solid var(--primary); padding-left: 8px; color: #333; }

        /* è§’è‰²æŒ‰é’®ä¸ç¼©ç•¥å›¾ (ä¿®æ”¹ç‚¹ï¼šæ ·å¼å¯¹é½ç´ æåº“) */
        .role-btn-large {
            width: 100%; height: 50px; border: 2px dashed var(--primary); background: #f0f9f0;
            color: var(--primary); font-size: 14px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; border-radius: 6px;
        }
        .mini-role-list { 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-top: 8px; /* ç½‘æ ¼å¸ƒå±€ */
        }
        .mini-role { 
            width: 100%; aspect-ratio: 1; border-radius: 0; border: 1px solid transparent; 
            background: #eee; object-fit: cover; cursor: pointer; position: relative;
        }
        .mini-role:hover { border-color: var(--primary); }

        /* ç´ æåº“ */
        .lib-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; min-height: 50px;}
        .lib-item { aspect-ratio: 1; background: #eee; cursor: pointer; border: 1px solid transparent; position: relative; }
        .lib-item:hover { border-color: var(--primary); }
        .lib-item img { width: 100%; height: 100%; object-fit: cover; }
        .lib-del { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.6); color: white; width: 12px; height: 12px; font-size: 8px; display: none; text-align: center; line-height: 12px;}
        .lib-item:hover .lib-del { display: block; }

        /* è¾“å…¥åŒº */
        #scriptInput { 
            flex: 1; width: 100%; resize: none; border: 1px solid #ddd; padding: 10px; 
            font-size: 14px; line-height: 1.6; border-radius: 4px; margin-bottom: 10px;
            font-family: monospace; user-select: text; 
        }

        /* ç”»å¸ƒåŒº */
        .canvas-scroll { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        #canvas { background: white; width: 100%; max-width: 800px; box-shadow: 0 0 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; }

        /* è¡Œæ ·å¼ */
        .row { 
            position: relative; width: 100%; 
            height: 450px; 
            background: white; border-bottom: 1px dashed #eee; 
            flex-shrink: 0; overflow: hidden; 
            transition: box-shadow 0.2s;
        }
        .row.active-row { outline: 2px solid var(--blue); z-index: 10; }
        
        .crop-panel {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 30px;
            background: rgba(0,0,0,0.8); display: none; z-index: 200;
            align-items: center; padding: 0 10px; gap: 10px; color: white; font-size: 12px;
        }
        .row.show-crop .crop-panel { display: flex; }
        .crop-slider { flex: 1; cursor: pointer; }

        /* å·¥å…·æ  */
        .tools { position: absolute; top: 5px; right: 5px; display: flex; opacity: 0; z-index: 100; background: rgba(0,0,0,0.6); border-radius: 4px; padding: 2px; }
        .row:hover .tools { opacity: 1; }
        .tool-btn { 
            width: 24px; height: 24px; border: none; background: transparent; color: white; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; margin: 0 1px;
        }
        .tool-btn:hover { background: rgba(255,255,255,0.3); }
        .tool-btn.btn-plus { color: #52c41a; font-weight: bold; font-size: 16px; }

        /* å›¾ç‰‡/è§’è‰²å®¹å™¨ */
        .img-wrapper-inner { position: absolute; display: inline-block; line-height: 0; cursor: grab; transform-origin: 0 0; }
        .img-wrapper-inner:active { cursor: grabbing; }
        .img-layer { pointer-events: none; width: 100%; height: 100%; object-fit: contain; }
        .img-wrapper-inner.editing { outline: 2px dashed var(--blue); z-index: 90; }
        
        .resize-handle {
            position: absolute; width: 10px; height: 10px; background: white; border: 1px solid var(--blue);
            border-radius: 50%; z-index: 95; display: none;
        }
        .img-wrapper-inner.editing .resize-handle { display: block; }
        .rh-nw { top: -5px; left: -5px; cursor: nw-resize; }
        .rh-ne { top: -5px; right: -5px; cursor: ne-resize; }
        .rh-sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .rh-se { bottom: -5px; right: -5px; cursor: se-resize; }

        /* æ–‡å­—å®¹å™¨ */
        .text-box-container {
            position: absolute; z-index: 50; cursor: move; padding: 4px;
            border: 1px dashed transparent; border-radius: 4px; width: max-content; max-width: 90%;
            transform-origin: 0 0; 
        }
        .text-box-container.active { outline: 1px solid var(--blue); }
        .text-line { position: relative; padding: 0 5px; min-height: 20px; display: block; width: fit-content; margin: 0 auto;}
        .line-content { outline: none; display: inline-block; white-space: pre-wrap; cursor: text; user-select: text; }
        
        .text-scale-handle {
            position: absolute; bottom: -6px; right: -6px; width: 12px; height: 12px;
            background: var(--blue); border: 2px solid white; border-radius: 50%;
            cursor: se-resize; display: none; z-index: 101; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .text-box-container.active .text-scale-handle { display: block; }
        .text-del-btn {
            position: absolute; top: -8px; left: -8px; width: 16px; height: 16px; 
            background: #fa5151; color: white; border-radius: 50%; text-align: center; 
            line-height: 14px; cursor: pointer; display: none; font-size: 12px; z-index: 60;
        }
        .text-box-container.active .text-del-btn { display: block; }

        .btn { width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; background: #e6e6e6; font-weight: bold; margin-bottom: 5px;}
        .btn:hover { background: #d9d9d9; }
        .btn-green { background: var(--primary); color: white; } .btn-green:hover { background: #06ad56; }
        .btn-blue { background: var(--blue); color: white; } .btn-blue:hover { background: #096dd9; }
        .btn-red { background: #ff4d4f; color: white; } .btn-red:hover { background: #ff7875; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 999; display: none; justify-content: center; align-items: center; }
        .modal-overlay.open { display: flex; }
        .modal-content { background: white; width: 90%; max-width: 900px; max-height: 90vh; border-radius: 8px; padding: 20px; display: flex; flex-direction: column; }
        .role-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 8px; overflow-y: auto; padding: 10px; flex: 1; }
        .role-slot { aspect-ratio: 1; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; position: relative; background: #eee; }
        .role-slot img { width: 100%; height: 100%; object-fit: cover; display: none; border-radius: 3px; }
        .role-slot.has-img img { display: block; }
        .role-num { position: absolute; bottom: 2px; right: 2px; background: rgba(0,0,0,0.5); color: white; font-size: 10px; padding: 1px 4px; border-radius: 2px; }

        .control-row { display: flex; align-items: center; margin-bottom: 8px; gap: 8px; font-size: 12px; color: #666; }
        select, input[type=color], input[type=range] { flex: 1; height: 26px; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div class="col-left">
    <div class="sidebar-scroll">
        <div class="panel">
            <h4>ğŸ­ è§’è‰²ç®¡ç† (1-30)</h4>
            <div class="role-btn-large" onclick="openRoleModal()">
                <span>+</span> ç‚¹å‡»è®¾ç½®è§’è‰²
            </div>
            <!-- ä¿®æ”¹ç‚¹ï¼šè¿™é‡Œä¼šç”Ÿæˆå¯ç‚¹å‡»çš„ç½‘æ ¼ç¼©ç•¥å›¾ -->
            <div class="mini-role-list" id="miniRolePreview"></div>
        </div>

        <div class="panel">
            <h4>ğŸ–¼ï¸ ç´ æåº“ (ç‚¹å‡»å åŠ )</h4>
            <div class="lib-grid" id="libGrid"></div>
            <label class="btn btn-green" style="margin-top:8px; display:block; text-align:center;">
                + æ‰¹é‡ä¸Šä¼ ç´ æ
                <input type="file" id="uploadImg" accept="image/*" multiple style="display:none">
            </label>
        </div>

        <div class="panel">
            <h4>ğŸ¨ æ ·å¼è®¾ç½®</h4>
            <div class="control-row">
                <label>å­—ä½“</label>
                <select id="fontSelect" onchange="updateGlobalFont()">
                    <option value="Microsoft YaHei">å¾®è½¯é›…é»‘</option>
                    <option value="SimHei">é»‘ä½“</option>
                    <option value="Arial">Arial</option>
                </select>
            </div>
            <label class="btn" style="text-align:center; padding:4px;">
                ğŸ“‚ ä¸Šä¼ å­—ä½“ (TTF/OTF)
                <input type="file" id="uploadFont" accept=".ttf,.otf" style="display:none">
            </label>
            <div class="control-row"><label>è¡Œè·</label><input type="range" id="lineHeightRange" min="0.8" max="2.5" step="0.1" value="1.2" oninput="updateLineHeight(this.value)"></div>
            <div class="control-row"><label>å­—è‰²</label><input type="color" id="fontColor" value="#000000" oninput="applyColor(this.value)"></div>
            <div class="control-row"><label>èƒŒæ™¯</label><input type="color" id="bgColor" value="#ffffff" oninput="applyBackground()"><input type="range" id="bgOpacity" min="0" max="1" step="0.1" value="0" style="width:40px" oninput="applyBackground()"></div>
            <div class="control-row"><button class="btn" onclick="applyBold()">B åŠ ç²—</button></div>
        </div>
    </div>
</div>

<div class="col-center">
    <h3>ğŸ“ å‰§æœ¬ç¼–è¾‘</h3>
    <textarea id="scriptInput" placeholder="è¯·è¾“å…¥å‰§æœ¬...
1: ä½ å¥½
2: ä½ å¥½
0: æ—ç™½
0:"></textarea>
    <div style="display:flex; gap:10px; margin-top:auto;">
        <button class="btn btn-red" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©º (Ctrl+Zå¯æ’¤é”€)</button>
        <button class="btn btn-blue" onclick="generateFromScript()">ğŸš€ ä¸€é”®ç”Ÿæˆé•¿å›¾</button>
    </div>
</div>

<div class="col-right">
    <div class="canvas-scroll" id="scrollArea">
        <div id="canvas"></div>
    </div>
    <div style="padding: 10px; background: #ddd; text-align: center;">
        <button class="btn btn-blue" style="width: 200px; font-size: 16px;" onclick="saveLongImage()">ğŸ’¾ ä¿å­˜é•¿å›¾</button>
    </div>
</div>

<div class="modal-overlay" id="roleModal" onclick="if(event.target===this) closeRoleModal()">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold;">
            <span>è®¾ç½®è§’è‰² (ç‚¹å‡»æ ¼å­ä¸Šä¼ )</span>
            <button class="btn btn-red" style="width:auto; padding:5px 15px;" onclick="closeRoleModal()">å…³é—­</button>
        </div>
        <div class="role-grid" id="roleGrid"></div>
        <input type="file" id="roleUpload" accept="image/*" style="display:none">
    </div>
</div>

<script>
    const DB_NAME = "ScriptMakerDB_V44";
    let db = null;
    let GLOBAL_DEFAULT_FONT = 'Microsoft YaHei';
    let currentActiveRow = null;
    let currentTextContainer = null;
    let undoStack = []; 

    function initDB() {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = e => {
            db = e.target.result;
            if(!db.objectStoreNames.contains('images')) db.createObjectStore('images', { keyPath: 'id', autoIncrement:true });
            if(!db.objectStoreNames.contains('roles')) db.createObjectStore('roles', { keyPath: 'id' });
            if(!db.objectStoreNames.contains('fonts')) db.createObjectStore('fonts', { keyPath: 'name' });
        };
        req.onsuccess = e => { db = e.target.result; loadLibImages(); renderRoleGrid(); loadFonts(); };
    }

    // === æ’¤é”€ ===
    function saveState() {
        if(undoStack.length > 30) undoStack.shift();
        undoStack.push(document.getElementById('canvas').innerHTML);
    }
    function undo() {
        if (document.activeElement === document.getElementById('scriptInput')) return;
        if (undoStack.length > 0) {
            document.getElementById('canvas').innerHTML = undoStack.pop();
            rebindAllEvents();
        }
    }
    document.addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
            if (document.activeElement !== document.getElementById('scriptInput')) {
                e.preventDefault(); undo();
            }
        }
    });

    function rebindAllEvents() {
        document.querySelectorAll('.row').forEach(row => { row.onclick = (e) => setActiveRow(row, e); });
        document.querySelectorAll('.img-wrapper-inner').forEach(el => makeDraggableAndResizable(el));
        document.querySelectorAll('.text-box-container').forEach(el => {
            bindContainerEvents(el);
            el.querySelectorAll('.text-line').forEach(l => bindLineEvents(l));
        });
    }

    // === è§’è‰² ===
    let currentRoleSlotId = null;
    function openRoleModal() { document.getElementById('roleModal').classList.add('open'); renderRoleGrid(); }
    function closeRoleModal() { document.getElementById('roleModal').classList.remove('open'); }
    function renderRoleGrid() {
        const grid = document.getElementById('roleGrid');
        const preview = document.getElementById('miniRolePreview');
        grid.innerHTML = ''; preview.innerHTML = '';
        if(!db) return;
        db.transaction('roles', 'readonly').objectStore('roles').getAll().onsuccess = e => {
            const map = {}; e.target.result.forEach(i => map[i.id] = i.data);
            for(let i=1; i<=30; i++) {
                // å¼¹çª—å¤§å›¾
                const div = document.createElement('div');
                div.className = 'role-slot' + (map[i] ? ' has-img' : '');
                div.innerHTML = `<span class="role-num">${i}</span><img src="${map[i] || ''}">`;
                div.onclick = () => { currentRoleSlotId = i; document.getElementById('roleUpload').click(); };
                grid.appendChild(div);

                // ä¾§è¾¹æ ç¼©ç•¥å›¾ (ä¿®æ”¹ç‚¹ï¼šæ·»åŠ ç‚¹å‡»äº‹ä»¶)
                if(map[i]) {
                    const thumb = document.createElement('img'); 
                    thumb.className = 'mini-role'; 
                    thumb.src = map[i]; 
                    // ç‚¹å‡»ç¼©ç•¥å›¾ -> æ·»åŠ åˆ°ç”»å¸ƒ
                    thumb.onclick = () => handleLibraryClick(map[i]);
                    preview.appendChild(thumb);
                }
            }
        };
    }
    document.getElementById('roleUpload').onchange = function(e) {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            const tx = db.transaction('roles', 'readwrite');
            tx.objectStore('roles').put({ id: currentRoleSlotId, data: ev.target.result });
            tx.oncomplete = () => { renderRoleGrid(); this.value = ''; };
        };
        reader.readAsDataURL(file);
    };

    // === ç´ æåº“ ===
    document.getElementById('uploadImg').onchange = function(e) {
        const files = Array.from(e.target.files); if(!files.length) return;
        const promises = files.map(f => new Promise(res => { const r = new FileReader(); r.onload=ev=>res(ev.target.result); r.readAsDataURL(f); }));
        Promise.all(promises).then(urls => {
            const tx = db.transaction('images', 'readwrite');
            urls.forEach(u => tx.objectStore('images').add({ data: u }));
            tx.oncomplete = () => { loadLibImages(); this.value = ''; };
        });
    };
    function loadLibImages() {
        if(!db) return;
        const grid = document.getElementById('libGrid'); grid.innerHTML = '';
        db.transaction('images', 'readonly').objectStore('images').getAll().onsuccess = e => {
            e.target.result.forEach(item => {
                const div = document.createElement('div'); div.className = 'lib-item';
                div.innerHTML = `<img src="${item.data}"><div class="lib-del" onclick="delLibImg(${item.id}, event)">âŒ</div>`;
                div.onclick = (ev) => { if(ev.target.className!=='lib-del') handleLibraryClick(item.data); };
                grid.appendChild(div);
            });
        };
    }
    window.delLibImg = (id, e) => { e.stopPropagation(); if(confirm('åˆ é™¤?')) db.transaction('images','readwrite').objectStore('images').delete(id).onsuccess = loadLibImages; }

    // === å‰§æœ¬ç”Ÿæˆ ===
    async function generateFromScript() {
        saveState();
        const text = document.getElementById('scriptInput').value;
        if(!text.trim()) { alert("è¯·è¾“å…¥å‰§æœ¬"); return; }
        document.getElementById('canvas').innerHTML = '';
        const lines = text.split('\n');
        for (let line of lines) {
            line = line.trim(); if(!line) continue;
            const match = line.match(/^(\d+)[:ï¼š](.*)/);
            if(match) {
                const roleId = parseInt(match[1]);
                let content = match[2].trim();
                let color = null;
                const cm = content.match(/(.*)#(.+)#$/); if(cm) { content = cm[1]; color = cm[2]==='red'?'#ff0000':cm[2]; }
                let img = null; if(roleId>0) img = await getRoleImage(roleId);
                addRow({ roleId, image: img, text: content, textColor: color });
            } else {
                const last = document.getElementById('canvas').lastElementChild;
                if(last && last.querySelector('.text-box-container')) {
                    const d = document.createElement('div'); d.innerHTML = createLineHtml(line, 50);
                    const c = last.querySelector('.text-box-container');
                    c.appendChild(d.firstElementChild);
                    bindLineEvents(c.lastElementChild);
                } else addRow({ roleId:0, text: line });
            }
        }
    }
    function getRoleImage(id) { return new Promise(res => db.transaction('roles','readonly').objectStore('roles').get(id).onsuccess = e => res(e.target.result?.data)); }

    // === æ·»åŠ è¡Œ ===
    function addRow(params, insertAfterNode = null) {
        const { roleId, image, text, textColor } = params;
        const div = document.createElement('div');
        div.className = 'row';
        div.onclick = (e) => setActiveRow(div, e);

        div.innerHTML = `
            <div class="tools">
                <button class="tool-btn btn-plus" onclick="insertBlankRow(this)" title="æ’å…¥ç©ºç™½è¡Œ">+</button>
                <button class="tool-btn" onclick="toggleCrop(this)" title="è£å‰ªé«˜åº¦">âœ‚ï¸</button>
                <button class="tool-btn btn-text" onclick="addTextToRow(this)" title="æ·»åŠ æ–‡å­—">T</button>
                <button class="tool-btn del" onclick="deleteRow(this)" title="åˆ é™¤">Ã—</button>
            </div>
            <div class="crop-panel" onclick="event.stopPropagation()">
                <span>é«˜åº¦:</span>
                <input type="range" class="crop-slider" min="100" max="1000" step="10" value="450" oninput="applyRowHeight(this)">
                <button class="tool-btn" onclick="this.closest('.row').classList.remove('show-crop')">âœ…</button>
            </div>
        `;

        if (roleId > 0 && image) {
            const wrap = document.createElement('div'); wrap.className = 'img-wrapper-inner';
            wrap.style.height = '100%'; wrap.style.top = '0';
            roleId % 2 !== 0 ? (wrap.style.left = '-5%') : (wrap.style.right = '-5%');
            wrap.innerHTML = `<img src="${image}" class="img-layer"><div class="resize-handle rh-se"></div><div class="resize-handle rh-sw"></div><div class="resize-handle rh-ne"></div><div class="resize-handle rh-nw"></div>`;
            div.appendChild(wrap);
            makeDraggableAndResizable(wrap);
        }

        if (text || roleId===0) {
            if(roleId !== 0 || text) {
                const txtDiv = document.createElement('div');
                txtDiv.className = 'text-box-container';
                txtDiv.style.fontFamily = GLOBAL_DEFAULT_FONT;
                txtDiv.style.color = textColor || '#000000';
                
                txtDiv.style.top = '50%'; 
                if (roleId === 0) {
                    txtDiv.style.left = '50%'; txtDiv.style.transform = 'translate(-50%, -50%)';
                } else {
                    roleId % 2 !== 0 ? (txtDiv.style.right = '10%') : (txtDiv.style.left = '10%');
                    txtDiv.style.transform = 'translateY(-50%)';
                }
                
                txtDiv.innerHTML = `<div class="text-del-btn">Ã—</div><div class="text-scale-handle"></div>${createLineHtml(text, 50)}`;
                div.appendChild(txtDiv);
                bindContainerEvents(txtDiv);
                txtDiv.querySelectorAll('.text-line').forEach(l => bindLineEvents(l));
            }
        }

        const canvas = document.getElementById('canvas');
        if(insertAfterNode && insertAfterNode.nextSibling) canvas.insertBefore(div, insertAfterNode.nextSibling);
        else canvas.appendChild(div);
        if(!insertAfterNode) div.scrollIntoView({ behavior: 'smooth' });
    }

    // === è£å‰ª ===
    window.toggleCrop = function(btn) {
        saveState();
        const row = btn.closest('.row');
        row.classList.toggle('show-crop');
        const slider = row.querySelector('.crop-slider');
        slider.value = row.offsetHeight;
    }
    window.applyRowHeight = function(input) { input.closest('.row').style.height = input.value + 'px'; }
    window.insertBlankRow = function(btn) { saveState(); addRow({ roleId: 0, text: '' }, btn.closest('.row')); }
    window.deleteRow = function(btn) { saveState(); btn.closest('.row').remove(); }

    // === å­—ä½“ ===
    document.getElementById('uploadFont').onchange = function(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            try {
                const fontName = file.name.split('.')[0].replace(/\s/g, '');
                const font = new FontFace(fontName, ev.target.result);
                font.load().then(loadedFont => {
                    document.fonts.add(loadedFont);
                    const sel = document.getElementById('fontSelect');
                    const opt = document.createElement('option');
                    opt.value = fontName; opt.text = "è‡ªå®šä¹‰: " + fontName;
                    sel.add(opt); sel.value = fontName;
                    updateGlobalFont();
                    const tx = db.transaction('fonts', 'readwrite');
                    tx.objectStore('fonts').put({ name: fontName, buffer: ev.target.result });
                    alert(`å­—ä½“ ${fontName} å·²è®¾ç½®ä¸ºé»˜è®¤å­—ä½“`);
                }).catch(err => alert("å­—ä½“æ–‡ä»¶æ— æ³•è§£æ"));
            } catch(e) { console.error(e); }
        };
        reader.readAsArrayBuffer(file);
    };
    
    function loadFonts() {
        if(!db) return;
        db.transaction('fonts', 'readonly').objectStore('fonts').getAll().onsuccess = e => {
            e.target.result.forEach(f => {
                const ff = new FontFace(f.name, f.buffer);
                ff.load().then(lf => {
                    document.fonts.add(lf);
                    const sel = document.getElementById('fontSelect');
                    const opt = document.createElement('option'); opt.value = f.name; opt.text = "è‡ªå®šä¹‰: "+f.name;
                    sel.add(opt);
                });
            });
        };
    }

    // === æ–‡å­—å®¹å™¨äº¤äº’ ===
    function bindContainerEvents(container) {
        const delBtn = container.querySelector('.text-del-btn');
        if(delBtn) delBtn.onclick = e => { e.stopPropagation(); saveState(); container.remove(); };

        const scaleHandle = container.querySelector('.text-scale-handle');
        if(scaleHandle) {
            scaleHandle.onmousedown = function(e) {
                e.stopPropagation(); e.preventDefault(); saveState();
                const startY = e.clientY;
                const style = window.getComputedStyle(container);
                const matrix = new DOMMatrix(style.transform);
                const startScale = matrix.a; 
                const onMove = ev => {
                    const delta = (ev.clientY - startY) * 0.005;
                    const newScale = Math.max(0.2, startScale + delta);
                    container.style.transform = `scale(${newScale})`;
                };
                const onUp = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
                window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
            }
        }

        container.onmousedown = function(e) {
            if(e.target.isContentEditable || e.target.classList.contains('text-scale-handle') || e.target.classList.contains('text-del-btn')) return;
            e.stopPropagation(); 
            if(currentTextContainer) currentTextContainer.classList.remove('active');
            currentTextContainer = container; container.classList.add('active');
            saveState();

            const rect = container.getBoundingClientRect(); 
            const parentRect = container.parentElement.getBoundingClientRect();
            const absoluteLeft = rect.left - parentRect.left;
            const absoluteTop = rect.top - parentRect.top;
            const style = window.getComputedStyle(container);
            const matrix = new DOMMatrix(style.transform);
            const currentScale = matrix.a;

            container.style.transformOrigin = '0 0';
            container.style.left = absoluteLeft + 'px';
            container.style.top = absoluteTop + 'px';
            container.style.right = 'auto'; 
            container.style.bottom = 'auto';
            container.style.transform = `scale(${currentScale})`;

            const startX = e.clientX;
            const startY = e.clientY;
            const startL = parseFloat(container.style.left);
            const startT = parseFloat(container.style.top);

            const onMove = ev => {
                container.style.left = (startL + (ev.clientX - startX)) + 'px';
                container.style.top = (startT + (ev.clientY - startY)) + 'px';
            };
            const onUp = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
            window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
        };
    }

    // === æ–‡å­—è¡Œé€»è¾‘ (æ ¸å¿ƒä¿®æ”¹ï¼šç‹¬ç«‹è¡Œç¼©æ”¾ä¸Enteråˆ†å‰²) ===
    function createLineHtml(text, size) {
        const display = text || "åŒå‡»ç¼–è¾‘æ–‡å­—";
        return `<div class="text-line"><span class="line-content" contenteditable="false" style="font-size: ${size}px;">${display}</span></div>`;
    }
    
    function bindLineEvents(line) {
        const span = line.querySelector('.line-content');
        
        // æ¿€æ´»ç¼–è¾‘
        span.ondblclick = function(e) {
            e.stopPropagation();
            if(this.innerText === "åŒå‡»ç¼–è¾‘æ–‡å­—") this.innerText = "";
            this.contentEditable = true; this.focus();
        };
        span.onblur = function() { this.contentEditable = false; if(!this.innerText.trim()) this.innerText="åŒå‡»ç¼–è¾‘æ–‡å­—"; };
        
        // æ»šè½®ç¼©æ”¾ (åªå½±å“å½“å‰è¡Œ)
        span.onwheel = function(e) {
            const container = this.closest('.text-box-container');
            if (!container || !container.classList.contains('active')) return;

            e.preventDefault(); e.stopPropagation();
            let s = parseFloat(window.getComputedStyle(this).fontSize);
            const delta = e.deltaY < 0 ? 2 : -2;
            const newSize = Math.max(12, s + delta);
            this.style.fontSize = newSize + 'px';
        };

        // é”®ç›˜äº‹ä»¶ï¼šå¤„ç†å›è½¦åˆ†å‰²å’Œé€€æ ¼åˆå¹¶
        span.onkeydown = function(e) {
            // å›è½¦ï¼šåˆ†å‰²æˆæ–°è¡Œ
            if(e.key === 'Enter') {
                e.preventDefault();
                saveState();
                
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                
                // è·å–å…‰æ ‡ä½ç½®çš„æ–‡æœ¬å‰åä¸¤éƒ¨åˆ†
                const fullText = this.innerText;
                const caretPos = range.startOffset;
                const textBefore = fullText.substring(0, caretPos);
                const textAfter = fullText.substring(caretPos);
                
                // æ›´æ–°å½“å‰è¡Œ
                this.innerText = textBefore;
                
                // åˆ›å»ºæ–°è¡Œ (ä¿æŒå½“å‰è¡Œå¤§å°)
                const currentSize = parseFloat(window.getComputedStyle(this).fontSize);
                const newLineHtml = createLineHtml(textAfter, currentSize);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = newLineHtml;
                const newLineElement = tempDiv.firstElementChild;
                
                // æ’å…¥åˆ°å½“å‰è¡Œåé¢
                line.insertAdjacentElement('afterend', newLineElement);
                
                // ç»‘å®šäº‹ä»¶
                bindLineEvents(newLineElement);
                
                // èšç„¦æ–°è¡Œ
                const newSpan = newLineElement.querySelector('.line-content');
                newSpan.contentEditable = true;
                newSpan.focus();
            }
            
            // é€€æ ¼ï¼šå¦‚æœå…‰æ ‡åœ¨å¼€å¤´ï¼Œåˆå¹¶åˆ°ä¸Šä¸€è¡Œ
            if(e.key === 'Backspace') {
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                
                if(range.startOffset === 0 && selection.isCollapsed) {
                    const prevLine = line.previousElementSibling;
                    if(prevLine && prevLine.classList.contains('text-line')) {
                        e.preventDefault();
                        saveState();
                        
                        const prevSpan = prevLine.querySelector('.line-content');
                        const currentText = this.innerText;
                        
                        // è®°å½•åˆå¹¶å‰çš„ä½ç½®
                        const originalLength = prevSpan.innerText.length;
                        
                        // åˆå¹¶æ–‡æœ¬
                        if(currentText !== "åŒå‡»ç¼–è¾‘æ–‡å­—") {
                            if(prevSpan.innerText === "åŒå‡»ç¼–è¾‘æ–‡å­—") prevSpan.innerText = "";
                            prevSpan.innerText += currentText;
                        }
                        
                        // åˆ é™¤å½“å‰è¡Œ
                        line.remove();
                        
                        // èšç„¦ä¸Šä¸€è¡Œå¹¶æ¢å¤å…‰æ ‡ä½ç½®
                        prevSpan.contentEditable = true;
                        prevSpan.focus();
                        
                        // è®¾ç½®å…‰æ ‡åˆ°åˆå¹¶å¤„
                        try {
                            const newRange = document.createRange();
                            const sel = window.getSelection();
                            newRange.setStart(prevSpan.firstChild || prevSpan, originalLength);
                            newRange.collapse(true);
                            sel.removeAllRanges();
                            sel.addRange(newRange);
                        } catch(err) {}
                    }
                }
            }
        };
    }

    // === å›¾ç‰‡/è§’è‰²äº¤äº’ ===
    function makeDraggableAndResizable(el) {
        el.onwheel = function(e) {
            if(!el.classList.contains('editing')) return;
            e.preventDefault(); e.stopPropagation();
            const delta = e.deltaY < 0 ? 10 : -10;
            const rect = el.getBoundingClientRect();
            const ratio = rect.width / rect.height;
            let newW = Math.max(20, rect.width + delta);
            el.style.width = newW + 'px'; el.style.height = (newW / ratio) + 'px';
        };

        el.onmousedown = function(e) {
            if(e.target.classList.contains('resize-handle')) return; 
            e.stopPropagation(); e.preventDefault(); saveState();
            
            document.querySelectorAll('.editing').forEach(x => x.classList.remove('editing'));
            el.classList.add('editing');

            const rect = el.getBoundingClientRect();
            const parentRect = el.closest('.row').getBoundingClientRect();
            
            const absLeft = rect.left - parentRect.left;
            const absTop = rect.top - parentRect.top;
            
            el.style.left = absLeft + 'px';
            el.style.top = absTop + 'px';
            el.style.right = 'auto'; el.style.bottom = 'auto';
            el.style.transform = 'none';

            const startX = e.clientX, startY = e.clientY;
            const startL = el.offsetLeft, startT = el.offsetTop;

            const onMove = ev => {
                el.style.left = (startL + ev.clientX - startX) + 'px';
                el.style.top = (startT + ev.clientY - startY) + 'px';
            };
            const onUp = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
            window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
        };

        el.querySelectorAll('.resize-handle').forEach(h => {
            h.onmousedown = function(e) {
                e.stopPropagation(); e.preventDefault(); saveState();
                const startX = e.clientX;
                const startW = el.offsetWidth;
                const ratio = el.offsetWidth / el.offsetHeight;
                const isLeft = h.classList.contains('rh-nw') || h.classList.contains('rh-sw');
                const onMove = ev => {
                    let dx = ev.clientX - startX; if(isLeft) dx = -dx;
                    const newW = Math.max(20, startW + dx);
                    el.style.width = newW + 'px'; el.style.height = (newW / ratio) + 'px';
                };
                const onUp = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
                window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
            };
        });
    }

    function setActiveRow(row, e) { if(e) e.stopPropagation(); document.querySelectorAll('.row').forEach(r => r.classList.remove('active-row')); row.classList.add('active-row'); currentActiveRow = row; }
    
    function handleLibraryClick(src) {
        if(!currentActiveRow) { alert("è¯·å…ˆé€‰æ‹©ä¸€è¡Œ"); return; } saveState();
        const d = document.createElement('div'); d.className = 'img-wrapper-inner';
        d.style.width='30%'; d.style.top='50%'; d.style.left='50%'; d.style.transform='translate(-50%,-50%)';
        d.innerHTML = `<img src="${src}" class="img-layer"><div class="resize-handle rh-se"></div>`;
        currentActiveRow.appendChild(d); makeDraggableAndResizable(d);
    }
    
    window.clearAll = function() { saveState(); document.getElementById('scriptInput').value = ''; document.getElementById('canvas').innerHTML = ''; }
    
    window.addTextToRow = function(btn) {
        saveState(); const row = btn.closest('.row');
        const d = document.createElement('div'); d.className = 'text-box-container active';
        d.style.fontFamily = GLOBAL_DEFAULT_FONT; 
        d.style.top='50%'; d.style.left='50%'; d.style.transform='translate(-50%,-50%)'; 
        d.innerHTML = `<div class="text-del-btn">Ã—</div><div class="text-scale-handle"></div>${createLineHtml("åŒå‡»ç¼–è¾‘æ–‡å­—", 50)}`;
        row.appendChild(d); bindContainerEvents(d); bindLineEvents(d.querySelector('.text-line')); currentTextContainer = d;
    }
    
    window.saveLongImage = function() {
        const btn = document.querySelector('button[onclick="saveLongImage()"]'); const txt = btn.innerText; btn.innerText = "å¤„ç†ä¸­...";
        const style = document.createElement('style');
        style.innerHTML = `.tools, .resize-handle, .text-del-btn, .text-scale-handle, .crop-panel { display: none !important; } .row, .img-wrapper-inner, .text-box-container { outline: none !important; border-bottom: none !important; }`;
        document.head.appendChild(style);
        html2canvas(document.getElementById('canvas'), { scale: 2, windowWidth: 1920, useCORS: true }).then(c => {
            const a = document.createElement('a'); a.download = 'é•¿å›¾.jpg'; a.href = c.toDataURL('image/jpeg', 0.9); a.click();
            btn.innerText = txt; style.remove();
        });
    }
    
    window.updateGlobalFont = () => { 
        GLOBAL_DEFAULT_FONT = document.getElementById('fontSelect').value;
        if(currentTextContainer) currentTextContainer.style.fontFamily = GLOBAL_DEFAULT_FONT; 
    }
    window.updateLineHeight = (v) => { if(currentTextContainer) currentTextContainer.style.lineHeight = v; }
    window.applyColor = (v) => { if(currentTextContainer) currentTextContainer.style.color = v; }
    window.applyBackground = () => { 
        if(!currentTextContainer) return;
        const hex = document.getElementById('bgColor').value; const a = document.getElementById('bgOpacity').value;
        const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
        currentTextContainer.style.backgroundColor = `rgba(${r},${g},${b},${a})`;
    }
    window.applyBold = () => { if(currentTextContainer) currentTextContainer.style.fontWeight = currentTextContainer.style.fontWeight==='bold'?'normal':'bold'; }
    
    document.addEventListener('mousedown', e => {
        if(!e.target.closest('.img-wrapper-inner') && !e.target.closest('.tool-btn')) document.querySelectorAll('.editing').forEach(el=>el.classList.remove('editing'));
        if(!e.target.closest('.text-box-container') && !e.target.closest('.control-row')) {
            if(currentTextContainer) currentTextContainer.classList.remove('active'); currentTextContainer = null;
        }
    });
    
    initDB();
</script>
</body>
</html>
