<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡ç¼–è¾‘å™¨ (å®Œç¾å±€éƒ¨è°ƒæ•´ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --panel-w: 330px;
        }
        body { margin: 0; display: flex; height: 100vh; font-family: "Microsoft YaHei", sans-serif; background: var(--bg); overflow: hidden; }
        
        /* å·¦ä¾§é¢æ¿ */
        .sidebar {
            width: var(--panel-w);
            background: white;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            padding: 15px;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 20;
        }

        .group { margin-bottom: 20px; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; }
        h3 { margin: 0 0 10px 0; font-size: 14px; color: #334155; font-weight: 700; }
        
        label { display: block; font-size: 12px; color: #64748b; margin: 8px 0 4px; }
        .row { display: flex; gap: 8px; align-items: center; }
        .col { flex: 1; }
        
        input[type="range"] { width: 100%; cursor: pointer; margin: 5px 0; }
        input[type="color"] { border: none; width: 30px; height: 30px; padding: 0; cursor: pointer; background: none; }
        select, button { width: 100%; padding: 6px 8px; border-radius: 4px; font-size: 12px; border: 1px solid #cbd5e1; }
        
        button { background: var(--primary); color: white; border: none; cursor: pointer; transition: 0.2s; padding: 8px; }
        button:hover { opacity: 0.9; }
        button.outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        
        /* é¢„è®¾ grid */
        .preset-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 10px; }
        .preset-item { position: relative; aspect-ratio: 1; cursor: pointer; }
        .preset-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; border: 2px solid #eee; }
        .preset-item:hover img { border-color: var(--primary); }
        .preset-del { position: absolute; top: -4px; right: -4px; background: red; color: white; width: 14px; height: 14px; border-radius: 50%; font-size: 10px; display: none; align-items: center; justify-content: center; }
        .preset-item:hover .preset-del { display: flex; }

        /* ç”»å¸ƒåŒº */
        .workspace { flex: 1; background: #cbd5e1; display: flex; align-items: center; justify-content: center; overflow: auto; padding: 50px; }
        
        #canvas-box {
            background: white;
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.25);
            position: relative; 
            display: inline-block; 
        }

        #img-stage { position: relative; line-height: 0; user-select: none; }
        #main-img { max-width: 100%; max-height: 85vh; display: block; pointer-events: none; }

        /* æ–‡å­—ç»„ä»¶ */
        .text-wrapper {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
            z-index: 10;
            width: max-content; 
            max-width: 1000vw; 
        }

        .text-wrapper.editing { cursor: text; z-index: 100; }

        .text-content {
            font-size: 24px;
            font-weight: bold;
            line-height: 1.4;
            outline: none;
            white-space: pre; /* ä¸æ¢è¡Œ */
            display: inline-block;
            border: 2px dashed transparent;
            min-width: 1em;
            padding: 5px;
        }

        .text-wrapper:hover .text-content { border-color: rgba(37, 99, 235, 0.3); }
        .text-wrapper.active .text-content { border-color: var(--primary); }

        .del-btn {
            position: absolute; top: -15px; right: -15px;
            width: 20px; height: 20px; background: #ef4444; color: white;
            border-radius: 50%; display: none; align-items: center; justify-content: center;
            cursor: pointer; font-size: 12px; z-index: 101;
        }
        .text-wrapper:hover .del-btn, .text-wrapper.active .del-btn { display: flex; }
        .text-wrapper.editing .del-btn { display: none !important; }

        .control-section { padding: 10px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0; margin-top: 5px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="group">
        <h3>1. å›¾ç‰‡æº</h3>
        <div class="row">
            <button class="outline" onclick="document.getElementById('file-input').click()">ğŸ“‚ æœ¬åœ°ä¸Šä¼ </button>
            <button onclick="saveToPresets()" style="background:#64748b;">ğŸ’¾ å­˜ä¸ºé¢„è®¾</button>
        </div>
        <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleUpload(this)">
        <div class="preset-grid" id="preset-list"></div>
    </div>

    <div class="group">
        <h3>2. ç”»å¸ƒè®¾ç½®</h3>
        <label>ç”»å¸ƒæ‰©å±•æ–¹å‘</label>
        <select id="canvas-pad-mode" onchange="togglePadMode('canvas')">
            <option value="all">ç»Ÿä¸€è°ƒæ•´ (å››å‘¨)</option>
            <option value="individual">ç‹¬ç«‹è°ƒæ•´ (ä¸Šä¸‹å·¦å³)</option>
        </select>

        <div id="canvas-pad-all" class="control-section">
            <label>è¾¹è·: <span id="val-canvas-all">0</span>px</label>
            <input type="range" min="0" max="200" value="0" oninput="updateCanvasPad('all', this.value)">
        </div>
        <div id="canvas-pad-ind" class="control-section" style="display:none">
            <div class="row"><div class="col"><label>ä¸Š</label><input type="range" min="0" max="200" value="0" oninput="updateCanvasPad('top', this.value)"></div>
            <div class="col"><label>ä¸‹</label><input type="range" min="0" max="200" value="0" oninput="updateCanvasPad('bottom', this.value)"></div></div>
            <div class="row"><div class="col"><label>å·¦</label><input type="range" min="0" max="200" value="0" oninput="updateCanvasPad('left', this.value)"></div>
            <div class="col"><label>å³</label><input type="range" min="0" max="200" value="0" oninput="updateCanvasPad('right', this.value)"></div></div>
        </div>
        
        <label>ç”»å¸ƒèƒŒæ™¯</label>
        <div class="row">
            <input type="color" id="canvas-bg" value="#ffffff" oninput="updateCanvasBg()">
            <select id="bg-type" onchange="updateCanvasBg()">
                <option value="solid">çº¯è‰²</option>
                <option value="v-grad">å‚ç›´æ¸å˜</option>
                <option value="h-grad">æ°´å¹³æ¸å˜</option>
            </select>
        </div>
    </div>

    <div class="group">
        <h3>3. æ–‡å­—ç¼–è¾‘ <span id="text-status" style="font-weight:normal; font-size:11px; color:#999">(æœªé€‰ä¸­)</span></h3>
        <button onclick="addText()">+ æ·»åŠ æ–‡å­— (è‡ªåŠ¨é€‰ä¸­)</button>

        <div id="text-controls" style="opacity: 0.5; pointer-events: none; transition: 0.2s;">
            
            <!-- å­—ä½“æ§åˆ¶ -->
            <div class="control-section">
                <label>å­—ä½“å¤§å° (æ”¯æŒå±€éƒ¨): <span id="fs-val">24</span>px</label>
                <input type="range" id="font-size" min="12" max="150" value="24" oninput="updateTextSize(this.value)">
                
                <div class="row">
                    <div class="col">
                        <label>é¢œè‰²</label>
                        <input type="color" id="text-color" value="#000000" oninput="execCmd('foreColor', this.value)">
                    </div>
                    <div class="col">
                        <label>æ ·å¼</label>
                        <div class="row" style="gap:2px">
                            <button onclick="execCmd('bold')" class="outline"><b>B</b></button>
                            <button onclick="execCmd('italic')" class="outline"><i>I</i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ–‡å­—èƒŒæ™¯æ§åˆ¶ -->
            <div class="control-section">
                <label>èƒŒæ™¯æ‰©å±•æ–¹å‘</label>
                <select id="text-pad-mode" onchange="togglePadMode('text')">
                    <option value="all">ç»Ÿä¸€è°ƒæ•´ (å››å‘¨)</option>
                    <option value="individual">ç‹¬ç«‹è°ƒæ•´ (ä¸Šä¸‹å·¦å³)</option>
                </select>

                <div id="text-pad-all">
                    <label>å¤§å°: <span id="val-text-bg-all">5</span>px</label>
                    <input type="range" id="input-bg-all" min="0" max="100" value="5" oninput="updateTextBgPad('all', this.value)">
                </div>

                <div id="text-pad-ind" style="display:none;">
                    <div class="row"><div class="col"><label>ä¸Š</label><input type="range" id="input-bg-top" min="0" max="100" value="5" oninput="updateTextBgPad('top', this.value)"></div>
                    <div class="col"><label>ä¸‹</label><input type="range" id="input-bg-bottom" min="0" max="100" value="5" oninput="updateTextBgPad('bottom', this.value)"></div></div>
                    <div class="row"><div class="col"><label>å·¦</label><input type="range" id="input-bg-left" min="0" max="100" value="5" oninput="updateTextBgPad('left', this.value)"></div>
                    <div class="col"><label>å³</label><input type="range" id="input-bg-right" min="0" max="100" value="5" oninput="updateTextBgPad('right', this.value)"></div></div>
                </div>

                <div class="row" style="margin-top:10px; border-top:1px dashed #ddd; padding-top:10px;">
                    <div class="col"><label>èƒŒæ™¯è‰²</label><input type="color" id="text-bg-color" value="#FFFF00" oninput="updateTextBgColor()"></div>
                    <div class="col"><label>é€æ˜åº¦</label><input type="range" id="text-bg-opacity" min="0" max="100" value="0" oninput="updateTextBgColor()"></div>
                </div>
            </div>

        </div>
    </div>

    <div style="margin-top:auto">
        <button onclick="downloadImg()" style="height:45px; font-size:15px; font-weight:bold">â¬‡ï¸ å¯¼å‡ºå›¾ç‰‡</button>
    </div>
</div>

<div class="workspace">
    <div id="canvas-box">
        <div id="img-stage">
            <img id="main-img" src="https://picsum.photos/id/28/600/400">
        </div>
    </div>
</div>

<script>
    const imgStage = document.getElementById('img-stage');
    let activeWrapper = null;
    // å…³é”®ï¼šç”¨äºè®°å¿†é€‰åŒºçš„å˜é‡
    let savedRange = null; 

    // ================= 1. æ–‡å­—æ·»åŠ ä¸äº¤äº’ =================
    function addText() {
        const wrapper = document.createElement('div');
        wrapper.className = 'text-wrapper';
        
        const content = document.createElement('div');
        content.className = 'text-content';
        content.contentEditable = true;
        content.spellcheck = false;
        content.innerText = "åŒå‡»è¾“å…¥æ–‡å­—";
        content.style.padding = '5px'; 
        content.style.backgroundColor = 'rgba(0,0,0,0)'; 

        const delBtn = document.createElement('div');
        delBtn.className = 'del-btn';
        delBtn.innerText = 'Ã—';
        delBtn.setAttribute('data-html2canvas-ignore', 'true');

        wrapper.appendChild(content);
        wrapper.appendChild(delBtn);
        imgStage.appendChild(wrapper);

        bindTextEvents(wrapper, content, delBtn);
        activateText(wrapper);
        
        setTimeout(() => {
            content.focus(); 
            document.execCommand('selectAll', false, null);
        }, 50);
    }

    function bindTextEvents(wrapper, content, delBtn) {
        delBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            wrapper.remove();
            if(activeWrapper === wrapper) { activeWrapper = null; savedRange = null; updateUIState(); }
        });

        wrapper.addEventListener('mousedown', (e) => {
            if (e.target === delBtn) return;
            // ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œç‚¹å‡»æ–‡å­—ä¸è§¦å‘æ‹–æ‹½ï¼Œå…è®¸ç”¨æˆ·è°ƒæ•´å…‰æ ‡
            if (wrapper.classList.contains('editing')) { 
                e.stopPropagation(); 
                return; 
            }
            activateText(wrapper);
            startDrag(e, wrapper);
        });

        wrapper.addEventListener('dblclick', () => {
            wrapper.classList.add('editing');
            content.focus();
        });

        content.addEventListener('blur', () => {
            wrapper.classList.remove('editing');
            // è¿™é‡Œä¸ç«‹å³æ¸…é™¤ savedRangeï¼Œå…è®¸ç”¨æˆ·å¤±ç„¦åç«‹åˆ»å»æ‹–æ»‘å—
        });

        // å…³é”®ï¼šç›‘å¬é€‰åŒºå˜åŒ–ï¼Œä¿å­˜ Range
        const saveSelection = () => {
            const sel = window.getSelection();
            if (sel.rangeCount > 0 && wrapper.classList.contains('active')) {
                const range = sel.getRangeAt(0);
                // ç¡®ä¿é€‰åŒºåœ¨å½“å‰å†…å®¹é‡Œ
                if (content.contains(range.commonAncestorContainer)) {
                    savedRange = range.cloneRange();
                }
            }
        };
        
        content.addEventListener('mouseup', saveSelection);
        content.addEventListener('keyup', saveSelection);
        content.addEventListener('click', () => {
            saveSelection();
            syncUI(content);
        });
    }

    function activateText(wrapper) {
        document.querySelectorAll('.text-wrapper').forEach(w => w.classList.remove('active'));
        activeWrapper = wrapper;
        wrapper.classList.add('active');
        updateUIState();
        syncUI(wrapper.querySelector('.text-content'));
    }

    function startDrag(e, wrapper) {
        e.preventDefault(); 
        let startX = e.clientX, startY = e.clientY;
        let initialLeft = wrapper.offsetLeft, initialTop = wrapper.offsetTop;
        wrapper.style.transform = 'translate(-50%, -50%)'; 

        function onMove(ev) {
            wrapper.style.left = (initialLeft + (ev.clientX - startX)) + 'px';
            wrapper.style.top = (initialTop + (ev.clientY - startY)) + 'px';
        }
        function onUp() {
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
        }
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
    }

    // ================= 2. ä¿®å¤ï¼šåŸºäºè®°å¿†é€‰åŒºçš„å±€éƒ¨è°ƒæ•´ =================
    
    function updateTextSize(val) {
        if(!activeWrapper) return;
        document.getElementById('fs-val').innerText = val;
        const content = activeWrapper.querySelector('.text-content');

        // åˆ¤æ–­é€»è¾‘ï¼šå¦‚æœæœ‰ä¿å­˜çš„é€‰åŒºï¼Œä¸”é€‰åŒºä¸æ˜¯ç©ºçš„ï¼ˆcollapsedï¼‰
        if (savedRange && !savedRange.collapsed) {
            
            // æ£€æŸ¥æˆ‘ä»¬é€‰ä¸­çš„æ˜¯å¦å·²ç»æ˜¯è¢«åŒ…è£¹çš„ span
            let container = savedRange.commonAncestorContainer;
            if (container.nodeType === 3) container = container.parentNode; // å¦‚æœæ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œå–çˆ¶çº§

            // ç­–ç•¥ï¼šå¦‚æœå½“å‰é€‰ä¸­åŒºåŸŸçš„çˆ¶çº§æ˜¯ä¸€ä¸ª SPANï¼Œä¸”è¿™ä¸ª SPAN åœ¨ç¼–è¾‘å™¨å†…
            // é‚£ä¹ˆæˆ‘ä»¬è®¤ä¸ºç”¨æˆ·æ˜¯åœ¨æŒç»­æ‹–åŠ¨æ»‘å—è°ƒæ•´è¿™ä¸ª SPAN
            if (container.tagName === 'SPAN' && content.contains(container) && container !== content) {
                container.style.fontSize = val + 'px';
            } else {
                // å¦åˆ™ï¼Œè¿™æ˜¯ä¸€ä¸ªæ–°çš„è°ƒæ•´åŠ¨ä½œï¼Œéœ€è¦æ–°å»º span åŒ…è£¹æ–‡å­—
                const span = document.createElement('span');
                span.style.fontSize = val + 'px';
                
                try {
                    // æå–å†…å®¹å¹¶åŒ…è£¹
                    const fragment = savedRange.extractContents();
                    span.appendChild(fragment);
                    savedRange.insertNode(span);
                    
                    // å…³é”®ï¼šæ›´æ–° savedRange æŒ‡å‘è¿™ä¸ªæ–° span çš„å†…éƒ¨
                    // è¿™æ ·ä¸‹æ¬¡æ»‘å—ç§»åŠ¨ï¼ˆå‡ æ¯«ç§’åï¼‰å°±ä¼šå‘½ä¸­ä¸Šé¢çš„ if åˆ†æ”¯ï¼Œè€Œä¸æ˜¯æ— é™åµŒå¥—
                    savedRange.selectNodeContents(span);
                } catch(e) {
                    console.log('Complex selection, fallback.');
                }
            }
        } else {
            // æ²¡æœ‰é€‰åŒºï¼Œæˆ–è€…é€‰åŒºæ˜¯ç©ºçš„ -> è°ƒæ•´æ•´ä½“
            content.style.fontSize = val + 'px';
        }
    }

    // ================= 3. å…¶ä»–ä¿æŒä¸å˜çš„åŠŸèƒ½ =================
    
    function togglePadMode(target) {
        const mode = document.getElementById(target + '-pad-mode').value;
        document.getElementById(target + '-pad-all').style.display = mode === 'all' ? 'block' : 'none';
        document.getElementById(target + '-pad-ind').style.display = mode === 'individual' ? 'block' : 'none';
    }

    function updateTextBgColor() {
        if(!activeWrapper) return;
        const hex = document.getElementById('text-bg-color').value;
        const opacity = document.getElementById('text-bg-opacity').value;
        const content = activeWrapper.querySelector('.text-content');
        
        const r = parseInt(hex.slice(1,3), 16);
        const g = parseInt(hex.slice(3,5), 16);
        const b = parseInt(hex.slice(5,7), 16);
        content.style.backgroundColor = `rgba(${r}, ${g}, ${b}, ${opacity/100})`;
    }

    function updateTextBgPad(side, val) {
        if(!activeWrapper) return;
        const content = activeWrapper.querySelector('.text-content');
        val = val + 'px';
        if (side === 'all') {
            content.style.padding = val;
            document.getElementById('val-text-bg-all').innerText = parseInt(val);
            ['top','right','bottom','left'].forEach(d => document.getElementById('input-bg-'+d).value = parseInt(val));
        } else {
            content.style['padding' + capitalize(side)] = val;
        }
    }

    function updateCanvasPad(side, val) {
        const box = document.getElementById('canvas-box');
        if(side === 'all') {
            box.style.padding = val + 'px';
            document.getElementById('val-canvas-all').innerText = val;
        } else {
            box.style['padding' + capitalize(side)] = val + 'px';
        }
    }

    function updateCanvasBg() {
        const box = document.getElementById('canvas-box');
        const color = document.getElementById('canvas-bg').value;
        const type = document.getElementById('bg-type').value;
        if(type === 'solid') box.style.background = color;
        else if(type === 'v-grad') box.style.background = `linear-gradient(to bottom, #fff, ${color})`;
        else box.style.background = `linear-gradient(to right, #fff, ${color})`;
    }

    function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

    function execCmd(cmd, val) {
        if(!activeWrapper) return;
        activeWrapper.querySelector('.text-content').focus();
        document.execCommand(cmd, false, val);
    }

    function updateUIState() {
        const controls = document.getElementById('text-controls');
        const status = document.getElementById('text-status');
        if(activeWrapper) {
            controls.style.opacity = '1';
            controls.style.pointerEvents = 'auto';
            status.innerText = "(å·²é€‰ä¸­)";
            status.style.color = "green";
        } else {
            controls.style.opacity = '0.5';
            controls.style.pointerEvents = 'none';
            status.innerText = "(æœªé€‰ä¸­)";
            status.style.color = "#999";
        }
    }

    function syncUI(el) {
        const style = window.getComputedStyle(el);
        const fs = parseInt(style.fontSize);
        document.getElementById('font-size').value = fs;
        document.getElementById('fs-val').innerText = fs;
        
        const pad = parseInt(style.paddingTop);
        document.getElementById('input-bg-all').value = pad;
        document.getElementById('val-text-bg-all').innerText = pad;
    }

    const PRESET_KEY = 'presets_v5';
    function loadPresets() {
        let list = JSON.parse(localStorage.getItem(PRESET_KEY) || '["https://picsum.photos/id/28/200/200"]');
        const div = document.getElementById('preset-list');
        div.innerHTML = '';
        list.forEach((src,i) => {
            div.innerHTML += `<div class="preset-item"><img src="${src}" onclick="document.getElementById('main-img').src='${src}'"><div class="preset-del" onclick="delPreset(${i})">Ã—</div></div>`;
        });
    }
    function saveToPresets() {
        const src = document.getElementById('main-img').src;
        let list = JSON.parse(localStorage.getItem(PRESET_KEY) || '[]');
        if(!list.includes(src)) { list.unshift(src); localStorage.setItem(PRESET_KEY, JSON.stringify(list)); loadPresets(); }
    }
    function delPreset(i) {
        let list = JSON.parse(localStorage.getItem(PRESET_KEY));
        list.splice(i,1); localStorage.setItem(PRESET_KEY, JSON.stringify(list)); loadPresets();
    }
    function handleUpload(inp) {
        if(inp.files[0]) {
            const r = new FileReader();
            r.onload = e => document.getElementById('main-img').src = e.target.result;
            r.readAsDataURL(inp.files[0]);
        }
    }
    function downloadImg() {
        // ç§»é™¤é€‰ä¸­çŠ¶æ€å†æˆªå›¾
        document.querySelectorAll('.text-wrapper').forEach(w => w.classList.remove('active', 'editing'));
        // ç­‰ä¸€ä¸‹æ¸²æŸ“å†æˆªå›¾ï¼Œç¡®ä¿å…‰æ ‡æ¶ˆå¤±
        setTimeout(() => {
            html2canvas(document.getElementById('canvas-box'), { scale:2, useCORS:true, backgroundColor:null }).then(c => {
                const a = document.createElement('a'); a.download = 'image.png'; a.href = c.toDataURL(); a.click();
            });
        }, 100);
    }

    // ç‚¹å‡»ç©ºç™½å–æ¶ˆé€‰ä¸­ï¼Œå¹¶æ¸…ç©ºè®°å¿†é€‰åŒº
    document.querySelector('.workspace').addEventListener('mousedown', (e) => {
        if(e.target.id==='canvas-box' || e.target.classList.contains('workspace')) {
            if(activeWrapper) { 
                activeWrapper.classList.remove('active','editing'); 
                activeWrapper = null; 
                savedRange = null; // æ¸…ç©ºè®°å¿†
                updateUIState(); 
            }
        }
    });
    loadPresets();
</script>
</body>
</html>
