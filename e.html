<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸“ä¸šè§†é¢‘æˆªå›¾æ‹¼æ¥å·¥å…· (è‡ªå®šä¹‰æ­¥è¿›ç‰ˆ)</title>
    <style>
        :root {
            --primary: #007bff;
            --bg: #f4f6f8;
            --panel-bg: #ffffff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Segoe UI", Arial, sans-serif; }
        
        body { background: var(--bg); padding: 20px; height: 100vh; display: flex; flex-direction: column; }
        
        .header {
            text-align: center; margin-bottom: 15px; flex-shrink: 0;
        }
        .header h1 { font-size: 22px; color: #333; margin-bottom: 5px; }
        .hint { color: #666; font-size: 13px; }
        
        /* å¸ƒå±€å®¹å™¨ */
        .main-layout {
            display: flex; gap: 20px; flex: 1; overflow: hidden;
            max-width: 1400px; margin: 0 auto; width: 100%;
        }
        
        /* å·¦ä¾§è§†é¢‘åŒº */
        .video-panel {
            flex: 2; display: flex; flex-direction: column; gap: 10px;
            background: var(--panel-bg); padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            min-width: 0; /* é˜²æ­¢flexæº¢å‡º */
        }
        
        .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .file-btn { position: relative; overflow: hidden; }
        .file-btn input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        
        .btn {
            padding: 6px 12px; border: 1px solid #ccc; background: #fff;
            border-radius: 4px; cursor: pointer; font-size: 13px; transition: 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .btn:hover { background: #f0f0f0; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: white; border: none; }
        .btn-danger { background: #dc3545; color: white; border: none; }

        .fps-wrapper { display: flex; align-items: center; gap: 5px; font-size: 13px; background: #eee; padding: 5px 10px; border-radius: 4px; }
        .fps-wrapper input { width: 40px; text-align: center; border: 1px solid #ccc; border-radius: 3px; }

        /* è§†é¢‘å®¹å™¨ */
        .video-wrapper {
            flex: 1; background: #000; position: relative;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; border-radius: 4px;
        }
        video { max-width: 100%; max-height: 100%; display: block; }
        
        /* é€‰åŒºè¦†ç›–å±‚ */
        .overlay-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }
        
        /* é€‰åŒºæ¡† */
        .selection-box {
            position: absolute;
            border: 2px solid #ff3b30;
            background: rgba(255, 59, 48, 0.1);
            pointer-events: auto;
            cursor: move;
            box-shadow: 0 0 0 2000px rgba(0,0,0,0.5);
        }
        
        /* æ‹–æ‹½æ‰‹æŸ„ */
        .handle {
            position: absolute; width: 10px; height: 10px;
            background: white; border: 1px solid #ff3b30;
            z-index: 10;
        }
        .h-nw { top: -6px; left: -6px; cursor: nw-resize; }
        .h-n  { top: -6px; left: 50%; margin-left: -5px; cursor: n-resize; }
        .h-ne { top: -6px; right: -6px; cursor: ne-resize; }
        .h-w  { top: 50%; left: -6px; margin-top: -5px; cursor: w-resize; }
        .h-e  { top: 50%; right: -6px; margin-top: -5px; cursor: e-resize; }
        .h-sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .h-s  { bottom: -6px; left: 50%; margin-left: -5px; cursor: s-resize; }
        .h-se { bottom: -6px; right: -6px; cursor: se-resize; }

        /* è¿›åº¦æ¡ */
        .progress-area { display: flex; align-items: center; gap: 10px; font-size: 12px; font-family: monospace; }
        .progress-bar { flex: 1; height: 8px; background: #ddd; border-radius: 4px; cursor: pointer; position: relative; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; border-radius: 4px; }

        /* å¸§æ§åˆ¶åŒº */
        .frame-controls {
            display: flex; justify-content: center; gap: 15px; padding: 8px;
            background: #f8f9fa; border-radius: 6px; border: 1px solid #eee;
            flex-wrap: wrap;
        }
        .frame-group { display: flex; align-items: center; gap: 2px; }
        .frame-group span { font-size: 12px; color: #666; margin-right: 4px; }
        .mini-btn { width: 28px; height: 28px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer;}
        
        /* é‡ç‚¹ï¼šè‡ªå®šä¹‰æ­¥è¿›è¾“å…¥æ¡†æ ·å¼ */
        .custom-step-input {
            width: 40px; text-align: center; border: 1px solid var(--primary); 
            border-radius: 3px; color: var(--primary); font-weight: bold;
            height: 28px; margin: 0 2px;
        }

        /* å³ä¾§æ§åˆ¶åŒº */
        .sidebar {
            flex: 1; background: var(--panel-bg); border-radius: 8px;
            padding: 15px; display: flex; flex-direction: column; gap: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            min-width: 300px; max-width: 350px;
        }
        
        .panel-section { border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .panel-title { font-weight: bold; font-size: 14px; margin-bottom: 10px; display: flex; justify-content: space-between; }
        
        .slider-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 12px; }
        .slider-row input[type=range] { flex: 1; }
        .slider-val { width: 35px; text-align: right; font-family: monospace; }

        /* æˆªå›¾åˆ—è¡¨ */
        .shot-list {
            flex: 1; overflow-y: auto; background: #f9f9f9;
            border: 1px solid #eee; border-radius: 6px; padding: 10px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px; align-content: start;
        }
        .shot-item {
            position: relative; border: 2px solid transparent;
            cursor: grab; transition: 0.2s; background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .shot-item:hover { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        .shot-item.dragging { opacity: 0.4; }
        .shot-item img { width: 100%; height: auto; display: block; pointer-events: none; }
        .shot-del {
            position: absolute; top: -5px; right: -5px; width: 18px; height: 18px;
            background: red; color: white; border-radius: 50%; text-align: center;
            line-height: 16px; font-size: 12px; cursor: pointer; display: none;
        }
        .shot-item:hover .shot-del { display: block; }

        /* é”®ç›˜æç¤ºæµ®å±‚ */
        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7); color: white; padding: 10px 20px;
            border-radius: 20px; font-size: 14px; pointer-events: none;
            opacity: 0; transition: opacity 0.3s; z-index: 999;
        }
        .toast.show { opacity: 1; }

    </style>
</head>
<body>

<div class="header">
    <h1>è§†é¢‘æˆªå›¾æ‹¼æ¥å·¥å…·</h1>
    <div class="hint">ç©ºæ ¼: æˆªå›¾ | å›è½¦: ä¸‹è½½ | é”®ç›˜ â† â†’: ä½¿ç”¨"è‡ªå®šä¹‰"æ­¥è¿›å¾®è°ƒ</div>
</div>

<div class="main-layout">
    <!-- å·¦ä¾§ï¼šè§†é¢‘åŒº -->
    <div class="video-panel">
        <div class="toolbar">
            <button class="btn file-btn">
                ğŸ“‚ æ‰“å¼€è§†é¢‘
                <input type="file" id="videoInput" accept="video/*">
            </button>
            <div class="fps-wrapper">
                <label>å¸§ç‡FPS:</label>
                <input type="number" id="fpsInput" value="30" min="1" max="144">
            </div>
            <button class="btn btn-danger" id="clearAllBtn">æ¸…ç©ºåˆ—è¡¨</button>
            <span id="statusText" style="font-size:12px; color:#666; margin-left:auto;">ç­‰å¾…è½½å…¥...</span>
        </div>

        <div class="video-wrapper" id="videoContainer">
            <video id="videoPlayer"></video>
            <div class="overlay-layer" id="overlayLayer">
                <!-- é€‰åŒºæ¡† (åŠ¨æ€ç”Ÿæˆ) -->
                <div class="selection-box" id="selectionBox" style="display:none;">
                    <div class="handle h-nw" data-dir="nw"></div>
                    <div class="handle h-n"  data-dir="n"></div>
                    <div class="handle h-ne" data-dir="ne"></div>
                    <div class="handle h-w"  data-dir="w"></div>
                    <div class="handle h-e"  data-dir="e"></div>
                    <div class="handle h-sw" data-dir="sw"></div>
                    <div class="handle h-s"  data-dir="s"></div>
                    <div class="handle h-se" data-dir="se"></div>
                </div>
            </div>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div class="progress-area">
            <span id="currTime">00:00</span>
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <span id="totalTime">00:00</span>
        </div>

        <!-- å¸§æ§åˆ¶æŒ‰é’® -->
        <div class="frame-controls">
            <div class="frame-group" style="border-right: 1px solid #ddd; padding-right: 10px;">
                <span style="color:var(--primary); font-weight:bold;">è‡ªå®šä¹‰/é”®ç›˜:</span>
                <button class="btn mini-btn" onclick="seekCustom(-1)">â†</button>
                <input type="number" id="customStepInput" class="custom-step-input" value="15" min="1" title="é”®ç›˜å·¦å³é”®æ­¥è¿›å¸§æ•°">
                <button class="btn mini-btn" onclick="seekCustom(1)">â†’</button>
            </div>
            
            <div class="frame-group">
                <span>1å¸§:</span>
                <button class="btn mini-btn" onclick="seekFrame(-1)">â†</button>
                <button class="btn mini-btn" onclick="seekFrame(1)">â†’</button>
            </div>
            <div class="frame-group">
                <span>5å¸§:</span>
                <button class="btn mini-btn" onclick="seekFrame(-5)">â†</button>
                <button class="btn mini-btn" onclick="seekFrame(5)">â†’</button>
            </div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šæ§åˆ¶ä¸åˆ—è¡¨ -->
    <div class="sidebar">
        <!-- é€‰åŒºå‚æ•° -->
        <div class="panel-section">
            <div class="panel-title">é€‰åŒºå‚æ•° (px)</div>
            <div class="slider-row">
                <span>å®½ W</span>
                <input type="range" id="sliderW" min="10" value="200">
                <span class="slider-val" id="valW">200</span>
            </div>
            <div class="slider-row">
                <span>é«˜ H</span>
                <input type="range" id="sliderH" min="10" value="150">
                <span class="slider-val" id="valH">150</span>
            </div>
            <div class="slider-row">
                <span>X è½´</span>
                <input type="range" id="sliderX" min="0" value="0">
                <span class="slider-val" id="valX">0</span>
            </div>
            <div class="slider-row">
                <span>Y è½´</span>
                <input type="range" id="sliderY" min="0" value="0">
                <span class="slider-val" id="valY">0</span>
            </div>
            <button class="btn" id="resetSelBtn" style="width:100%; margin-top:5px;">é‡ç½®é€‰åŒºåˆ°å±…ä¸­</button>
        </div>

        <!-- åŠ¨ä½œåŒº -->
        <div class="panel-section">
            <button class="btn btn-success" id="captureBtn" style="width:100%; height:40px; font-size:15px; margin-bottom:10px;">ğŸ“¸ æˆªå›¾ (ç©ºæ ¼)</button>
            <button class="btn btn-primary" id="downloadBtn" style="width:100%; height:40px; font-size:15px;">ğŸ’¾ æ‹¼æ¥å¹¶ä¸‹è½½ (å›è½¦)</button>
        </div>

        <!-- é¢„è§ˆåˆ—è¡¨ -->
        <div class="panel-title">
            æˆªå›¾é˜Ÿåˆ— <span id="shotCount" style="color:var(--primary)">(0)</span>
        </div>
        <div class="shot-list" id="shotList">
            <div style="text-align:center; color:#999; padding:20px; grid-column:1/-1;">æš‚æ— æˆªå›¾</div>
        </div>
    </div>
</div>

<div class="toast" id="toast">æç¤ºä¿¡æ¯</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- å…¨å±€å˜é‡ ---
    const state = {
        fps: 30,
        customStep: 15, // é»˜è®¤è‡ªå®šä¹‰æ­¥è¿›å¸§æ•°
        videoUrl: null,
        rect: { x: 0, y: 0, w: 200, h: 150 },
        screenshots: [],
        isDragging: false,
        dragAction: null,
        dragStart: { x: 0, y: 0 },
        rectStart: { ...this.rect },
        videoMetrics: { scale: 1, offsetX: 0, offsetY: 0, displayW: 0, displayH: 0 }
    };

    // --- DOM å…ƒç´  ---
    const els = {
        video: document.getElementById('videoPlayer'),
        videoContainer: document.getElementById('videoContainer'),
        fileInput: document.getElementById('videoInput'),
        selBox: document.getElementById('selectionBox'),
        overlay: document.getElementById('overlayLayer'),
        shotList: document.getElementById('shotList'),
        fpsInput: document.getElementById('fpsInput'),
        customStepInput: document.getElementById('customStepInput'), // æ–°å¢è¾“å…¥æ¡†
        sliders: {
            w: document.getElementById('sliderW'),
            h: document.getElementById('sliderH'),
            x: document.getElementById('sliderX'),
            y: document.getElementById('sliderY')
        },
        vals: {
            w: document.getElementById('valW'),
            h: document.getElementById('valH'),
            x: document.getElementById('valX'),
            y: document.getElementById('valY')
        },
        progressBar: document.getElementById('progressBar'),
        progressFill: document.getElementById('progressFill'),
        toast: document.getElementById('toast')
    };

    // --- 1. è§†é¢‘åŠ è½½ä¸åŸºç¡€è®¾ç½® ---
    
    // ç›‘å¬ FPS è®¾ç½®
    els.fpsInput.addEventListener('change', (e) => state.fps = parseInt(e.target.value) || 30);
    
    // ç›‘å¬ è‡ªå®šä¹‰æ­¥è¿› è®¾ç½®
    els.customStepInput.addEventListener('change', (e) => {
        let val = parseInt(e.target.value);
        if (val < 1) val = 1;
        state.customStep = val;
    });

    els.fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (state.videoUrl) URL.revokeObjectURL(state.videoUrl);
        state.videoUrl = URL.createObjectURL(file);
        els.video.src = state.videoUrl;
        
        els.video.onloadedmetadata = () => {
            updateVideoMetrics();
            resetSelection();
            showToast("è§†é¢‘å·²åŠ è½½");
            document.getElementById('statusText').innerText = `${file.name} (${Math.floor(els.video.duration)}s)`;
            updateTimeDisplay();
        };
    });

    window.addEventListener('resize', () => {
        if(els.video.src) {
            updateVideoMetrics();
            renderSelection();
        }
    });

    function updateVideoMetrics() {
        const containerRatio = els.videoContainer.clientWidth / els.videoContainer.clientHeight;
        const videoRatio = els.video.videoWidth / els.video.videoHeight;
        
        if (videoRatio > containerRatio) {
            state.videoMetrics.displayW = els.videoContainer.clientWidth;
            state.videoMetrics.displayH = els.videoContainer.clientWidth / videoRatio;
            state.videoMetrics.offsetX = 0;
            state.videoMetrics.offsetY = (els.videoContainer.clientHeight - state.videoMetrics.displayH) / 2;
        } else {
            state.videoMetrics.displayH = els.videoContainer.clientHeight;
            state.videoMetrics.displayW = els.videoContainer.clientHeight * videoRatio;
            state.videoMetrics.offsetY = 0;
            state.videoMetrics.offsetX = (els.videoContainer.clientWidth - state.videoMetrics.displayW) / 2;
        }
        
        els.sliders.w.max = state.videoMetrics.displayW;
        els.sliders.h.max = state.videoMetrics.displayH;
        els.sliders.x.max = state.videoMetrics.displayW;
        els.sliders.y.max = state.videoMetrics.displayH;
    }

    // --- 2. é€‰åŒºäº¤äº’é€»è¾‘ ---

    function resetSelection() {
        state.rect.w = Math.floor(state.videoMetrics.displayW * 0.4);
        state.rect.h = Math.floor(state.videoMetrics.displayH * 0.4);
        state.rect.x = Math.floor((state.videoMetrics.displayW - state.rect.w) / 2);
        state.rect.y = Math.floor((state.videoMetrics.displayH - state.rect.h) / 2);
        els.selBox.style.display = 'block';
        renderSelection();
    }
    document.getElementById('resetSelBtn').onclick = resetSelection;

    function renderSelection() {
        const absX = state.rect.x + state.videoMetrics.offsetX;
        const absY = state.rect.y + state.videoMetrics.offsetY;
        
        els.selBox.style.transform = `translate(${absX}px, ${absY}px)`;
        els.selBox.style.width = `${state.rect.w}px`;
        els.selBox.style.height = `${state.rect.h}px`;

        els.sliders.w.value = state.rect.w; els.vals.w.innerText = state.rect.w;
        els.sliders.h.value = state.rect.h; els.vals.h.innerText = state.rect.h;
        els.sliders.x.value = state.rect.x; els.vals.x.innerText = state.rect.x;
        els.sliders.y.value = state.rect.y; els.vals.y.innerText = state.rect.y;
    }

    ['w','h','x','y'].forEach(key => {
        els.sliders[key].addEventListener('input', (e) => {
            let val = parseInt(e.target.value);
            if(key === 'x' && val + state.rect.w > state.videoMetrics.displayW) val = state.videoMetrics.displayW - state.rect.w;
            if(key === 'y' && val + state.rect.h > state.videoMetrics.displayH) val = state.videoMetrics.displayH - state.rect.h;
            state.rect[key] = val;
            renderSelection();
        });
    });

    els.selBox.addEventListener('mousedown', (e) => {
        e.stopPropagation();
        state.isDragging = true;
        state.dragStart = { x: e.clientX, y: e.clientY };
        state.rectStart = { ...state.rect };
        state.dragAction = e.target.classList.contains('handle') ? e.target.dataset.dir : 'move';
    });

    window.addEventListener('mousemove', (e) => {
        if (!state.isDragging) return;
        e.preventDefault();

        const dx = e.clientX - state.dragStart.x;
        const dy = e.clientY - state.dragStart.y;
        const s = state.rectStart;
        const limitW = state.videoMetrics.displayW;
        const limitH = state.videoMetrics.displayH;

        let newR = { ...state.rect };

        if (state.dragAction === 'move') {
            newR.x = Math.max(0, Math.min(s.x + dx, limitW - s.w));
            newR.y = Math.max(0, Math.min(s.y + dy, limitH - s.h));
        } else {
            const dir = state.dragAction;
            if (dir.includes('e')) newR.w = Math.min(Math.max(20, s.w + dx), limitW - s.x);
            if (dir.includes('s')) newR.h = Math.min(Math.max(20, s.h + dy), limitH - s.y);
            if (dir.includes('w')) {
                const actualDx = Math.min(dx, s.w - 20);
                newR.x = Math.max(0, s.x + actualDx);
                newR.w = s.w - (newR.x - s.x);
            }
            if (dir.includes('n')) {
                const actualDy = Math.min(dy, s.h - 20);
                newR.y = Math.max(0, s.y + actualDy);
                newR.h = s.h - (newR.y - s.y);
            }
        }
        state.rect = newR;
        renderSelection();
    });

    window.addEventListener('mouseup', () => state.isDragging = false);

    // --- 3. æˆªå›¾ä¸ä¸‹è½½ ---

    document.getElementById('captureBtn').addEventListener('click', capture);
    
    // é”®ç›˜å¿«æ·é”®æ§åˆ¶ (åŒ…æ‹¬æ–°åŠŸèƒ½)
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT') return;
        if (e.code === 'Space') { e.preventDefault(); capture(); }
        if (e.code === 'Enter') { e.preventDefault(); download(); }
        // ä½¿ç”¨ state.customStep è¿›è¡Œè·³è½¬
        if (e.code === 'ArrowLeft') { e.preventDefault(); seekFrame(-state.customStep); showToast(`åé€€ ${state.customStep} å¸§`); }
        if (e.code === 'ArrowRight') { e.preventDefault(); seekFrame(state.customStep); showToast(`å‰è¿› ${state.customStep} å¸§`); }
    });

    function capture() {
        if (!els.video.src) return showToast("è¯·å…ˆåŠ è½½è§†é¢‘");
        
        const canvas = document.createElement('canvas');
        const scaleX = els.video.videoWidth / state.videoMetrics.displayW;
        const scaleY = els.video.videoHeight / state.videoMetrics.displayH;

        const sx = state.rect.x * scaleX;
        const sy = state.rect.y * scaleY;
        const sw = state.rect.w * scaleX;
        const sh = state.rect.h * scaleY;

        canvas.width = sw;
        canvas.height = sh;
        const ctx = canvas.getContext('2d');
        
        ctx.drawImage(els.video, sx, sy, sw, sh, 0, 0, sw, sh);
        addScreenshot(canvas.toDataURL('image/jpeg'));
        showToast("å·²æˆªå›¾");
    }

    function addScreenshot(dataUrl) {
        state.screenshots.push({ id: Date.now(), dataUrl: dataUrl });
        renderShotList();
    }

    function renderShotList() {
        document.getElementById('shotCount').innerText = `(${state.screenshots.length})`;
        els.shotList.innerHTML = '';
        
        if(state.screenshots.length === 0) {
            els.shotList.innerHTML = '<div style="text-align:center; color:#999; padding:20px; grid-column:1/-1;">æš‚æ— æˆªå›¾</div>';
            return;
        }

        state.screenshots.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'shot-item';
            div.draggable = true;
            div.innerHTML = `<img src="${item.dataUrl}"><div class="shot-del">Ã—</div>`;
            
            div.querySelector('.shot-del').onclick = (e) => {
                e.stopPropagation();
                state.screenshots.splice(index, 1);
                renderShotList();
            };

            div.ondragstart = (e) => { e.dataTransfer.setData('idx', index); div.classList.add('dragging'); };
            div.ondragend = () => div.classList.remove('dragging');
            div.ondragover = (e) => e.preventDefault();
            div.ondrop = (e) => {
                e.preventDefault();
                const from = e.dataTransfer.getData('idx');
                const moved = state.screenshots.splice(from, 1)[0];
                state.screenshots.splice(index, 0, moved);
                renderShotList();
            };
            els.shotList.appendChild(div);
        });
    }

    document.getElementById('clearAllBtn').onclick = () => {
        if(state.screenshots.length > 0 && confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰æˆªå›¾å—ï¼Ÿ")) {
            state.screenshots = [];
            renderShotList();
        }
    };

    document.getElementById('downloadBtn').addEventListener('click', download);
    
    function download() {
        if (state.screenshots.length === 0) return showToast("åˆ—è¡¨ä¸ºç©º");
        showToast("æ­£åœ¨ç”Ÿæˆ...");

        const promises = state.screenshots.map(s => {
            return new Promise(resolve => {
                const img = new Image();
                img.src = s.dataUrl;
                img.onload = () => resolve(img);
            });
        });

        Promise.all(promises).then(images => {
            let w = 0;
            let h = 0;
            images.forEach(img => {
                w = Math.max(w, img.width);
                h += img.height;
            });

            const canvas = document.createElement('canvas');
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#fff';
            ctx.fillRect(0,0,w,h);

            let y = 0;
            images.forEach(img => {
                ctx.drawImage(img, 0, y);
                y += img.height;
            });

            const link = document.createElement('a');
            link.download = `æ‹¼æ¥æˆªå›¾_${Date.now()}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
            showToast("ä¸‹è½½æˆåŠŸ");
        });
    }

    // --- 4. æ’­æ”¾æ§åˆ¶ (å«è‡ªå®šä¹‰æ­¥è¿›) ---
    
    window.seekFrame = (frames) => {
        if (!els.video.src) return;
        els.video.pause();
        els.video.currentTime += frames * (1 / state.fps);
    };

    // æ–°å¢å‡½æ•°ï¼šè‡ªå®šä¹‰æ­¥è¿›æ§åˆ¶
    window.seekCustom = (direction) => {
        const frames = state.customStep * direction; // direction æ˜¯ 1 æˆ– -1
        seekFrame(frames);
        showToast(`${direction > 0 ? 'å‰è¿›' : 'åé€€'} ${state.customStep} å¸§`);
    }

    els.progressBar.addEventListener('click', (e) => {
        if (!els.video.duration) return;
        const rect = els.progressBar.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        els.video.currentTime = percent * els.video.duration;
    });

    els.video.addEventListener('timeupdate', updateTimeDisplay);

    function updateTimeDisplay() {
        const cur = els.video.currentTime;
        const dur = els.video.duration || 0;
        document.getElementById('currTime').innerText = formatTime(cur);
        document.getElementById('totalTime').innerText = formatTime(dur);
        const pct = (cur / dur) * 100;
        els.progressFill.style.width = `${pct}%`;
    }

    function formatTime(s) {
        const m = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        const ms = Math.floor((s % 1) * 100);
        return `${m}:${sec.toString().padStart(2,'0')}`;
    }

    function showToast(msg) {
        els.toast.innerText = msg;
        els.toast.classList.add('show');
        setTimeout(() => els.toast.classList.remove('show'), 1500);
    }
});
</script>
</body>
</html>
