<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ–‡å­—å›¾ç‰‡ç”Ÿæˆå·¥å…· (æ–‡ä»¶å¤¹ç›´å†™ç‰ˆ)</title>
<style>
* { 
    box-sizing: border-box; margin: 0; padding: 0; 
    font-family: 'Microsoft YaHei', sans-serif;
}
body { 
    background: #f5f7fa; padding: 20px; display: flex; 
    justify-content: center; height: 100vh; overflow: hidden;
}
.container { 
    display: flex; width: 100%; max-width: 1400px; gap: 20px; height: 100%;
}
.left-panel, .right-panel {
    background: #fff; padding: 20px; border-radius: 12px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; 
    flex-direction: column; height: 100%;
}
.left-panel { flex: 1.2; }
.right-panel { flex: 0.8; overflow-y: auto; }

h2 { font-size: 18px; color: #3498db; margin-bottom: 15px; flex-shrink: 0; }

/* é¢„è§ˆåŒº */
.preview-section {
    background: #eaf2fb; border: 2px dashed #bdc3c7; border-radius: 8px;
    padding: 10px; margin-bottom: 20px; min-height: 200px;
    display: flex; flex-direction: column; align-items: center; 
    justify-content: center; position: relative; flex-shrink: 0;
}
.preview-section h3 {
    position: absolute; top: 10px; left: 10px; font-size: 14px; 
    color: #7f8c8d; margin: 0; background: rgba(255,255,255,0.8); 
    padding: 2px 6px; border-radius: 4px;
}
#previewImage {
    max-width: 100%; max-height: 300px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    border: 1px solid #ddd; background: white; display: none;
}
.preview-placeholder { color: #95a5a6; font-size: 14px; }

/* æ§ä»¶ */
.file-input-label { 
    display: block; width: 100%; padding: 12px; font-size: 14px; 
    border: 2px dashed #3498db; border-radius: 8px; background: #fff; 
    color: #3498db; cursor: pointer; text-align: center;
    transition: all 0.3s ease; margin-bottom: 10px; flex-shrink: 0;
}
.file-input-label:hover { background: #eaf2fb; }
#fileInput { display: none; }
.selected-files { font-size: 12px; color: #7f8c8d; margin-bottom: 15px; text-align: center; flex-shrink: 0; }

button { 
    width: 100%; padding: 12px; font-size: 15px; font-weight: bold;
    border: none; border-radius: 6px; color: #fff; cursor: pointer;
    transition: opacity 0.3s ease; margin-top: 10px;
}
button:hover { opacity: 0.9; }
#generateBtn { background: #27ae60; margin-top: auto; } /* ç»¿è‰²æŒ‰é’® */

.progress-bar {
    width: 100%; height: 10px; background: #ecf0f1;
    border-radius: 5px; margin-top: 10px; overflow: hidden; display: none; flex-shrink: 0;
}
.progress { height: 100%; background: #2ecc71; width: 0%; transition: width 0.3s ease; }
.status { margin-top: 10px; font-size: 12px; color: #e74c3c; text-align: center; min-height: 20px; flex-shrink: 0; }

/* ç¼–è¾‘å™¨åˆ—è¡¨ */
.text-editor { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
.text-list { flex: 1; overflow-y: auto; border: 1px solid #e1e8ed; border-radius: 6px; padding: 10px; background: #fafbfc; }

.text-item { margin-bottom: 20px; border-bottom: 1px solid #e1e8ed; padding-bottom: 20px; }
.text-item:last-child { border-bottom: none; margin-bottom: 0; }
.text-item-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: #34495e; font-weight: bold; }

/* è¾“å…¥æ¡†ä¸æ ‡çº¢ */
.text-item-content-wrapper, .sub-item-content-wrapper { position: relative; width: 100%; background: #fff; }

.text-item-content, .line-guide,
.sub-item-content, .sub-line-guide {
    font-family: "Microsoft YaHei", sans-serif; font-size: 14px; line-height: 1.6;
    padding: 10px; border: 1px solid #d1d9e0; border-radius: 4px;
    width: 100%; box-sizing: border-box; white-space: pre-wrap; word-break: break-all; letter-spacing: 0;
}

.text-item-content, .sub-item-content {
    position: relative; z-index: 2; background: transparent; color: #2c3e50;
    min-height: 80px; resize: vertical; display: block;
}
.text-item-content:focus, .sub-item-content:focus {
    outline: none; border-color: #3498db; background: rgba(255, 255, 255, 0.1);
}

.line-guide, .sub-line-guide {
    position: absolute; top: 0; left: 0; z-index: 1; color: transparent;
    border-color: transparent; pointer-events: none; overflow: hidden; height: 100%;
}

.guide-char {
    color: #c0392b; background-color: #fadbd8; border-radius: 2px;
    box-shadow: 0 0 0 1px #e6b0aa; display: inline-block;
}

.file-type-badge { padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 8px; color: white; }
.badge-image { background: #3498db; }
.badge-text { background: #27ae60; }

.sub-items-container { margin-left: 20px; margin-top: 10px; border-left: 2px solid #eee; padding-left: 10px; }
.sub-item { margin-top: 10px; position: relative; }
.add-subitem-btn { float: right; background: #3498db; width: 24px; height: 24px; border-radius: 50%; padding: 0; margin: 0; font-size: 16px; line-height: 1; cursor: pointer; border: none; color: white; }
.special-name-btn { position: absolute; left: -30px; top: 28px; width: 20px; height: 20px; font-size: 10px; padding: 0; background: #e74c3c; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; color: white; border-radius: 2px; }
.special-name-btn.active { background: #27ae60; }

</style>
</head>
<body>
<div class="container">
    <div class="left-panel">
        <h2>æ–‡å­—ç¼–è¾‘åŒºåŸŸ</h2>
        <div style="font-size:12px; color:#7f8c8d; margin-bottom:10px; background:#fef9e7; padding:5px; border-radius:4px;">
            ğŸ’¡ æç¤ºï¼šä¸»å†…å®¹æ¯è¡Œç¬¬15ä¸ªå­—æ ‡çº¢ï¼Œæ¬¡çº§å†…å®¹æ¯è¡Œç¬¬26ä¸ªå­—æ ‡çº¢ã€‚
        </div>
        <div class="text-editor">
            <div class="text-list" id="textList">
                <div style="text-align:center; color:#bdc3c7; padding:40px;">è¯·å…ˆåœ¨å³ä¾§é€‰æ‹©æ–‡ä»¶</div>
            </div>
        </div>
    </div>
    
    <div class="right-panel">
        <h2>å›¾ç‰‡ç”Ÿæˆå·¥å…·</h2>

        <div class="preview-section">
            <h3>å®æ—¶é¢„è§ˆ</h3>
            <img id="previewImage" src="" alt="é¢„è§ˆå›¾">
            <div id="previewPlaceholder" class="preview-placeholder">ç‚¹å‡»å·¦ä¾§è¾“å…¥æ¡†æŸ¥çœ‹é¢„è§ˆ</div>
        </div>
        
        <label for="fileInput" class="file-input-label">ğŸ“ é€‰æ‹©å›¾ç‰‡æˆ–æ–‡æœ¬æ–‡ä»¶ (å¤šé€‰)</label>
        <input type="file" id="fileInput" multiple accept="image/*,.txt">
        <div class="selected-files" id="selectedFiles">æœªé€‰æ‹©æ–‡ä»¶</div>
        
        <button id="generateBtn">ğŸ“‚ é€‰æ‹©æ–‡ä»¶å¤¹å¹¶ä¿å­˜æ‰€æœ‰å›¾ç‰‡</button>
        
        <div class="progress-bar" id="progressBar">
            <div class="progress" id="progress"></div>
        </div>
        <div class="status" id="status"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
    const fileInput = document.getElementById('fileInput');
    const selectedFiles = document.getElementById('selectedFiles');
    const generateBtn = document.getElementById('generateBtn');
    const status = document.getElementById('status');
    const progressBar = document.getElementById('progressBar');
    const progress = document.getElementById('progress');
    const textList = document.getElementById('textList');
    const previewImage = document.getElementById('previewImage');
    const previewPlaceholder = document.getElementById('previewPlaceholder');
    
    let files = [];
    let textContents = [];
    let subItemsData = {};
    let specialNameFlags = {};

    // --- é€»è¾‘ 1: ç”»å¸ƒæ¸²æŸ“ ---
    function renderMainCanvas(index) {
        const item = files[index];
        let fileName = item.file.name;
        let fullName = fileName.replace(/\.[^/.]+$/, "");
        let match = fullName.match(/^(\d+)[-_ \.]*(.*)$/);
        let number = match ? match[1] : '';
        let actualName = match ? match[2].trim() : fullName;
        
        let text = textContents[index];

        const canvasWidth = 900;
        const fontSizeNumber = 80;
        const fontSizeText = 50;
        const fontSizeDaily = 80;
        const lineGap = 6;

        const lines = text.split('\n');
        const lineHeight = fontSizeText + lineGap;
        let canvasHeight, paddingTop;
        
        if (number === '1') {
            const emptyLineHeight = fontSizeDaily;
            const dailyHeight = fontSizeDaily;
            const numberHeight = fontSizeNumber;
            const textHeight = lines.length * lineHeight - lineGap;
            canvasHeight = emptyLineHeight * 2 + dailyHeight + numberHeight + textHeight + 1;
            paddingTop = 0;
        } else {
            paddingTop = 160;
            canvasHeight = paddingTop + fontSizeNumber + lines.length * lineHeight - lineGap + 1;
        }
        if(canvasHeight < 100) canvasHeight = 100;

        const canvas = document.createElement('canvas');
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        const ctx = canvas.getContext('2d');

        ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvasWidth,canvasHeight);
        ctx.fillStyle = '#000'; ctx.textAlign = 'center';

        if (number === '1') {
            let currentY = fontSizeDaily;
            ctx.font = `bold ${fontSizeDaily}px Microsoft YaHei`;
            ctx.textBaseline = 'top'; ctx.fillText("ã€æ¯æ—¥æ‚å›¾ã€‘", canvasWidth/2, currentY);
            currentY += fontSizeDaily * 2;
            ctx.font = `bold ${fontSizeNumber}px Microsoft YaHei`;
            ctx.fillText(number, canvasWidth/2, currentY);
            currentY += fontSizeNumber;
            ctx.font = `${fontSizeText}px Microsoft YaHei`;
            lines.forEach((line,idx)=>{
                if(idx === lines.length - 1){
                    ctx.textBaseline = 'bottom'; ctx.fillText(line, canvasWidth/2, canvasHeight - 1);
                } else {
                    ctx.textBaseline = 'top'; ctx.fillText(line, canvasWidth/2, currentY + idx * lineHeight);
                }
            });
        } else {
            ctx.font = `bold ${fontSizeNumber}px Microsoft YaHei`;
            ctx.textBaseline = 'middle'; ctx.fillText(number, canvasWidth/2, paddingTop + fontSizeNumber/2);
            ctx.font = `${fontSizeText}px Microsoft YaHei`;
            lines.forEach((line,idx)=>{
                if(idx === lines.length - 1){
                    ctx.textBaseline = 'bottom'; ctx.fillText(line, canvasWidth/2, canvasHeight - 1);
                } else {
                    ctx.textBaseline = 'top'; ctx.fillText(line, canvasWidth/2, paddingTop + fontSizeNumber + idx * lineHeight);
                }
            });
        }
        return { canvas, number, fullName };
    }

    function renderSubCanvas(mainIndex, subIndex) {
        const mainItem = files[mainIndex];
        let fullName = mainItem.file.name.replace(/\.[^/.]+$/, "");
        let match = fullName.match(/^(\d+)[-_ \.]*(.*)$/);
        let mainNumber = match ? match[1] : '';
        
        const subText = (subItemsData[mainIndex] && subItemsData[mainIndex][subIndex]) || '';

        const canvasWidth = 900;
        const fontSizeText = 35;
        const lineGap = 6;
        const lines = subText.split('\n');
        const lineHeight = fontSizeText + lineGap;
        const paddingTop = 10;
        const canvasHeight = paddingTop + lines.length * lineHeight + 10;

        const canvas = document.createElement('canvas');
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        const ctx = canvas.getContext('2d');

        ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvasWidth,canvasHeight);
        ctx.fillStyle = '#000'; ctx.globalAlpha = 0.5;

        ctx.font = `${fontSizeText}px Microsoft YaHei`;
        ctx.textAlign = 'left'; ctx.textBaseline = 'top';
        lines.forEach((line, idx) => { ctx.fillText(line, 10, paddingTop + idx * lineHeight); });
        ctx.globalAlpha = 1.0;
        return { canvas, mainNumber };
    }

    function updatePreview(type, mainIndex, subIndex = null) {
        let renderResult;
        if (type === 'main') renderResult = renderMainCanvas(mainIndex);
        else renderResult = renderSubCanvas(mainIndex, subIndex);
        if (renderResult && renderResult.canvas) {
            previewImage.src = renderResult.canvas.toDataURL('image/png');
            previewImage.style.display = 'block';
            previewPlaceholder.style.display = 'none';
        }
    }

    // --- é€»è¾‘ 2: æ–‡ä»¶åŠ è½½ ---
    fileInput.addEventListener('change', async function(){
        const selectedFilesList = Array.from(fileInput.files);
        const imageFiles = selectedFilesList.filter(f => f.type.startsWith('image/'));
        const txtFiles = selectedFilesList.filter(f => f.name.endsWith('.txt'));
        
        const txtFileContents = await Promise.all(txtFiles.map(async f => {
            try { return { name: f.name, content: await f.text() }; } 
            catch(e) { return { name: f.name, content: "" }; }
        }));
        
        files = [
            ...imageFiles.map(f => ({ type: 'image', file: f })),
            ...txtFiles.map((f, i) => ({ type: 'text', file: f, content: txtFileContents[i].content }))
        ].sort((a, b) => {
            const getNum = n => (n.match(/^(\d+)/) || [0,0])[1];
            return parseInt(getNum(a.file.name)) - parseInt(getNum(b.file.name));
        });
        
        textContents = [];
        subItemsData = {};
        specialNameFlags = {};
        files.forEach((_, i) => { subItemsData[i] = []; specialNameFlags[i] = []; });
        
        selectedFiles.textContent = files.length ? `å·²åŠ è½½ ${files.length} ä¸ªæ–‡ä»¶` : 'æœªé€‰æ‹©æ–‡ä»¶';
        updateTextEditor();
    });

    // --- é€»è¾‘ 3: ç•Œé¢æ›´æ–° (é˜²é‡ç½®) ---
    function updateTextEditor() {
        textList.innerHTML = '';
        if (files.length === 0) {
            textList.innerHTML = `<div style="text-align:center; color:#bdc3c7; padding:40px;">åˆ—è¡¨ä¸ºç©º</div>`;
            return;
        }
        files.forEach((item, index) => {
            let fileName = item.file.name;
            let match = fileName.replace(/\.[^/.]+$/, "").match(/^(\d+)[-_ \.]*(.*)$/);
            let number = match ? match[1] : 'æ— ';
            let actualName = match ? match[2].trim() : fileName;

            if (textContents[index] === undefined) {
                textContents[index] = item.type === 'image' ? actualName : (item.content || "");
            }
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'text-item';
            itemDiv.innerHTML = `
                <div class="text-item-header">
                    <span>${fileName} <span class="file-type-badge ${item.type==='image'?'badge-image':'badge-text'}">${item.type==='image'?'å›¾':'æ–‡'}</span></span>
                    <span>åºå·: ${number}</span>
                </div>
                <div class="text-item-content-wrapper">
                    <button class="add-subitem-btn" data-index="${index}" title="æ·»åŠ æ¬¡çº§å†…å®¹">+</button>
                    <textarea class="text-item-content" data-type="main" data-index="${index}">${textContents[index]}</textarea>
                    <div class="line-guide"></div>
                </div>
                <div class="sub-items-container" id="sub-container-${index}"></div>
            `;
            
            const subContainer = itemDiv.querySelector('.sub-items-container');
            if (subItemsData[index]) {
                subItemsData[index].forEach((txt, subIdx) => {
                    renderSubItemDOM(subContainer, index, subIdx, txt, number);
                });
            }
            textList.appendChild(itemDiv);
        });
        bindEditorEvents();
    }

    function renderSubItemDOM(container, mainIndex, subIndex, text, mainNumber) {
        const isSpecial = specialNameFlags[mainIndex] && specialNameFlags[mainIndex][subIndex];
        const div = document.createElement('div');
        div.className = 'sub-item';
        div.innerHTML = `
            <div style="font-size:12px; color:#95a5a6; margin-bottom:4px; display:flex; justify-content:space-between;">
                <span>æ¬¡çº§ ${subIndex + 1}</span>
                <span>${mainNumber}.${isSpecial?'æœ€æœ€æœ€':subIndex+1}</span>
            </div>
            <div class="sub-item-content-wrapper">
                <textarea class="sub-item-content" data-type="sub" data-main="${mainIndex}" data-sub="${subIndex}">${text}</textarea>
                <div class="sub-line-guide"></div>
            </div>
            <button class="special-name-btn ${isSpecial?'active':''}" data-main="${mainIndex}" data-sub="${subIndex}">ç‰¹</button>
        `;
        container.appendChild(div);
    }

    function bindEditorEvents() {
        document.querySelectorAll('textarea').forEach(textarea => {
            if(textarea.classList.contains('text-item-content')) updateLineGuide(textarea, 15);
            else updateLineGuide(textarea, 26);

            textarea.addEventListener('input', function() {
                const val = this.value;
                if (this.dataset.type === 'main') {
                    textContents[this.dataset.index] = val;
                    updateLineGuide(this, 15);
                    updatePreview('main', this.dataset.index);
                } else {
                    subItemsData[this.dataset.main][this.dataset.sub] = val;
                    updateLineGuide(this, 26);
                    updatePreview('sub', this.dataset.main, this.dataset.sub);
                }
            });
            textarea.addEventListener('focus', function() {
                if (this.dataset.type === 'main') updatePreview('main', this.dataset.index);
                else updatePreview('sub', this.dataset.main, this.dataset.sub);
            });
            textarea.addEventListener('scroll', function() {
                const guide = this.nextElementSibling;
                if (guide) guide.scrollTop = this.scrollTop;
            });
        });

        document.querySelectorAll('.add-subitem-btn').forEach(btn => {
            btn.onclick = function() {
                const idx = this.dataset.index;
                if (!subItemsData[idx]) subItemsData[idx] = [];
                if (!specialNameFlags[idx]) specialNameFlags[idx] = [];
                subItemsData[idx].push('');
                specialNameFlags[idx].push(false);
                updateTextEditor();
            };
        });

        document.querySelectorAll('.special-name-btn').forEach(btn => {
            btn.onclick = function() {
                const m = this.dataset.main;
                const s = this.dataset.sub;
                specialNameFlags[m][s] = !specialNameFlags[m][s];
                updateTextEditor();
            }
        });
    }

    function updateLineGuide(textarea, limit) {
        const guide = textarea.nextElementSibling;
        const text = textarea.value;
        const lines = text.split('\n');
        let html = '';
        lines.forEach((line, idx) => {
            if (idx > 0) html += '\n';
            for (let i = 0; i < line.length; i++) {
                if (i === (limit - 1)) html += `<span class="guide-char">${line[i]}</span>`;
                else html += line[i];
            }
            if (line.length < limit) {
                for (let i = line.length; i < limit; i++) {
                    if (i === (limit - 1)) html += `<span class="guide-char" style="opacity:0.3">Â·</span>`;
                    else html += ' ';
                }
            }
        });
        guide.innerHTML = html;
        guide.scrollTop = textarea.scrollTop;
    }

    // --- é€»è¾‘ 4: æ–‡ä»¶å¤¹ç›´æ¥å†™å…¥ (æ ¸å¿ƒä¿®æ”¹) ---
    generateBtn.addEventListener('click', async () => {
        if (files.length === 0) return alert("æ²¡æœ‰æ–‡ä»¶ï¼");

        // 1. è¯·æ±‚æ–‡ä»¶å¤¹æƒé™ (åªå¼¹ä¸€æ¬¡)
        let dirHandle;
        try {
            dirHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
        } catch (err) {
            return; // ç”¨æˆ·å–æ¶ˆæˆ–ä¸æ”¯æŒ
        }

        progressBar.style.display = 'block';
        status.textContent = `æ­£åœ¨ä¿å­˜åˆ°: ${dirHandle.name}...`;
        
        let total = files.length + Object.values(subItemsData).reduce((a,b)=>a+b.length, 0);
        let count = 0;

        // 2. å¾ªç¯å†™å…¥
        for (let i = 0; i < files.length; i++) {
            const { canvas, number, fullName } = renderMainCanvas(i);
            let fName = number ? `${number}.0.png` : `${fullName}.png`;
            
            await saveToDir(dirHandle, fName, canvas);
            updateProgress(++count, total);

            if (subItemsData[i]) {
                for (let j = 0; j < subItemsData[i].length; j++) {
                    const { canvas: subCan, mainNumber } = renderSubCanvas(i, j);
                    const isSpec = specialNameFlags[i][j];
                    let sName = isSpec ? `${mainNumber}æœ€æœ€æœ€.png` : `${mainNumber}.${j+1}.png`;
                    
                    await saveToDir(dirHandle, sName, subCan);
                    updateProgress(++count, total);
                }
            }
        }
        
        status.textContent = "âœ… å…¨éƒ¨ä¿å­˜æˆåŠŸï¼";
        setTimeout(() => { progressBar.style.display = 'none'; status.textContent=""; }, 3000);
    });

    async function saveToDir(dirHandle, filename, canvas) {
        // Canvas è½¬ Blob
        const blob = await new Promise(resolve => canvas.toBlob(resolve));
        // è·å–æ–‡ä»¶å¥æŸ„ (å¦‚æœå­˜åœ¨åˆ™è¦†ç›–)
        const fileHandle = await dirHandle.getFileHandle(filename, { create: true });
        // åˆ›å»ºå†™å…¥æµ
        const writable = await fileHandle.createWritable();
        // å†™å…¥æ•°æ®
        await writable.write(blob);
        // å…³é—­æ–‡ä»¶
        await writable.close();
    }

    function updateProgress(curr, total) {
        progress.style.width = (curr / total * 100) + "%";
    }
});
</script>
</body>
</html>
